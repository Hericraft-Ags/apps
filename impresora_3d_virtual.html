<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Interactivo de Impresora 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .printer-bed {
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        .extruder {
            animation: printing 3s ease-in-out infinite;
        }
        
        @keyframes printing {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(30px); }
        }
        
        .filament-flow {
            animation: flow 1s linear infinite;
        }
        
        @keyframes flow {
            0% { opacity: 0; transform: translateY(0); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateY(10px); }
        }
        
        .progress-ring {
            transition: stroke-dasharray 0.3s ease;
        }
        
        .step-indicator {
            transition: all 0.3s ease;
        }
        
        .step-indicator.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            transform: scale(1.1);
        }

        .interactive-btn {
            transition: all 0.2s ease;
            transform: scale(1);
        }

        .interactive-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .interactive-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .temperature-indicator {
            transition: all 0.5s ease;
        }

        .heating {
            animation: pulse 1s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { opacity: 0.6; }
            to { opacity: 1; }
        }

        .extruder-movable {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .clickable-component {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-component:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .status-light {
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .printer-frame {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #1e293b 100%);
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.3),
                0 8px 32px rgba(0,0,0,0.4);
        }

        .extruder-enhanced {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .bed-enhanced {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fb923c 100%);
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.1),
                0 4px 16px rgba(251, 146, 60, 0.3);
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .neon-glow {
            box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor;
        }

        .control-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e1;
        }

        .status-panel {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #e2e8f0;
        }

        .temperature-slider {
            background: linear-gradient(to right, #3b82f6, #ef4444);
        }

        .movement-grid {
            background: radial-gradient(circle at center, #f1f5f9 0%, #e2e8f0 100%);
        }

        .printer-container {
            background: radial-gradient(ellipse at center, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip.show {
            opacity: 1;
        }

        .mode-switch {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        .quick-actions {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .emergency-stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: emergencyPulse 2s ease-in-out infinite;
        }

        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .print-progress {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.5s ease;
        }

        .layer-visualization {
            background: linear-gradient(to top, 
                rgba(59, 130, 246, 0.8) 0%, 
                rgba(59, 130, 246, 0.6) 25%,
                rgba(59, 130, 246, 0.4) 50%,
                rgba(59, 130, 246, 0.2) 75%,
                transparent 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-full">
    <!-- Notification System -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Filament Selection Modal -->
    <div id="filament-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-3xl">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold flex items-center gap-3">
                        üßµ Selecci√≥n de Filamento
                    </h2>
                    <button onclick="closeFilamentModal()" class="text-white hover:text-gray-300 text-2xl font-bold">
                        ‚úï
                    </button>
                </div>
                <p class="text-blue-100 mt-2">Elige el tipo de filamento para optimizar la configuraci√≥n de impresi√≥n</p>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <div class="grid gap-6">
                    <!-- PLA Filament Option -->
                    <div class="filament-option border-2 border-gray-200 rounded-2xl p-6 cursor-pointer hover:border-green-400 hover:shadow-xl transition-all duration-300" onclick="selectFilament('PLA')" data-filament="PLA">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-green-400 via-green-500 to-green-700 rounded-full border-4 border-green-300 shadow-xl flex items-center justify-center">
                                <span class="text-white font-bold text-lg">PLA</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">PLA (√Åcido Polil√°ctico)</h3>
                                <p class="text-gray-600">Filamento biodegradable, f√°cil de imprimir, ideal para principiantes</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Temperatura</div>
                                <div class="font-bold text-green-600">190-220¬∞C</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-green-50 p-3 rounded-lg">
                                <div class="font-bold text-green-800 mb-1">‚úÖ Ventajas</div>
                                <ul class="text-green-700 space-y-1">
                                    <li>‚Ä¢ F√°cil de imprimir</li>
                                    <li>‚Ä¢ Sin olores t√≥xicos</li>
                                    <li>‚Ä¢ Biodegradable</li>
                                    <li>‚Ä¢ Buena precisi√≥n</li>
                                </ul>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="font-bold text-gray-800 mb-1">üìä Especificaciones</div>
                                <ul class="text-gray-700 space-y-1">
                                    <li>‚Ä¢ Extrusor: 200¬∞C</li>
                                    <li>‚Ä¢ Cama: 60¬∞C</li>
                                    <li>‚Ä¢ Velocidad: 50-80mm/s</li>
                                    <li>‚Ä¢ Retracci√≥n: 4-6mm</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- ABS Filament Option -->
                    <div class="filament-option border-2 border-gray-200 rounded-2xl p-6 cursor-pointer hover:border-red-400 hover:shadow-xl transition-all duration-300" onclick="selectFilament('ABS')" data-filament="ABS">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-400 via-red-500 to-red-700 rounded-full border-4 border-red-300 shadow-xl flex items-center justify-center">
                                <span class="text-white font-bold text-lg">ABS</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">ABS (Acrilonitrilo Butadieno Estireno)</h3>
                                <p class="text-gray-600">Filamento resistente y duradero, ideal para piezas funcionales</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Temperatura</div>
                                <div class="font-bold text-red-600">230-260¬∞C</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-red-50 p-3 rounded-lg">
                                <div class="font-bold text-red-800 mb-1">üí™ Ventajas</div>
                                <ul class="text-red-700 space-y-1">
                                    <li>‚Ä¢ Alta resistencia</li>
                                    <li>‚Ä¢ Flexible y duradero</li>
                                    <li>‚Ä¢ Resistente al calor</li>
                                    <li>‚Ä¢ Post-procesable</li>
                                </ul>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="font-bold text-gray-800 mb-1">üìä Especificaciones</div>
                                <ul class="text-gray-700 space-y-1">
                                    <li>‚Ä¢ Extrusor: 240¬∞C</li>
                                    <li>‚Ä¢ Cama: 80¬∞C</li>
                                    <li>‚Ä¢ Velocidad: 40-60mm/s</li>
                                    <li>‚Ä¢ Retracci√≥n: 3-5mm</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- PETG Filament Option -->
                    <div class="filament-option border-2 border-gray-200 rounded-2xl p-6 cursor-pointer hover:border-purple-400 hover:shadow-xl transition-all duration-300" onclick="selectFilament('PETG')" data-filament="PETG">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-400 via-purple-500 to-purple-700 rounded-full border-4 border-purple-300 shadow-xl flex items-center justify-center">
                                <span class="text-white font-bold text-sm">PETG</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">PETG (Polietileno Tereftalato Glicol)</h3>
                                <p class="text-gray-600">Combina facilidad de PLA con resistencia de ABS, transparente</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Temperatura</div>
                                <div class="font-bold text-purple-600">220-250¬∞C</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-purple-50 p-3 rounded-lg">
                                <div class="font-bold text-purple-800 mb-1">üåü Ventajas</div>
                                <ul class="text-purple-700 space-y-1">
                                    <li>‚Ä¢ F√°cil de imprimir</li>
                                    <li>‚Ä¢ Transparente</li>
                                    <li>‚Ä¢ Resistente qu√≠mico</li>
                                    <li>‚Ä¢ Sin warping</li>
                                </ul>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="font-bold text-gray-800 mb-1">üìä Especificaciones</div>
                                <ul class="text-gray-700 space-y-1">
                                    <li>‚Ä¢ Extrusor: 230¬∞C</li>
                                    <li>‚Ä¢ Cama: 70¬∞C</li>
                                    <li>‚Ä¢ Velocidad: 45-70mm/s</li>
                                    <li>‚Ä¢ Retracci√≥n: 2-4mm</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Selection Display -->
                <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border-2 border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-bold text-gray-800 mb-1">Filamento Seleccionado Actualmente:</h4>
                            <div class="flex items-center gap-3">
                                <div id="current-filament-indicator" class="w-8 h-8 bg-gradient-to-br from-green-400 to-green-600 rounded-full border-2 border-green-300"></div>
                                <div>
                                    <div id="current-filament-name" class="font-bold text-lg text-gray-800">PLA</div>
                                    <div id="current-filament-temp" class="text-sm text-gray-600">Extrusor: 200¬∞C | Cama: 60¬∞C</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <button onclick="closeFilamentModal()" class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all duration-300 transform hover:scale-105">
                                ‚úÖ Confirmar Selecci√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LCD Interface Modal -->
    <div id="lcd-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-6 rounded-t-3xl">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold flex items-center gap-3">
                        üì± Interfaz LCD - Panel de Control Completo
                    </h2>
                    <button onclick="closeLCDInterface()" class="text-white hover:text-gray-300 text-2xl font-bold">
                        ‚úï
                    </button>
                </div>
                <p class="text-slate-300 mt-2">Control total de la impresora 3D desde la interfaz principal</p>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Temperature Controls Enhanced -->
                    <div class="control-panel rounded-2xl p-6 shadow-xl">
                        <h4 class="font-bold mb-4 text-orange-600 text-lg flex items-center gap-2">
                            üå°Ô∏è Control de Temperatura
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">Extrusor</label>
                                    <span class="bg-orange-100 px-3 py-1 rounded-full text-orange-800 font-bold">
                                        <span id="modal-extruder-temp">25</span>¬∞C
                                    </span>
                                </div>
                                <input type="range" id="modal-extruder-temp-slider" min="25" max="300" value="25" 
                                       class="w-full h-3 temperature-slider rounded-lg appearance-none cursor-pointer shadow-inner"
                                       oninput="updateTemperature('extruder', this.value); syncModalTemperatures()">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>25¬∞C</span>
                                    <span>300¬∞C</span>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">Cama</label>
                                    <span class="bg-red-100 px-3 py-1 rounded-full text-red-800 font-bold">
                                        <span id="modal-bed-temp">25</span>¬∞C
                                    </span>
                                </div>
                                <input type="range" id="modal-bed-temp-slider" min="25" max="120" value="25" 
                                       class="w-full h-3 temperature-slider rounded-lg appearance-none cursor-pointer shadow-inner"
                                       oninput="updateTemperature('bed', this.value); syncModalTemperatures()">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>25¬∞C</span>
                                    <span>120¬∞C</span>
                                </div>
                            </div>
                            <div class="pt-4 border-t">
                                <h5 class="font-bold text-gray-700 mb-3">Presets R√°pidos</h5>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="presetPLA(); syncModalTemperatures()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-bold">
                                        PLA
                                    </button>
                                    <button onclick="presetABS(); syncModalTemperatures()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-bold">
                                        ABS
                                    </button>
                                    <button onclick="coolDown(); syncModalTemperatures()" class="bg-cyan-500 hover:bg-cyan-600 text-white px-3 py-2 rounded-lg text-sm font-bold col-span-2">
                                        ‚ùÑÔ∏è Enfriar Todo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Movement Controls Enhanced -->
                    <div class="control-panel rounded-2xl p-6 shadow-xl">
                        <h4 class="font-bold mb-4 text-blue-600 text-lg flex items-center gap-2">
                            üéØ Control de Movimiento
                        </h4>
                        <div class="movement-grid rounded-xl p-4 mb-4">
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <div></div>
                                <button onclick="moveExtruder('y', 10)" class="interactive-btn bg-blue-500 hover:bg-blue-600 p-3 rounded-xl text-white font-bold shadow-lg">
                                    ‚Üë
                                </button>
                                <div></div>
                                <button onclick="moveExtruder('x', -10)" class="interactive-btn bg-blue-500 hover:bg-blue-600 p-3 rounded-xl text-white font-bold shadow-lg">
                                    ‚Üê
                                </button>
                                <button onclick="homeExtruder()" class="interactive-btn bg-green-500 hover:bg-green-600 p-3 rounded-xl text-white font-bold shadow-lg">
                                    üè†
                                </button>
                                <button onclick="moveExtruder('x', 10)" class="interactive-btn bg-blue-500 hover:bg-blue-600 p-3 rounded-xl text-white font-bold shadow-lg">
                                    ‚Üí
                                </button>
                                <div></div>
                                <button onclick="moveExtruder('y', -10)" class="interactive-btn bg-blue-500 hover:bg-blue-600 p-3 rounded-xl text-white font-bold shadow-lg">
                                    ‚Üì
                                </button>
                                <div></div>
                            </div>
                            <div class="flex gap-3 mb-4">
                                <button onclick="moveExtruder('z', 5)" class="interactive-btn flex-1 bg-purple-500 hover:bg-purple-600 p-3 rounded-xl text-white font-bold shadow-lg">
                                    Z‚Üë
                                </button>
                                <button onclick="moveExtruder('z', -5)" class="interactive-btn flex-1 bg-purple-500 hover:bg-purple-600 p-3 rounded-xl text-white font-bold shadow-lg">
                                    Z‚Üì
                                </button>
                            </div>
                            <div class="text-xs text-gray-600 text-center mb-3">
                                Incremento: 10mm (XY), 5mm (Z)
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setMoveIncrement(1)" class="bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs font-bold">
                                    1mm
                                </button>
                                <button onclick="setMoveIncrement(10)" class="bg-blue-200 hover:bg-blue-300 px-2 py-1 rounded text-xs font-bold">
                                    10mm
                                </button>
                                <button onclick="setMoveIncrement(50)" class="bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs font-bold">
                                    50mm
                                </button>
                            </div>
                        </div>
                        <div class="bg-slate-100 rounded-lg p-3">
                            <div class="text-xs text-gray-600 mb-2">Posici√≥n Actual:</div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div class="text-center">
                                    <div class="font-bold text-blue-600">X</div>
                                    <div id="modal-pos-x">0mm</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-green-600">Y</div>
                                    <div id="modal-pos-y">0mm</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-purple-600">Z</div>
                                    <div id="modal-pos-z">0mm</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Enhanced -->
                    <div class="control-panel rounded-2xl p-6 shadow-xl">
                        <h4 class="font-bold mb-4 text-green-600 text-lg flex items-center gap-2">
                            ‚ö° Acciones Principales
                        </h4>
                        <div class="space-y-3">
                            <button onclick="togglePower()" id="modal-power-btn" class="interactive-btn w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all">
                                üîå Encender
                            </button>
                            <button onclick="loadFilament()" id="modal-filament-btn" class="interactive-btn w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üßµ Cargar Filamento
                            </button>
                            <button onclick="unloadFilament()" id="modal-unload-btn" class="interactive-btn w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üîÑ Descargar Filamento
                            </button>
                            <button onclick="showConfigurationValidation()" id="modal-validate-btn" class="interactive-btn w-full bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                ‚úÖ Validar Configuraci√≥n
                            </button>
                            <button onclick="autoLevel()" id="modal-level-btn" class="interactive-btn w-full bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üìê Auto Nivelaci√≥n
                            </button>
                            <button onclick="startPrint()" id="modal-print-btn" class="interactive-btn w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üñ®Ô∏è Iniciar Impresi√≥n
                            </button>
                            <button onclick="pausePrint()" id="modal-pause-btn" class="interactive-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-xl font-bold shadow-lg disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                ‚è∏Ô∏è Pausar
                            </button>
                        </div>
                        
                        <!-- PASO 4: Funciones Avanzadas de Monitoreo -->
                        <div class="mt-6 pt-4 border-t">
                            <h5 class="font-bold text-gray-700 mb-3">üî¨ Monitoreo Avanzado</h5>
                            <div class="space-y-3">
                                <button onclick="autoOptimizePrintSettings()" id="modal-optimize-btn" class="interactive-btn w-full bg-indigo-500 hover:bg-indigo-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                    üéØ Optimizar Autom√°tico
                                </button>
                                <button onclick="autoCalibrateMechanics()" id="modal-calibrate-btn" class="interactive-btn w-full bg-teal-500 hover:bg-teal-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                    ‚öôÔ∏è Calibraci√≥n Mec√°nica
                                </button>
                                <button onclick="performMaintenanceCheck()" id="modal-maintenance-btn" class="interactive-btn w-full bg-amber-500 hover:bg-amber-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                    üîß Verificar Mantenimiento
                                </button>
                                <button onclick="generatePrintReport()" id="modal-report-btn" class="interactive-btn w-full bg-cyan-500 hover:bg-cyan-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                    üìä Generar Reporte
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t">
                            <h5 class="font-bold text-gray-700 mb-3">Estado del Sistema</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Estado:</span>
                                    <span id="modal-printer-status" class="font-bold text-red-500">Apagada</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Filamento:</span>
                                    <span id="modal-filament-status" class="font-bold text-gray-500">No cargado</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Nivelaci√≥n:</span>
                                    <span id="modal-level-status" class="font-bold text-gray-500">Pendiente</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emergency Stop -->
                <div class="mt-6 text-center">
                    <button onclick="emergencyStop()" class="emergency-stop px-8 py-4 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all text-lg">
                        üõë PARADA DE EMERGENCIA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-4">
                üñ®Ô∏è Simulador Interactivo de Impresora 3D
            </h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                Experimenta con una impresora 3D virtual de √∫ltima generaci√≥n. Controla cada aspecto del proceso de impresi√≥n.
            </p>
        </header>

        <!-- Mode Selector Enhanced -->
        <div class="flex justify-center mb-8">
            <div class="mode-switch rounded-2xl shadow-2xl p-2 flex space-x-2">
                <button id="guided-mode" onclick="setMode('guided')" class="px-8 py-4 rounded-xl font-bold text-white bg-white bg-opacity-20 backdrop-blur-sm transition-all duration-300 shadow-lg">
                    üìã Modo Guiado
                </button>
                <button id="manual-mode" onclick="setMode('manual')" class="px-8 py-4 rounded-xl font-bold text-white hover:bg-white hover:bg-opacity-10 transition-all duration-300">
                    üéÆ Modo Manual
                </button>
            </div>
        </div>

        <!-- Main Simulator Container -->
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
            
            <!-- Progress Bar (Guided Mode) -->
            <div id="progress-section" class="bg-gradient-to-r from-blue-500 to-purple-600 p-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-bold text-white">Progreso del Proceso</span>
                    <span id="progress-text" class="text-white bg-white bg-opacity-20 px-4 py-2 rounded-full">0% completado</span>
                </div>
                <div class="w-full bg-white bg-opacity-20 rounded-full h-4 shadow-inner">
                    <div id="progress-bar" class="print-progress h-4 rounded-full shadow-lg" style="width: 0%"></div>
                </div>
            </div>

            <!-- Enhanced Step Indicators (Guided Mode) -->
            <div id="step-indicators" class="flex justify-between p-6 bg-gradient-to-br from-gray-50 to-blue-50">
                <div class="step-indicator active flex flex-col items-center p-4 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-xl transform scale-110 cursor-pointer hover:scale-115 transition-all duration-300" onclick="goToStep(1)">
                    <div class="w-12 h-12 rounded-full bg-white text-blue-500 flex items-center justify-center font-bold mb-3 shadow-lg">
                        <span class="step-number">1</span>
                        <span class="step-check hidden">‚úì</span>
                    </div>
                    <span class="text-sm text-center font-bold">Preparaci√≥n</span>
                    <div class="text-xs text-center mt-1 opacity-80">Encender impresora</div>
                </div>
                <div class="step-indicator flex flex-col items-center p-4 rounded-xl bg-gray-200 text-gray-600 shadow-lg cursor-pointer hover:scale-105 transition-all duration-300" onclick="goToStep(2)">
                    <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center font-bold mb-3">
                        <span class="step-number">2</span>
                        <span class="step-check hidden">‚úì</span>
                    </div>
                    <span class="text-sm text-center">Carga Filamento</span>
                    <div class="text-xs text-center mt-1 opacity-70">Calentar y cargar</div>
                </div>
                <div class="step-indicator flex flex-col items-center p-4 rounded-xl bg-gray-200 text-gray-600 shadow-lg cursor-pointer hover:scale-105 transition-all duration-300" onclick="goToStep(3)">
                    <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center font-bold mb-3">
                        <span class="step-number">3</span>
                        <span class="step-check hidden">‚úì</span>
                    </div>
                    <span class="text-sm text-center">Nivelaci√≥n</span>
                    <div class="text-xs text-center mt-1 opacity-70">Auto-calibrar cama</div>
                </div>
                <div class="step-indicator flex flex-col items-center p-4 rounded-xl bg-gray-200 text-gray-600 shadow-lg cursor-pointer hover:scale-105 transition-all duration-300" onclick="goToStep(4)">
                    <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center font-bold mb-3">
                        <span class="step-number">4</span>
                        <span class="step-check hidden">‚úì</span>
                    </div>
                    <span class="text-sm text-center">Impresi√≥n</span>
                    <div class="text-xs text-center mt-1 opacity-70">Iniciar proceso</div>
                </div>
            </div>

            <!-- Interactive Step Content Panel (Guided Mode) -->
            <div id="guided-step-panel" class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 border-b-2 border-blue-200">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-xl p-6 border-2 border-blue-200">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg">
                                    <span id="current-step-number">1</span>
                                </div>
                                <div>
                                    <h3 id="step-title" class="text-2xl font-bold text-gray-800">Preparaci√≥n inicial</h3>
                                    <p id="step-description" class="text-gray-600">Verifica que la impresora est√© conectada y enci√©ndela</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Paso <span id="step-counter">1</span> de 4</div>
                                <div class="text-lg font-bold text-blue-600"><span id="step-progress-percent">0</span>% completado</div>
                            </div>
                        </div>

                        <!-- Interactive Checklist -->
                        <div id="step-checklist" class="space-y-4 mb-6">
                            <!-- Dynamic content will be inserted here -->
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-4 pt-6 border-t border-gray-200">
                            <button id="step-action-btn" onclick="executeStepAction()" class="interactive-btn flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-4 rounded-xl font-bold shadow-lg transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                üîå Encender Impresora
                            </button>
                            <button id="prev-btn" onclick="previousStep()" class="interactive-btn px-6 py-4 bg-gray-300 text-gray-600 rounded-xl cursor-not-allowed flex items-center gap-2 shadow-lg" disabled>
                                ‚Üê Anterior
                            </button>
                            <button id="next-btn" onclick="nextStep()" class="interactive-btn px-6 py-4 bg-gray-400 text-gray-600 rounded-xl cursor-not-allowed flex items-center gap-2 shadow-lg" disabled>
                                Siguiente ‚Üí
                            </button>
                        </div>

                        <!-- Step Tips -->
                        <div id="step-tips" class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                            <div class="flex items-start gap-3">
                                <span class="text-blue-500 text-xl">üí°</span>
                                <div>
                                    <h4 class="font-bold text-blue-800 mb-2">Consejos para este paso:</h4>
                                    <ul id="step-tips-list" class="text-blue-700 text-sm space-y-1">
                                        <!-- Dynamic tips will be inserted here -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Controls (Manual Mode) - Enhanced Version -->
            <div id="manual-controls" class="hidden p-6 bg-gradient-to-br from-gray-50 to-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                        üéÆ Controles Manuales
                    </h3>
                    <button onclick="emergencyStop()" class="emergency-stop px-6 py-3 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all">
                        üõë PARADA DE EMERGENCIA
                    </button>
                </div>
                
                <div class="text-center bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-blue-800 font-medium mb-2">üí° <strong>Modo Manual Activado</strong></p>
                    <p class="text-blue-600 text-sm">Haz clic en la <strong>Pantalla LCD</strong> de la impresora para acceder a todos los controles avanzados</p>
                </div>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Main Actions Panel -->
                    <div class="control-panel rounded-2xl p-6 shadow-xl">
                        <h4 class="font-bold mb-4 text-green-600 text-lg flex items-center gap-2">
                            ‚ö° Acciones Principales
                        </h4>
                        <div class="space-y-3">
                            <button onclick="togglePower()" id="power-btn" class="interactive-btn w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all">
                                üîå Encender
                            </button>
                            <button onclick="loadFilament()" id="filament-btn" class="interactive-btn w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üßµ Cargar Filamento
                            </button>
                            <button onclick="unloadFilament()" id="unload-btn" class="interactive-btn w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üîÑ Descargar Filamento
                            </button>
                            <button onclick="showConfigurationValidation()" id="validate-btn" class="interactive-btn w-full bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                ‚úÖ Validar Configuraci√≥n
                            </button>
                            <button onclick="autoLevel()" id="level-btn" class="interactive-btn w-full bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üìê Auto Nivelaci√≥n
                            </button>
                            <button onclick="startPrint()" id="print-btn" class="interactive-btn w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üñ®Ô∏è Iniciar Impresi√≥n
                            </button>
                            <button onclick="pausePrint()" id="pause-btn" class="interactive-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-xl font-bold shadow-lg disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                ‚è∏Ô∏è Pausar
                            </button>
                        </div>
                        
                        <!-- PASO 4: Funciones Avanzadas -->
                        <div class="mt-6 pt-4 border-t space-y-2">
                            <h5 class="font-bold text-gray-700 mb-3">üî¨ Funciones Avanzadas</h5>
                            <button onclick="autoOptimizePrintSettings()" id="optimize-btn" class="interactive-btn w-full bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-lg text-sm font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üéØ Optimizar Autom√°tico
                            </button>
                            <button onclick="autoCalibrateMechanics()" id="calibrate-btn" class="interactive-btn w-full bg-teal-500 hover:bg-teal-600 text-white p-2 rounded-lg text-sm font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                ‚öôÔ∏è Calibraci√≥n Mec√°nica
                            </button>
                            <button onclick="performMaintenanceCheck()" id="maintenance-btn" class="interactive-btn w-full bg-amber-500 hover:bg-amber-600 text-white p-2 rounded-lg text-sm font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üîß Verificar Mantenimiento
                            </button>
                            <button onclick="generatePrintReport()" id="report-btn" class="interactive-btn w-full bg-cyan-500 hover:bg-cyan-600 text-white p-2 rounded-lg text-sm font-bold shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                üìä Generar Reporte
                            </button>
                        </div>
                    </div>

                    <!-- Temperature Controls -->
                    <div class="control-panel rounded-2xl p-6 shadow-xl">
                        <h4 class="font-bold mb-4 text-orange-600 text-lg flex items-center gap-2">
                            üå°Ô∏è Control de Temperatura
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Temperatura Extrusor</label>
                                <input type="range" id="extruder-temp-slider" min="25" max="300" value="25" 
                                       class="w-full h-2 temperature-slider rounded-lg appearance-none cursor-pointer"
                                       oninput="updateTemperature('extruder', this.value)">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>25¬∞C</span>
                                    <span id="extruder-temp" class="font-bold">25¬∞C</span>
                                    <span>300¬∞C</span>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Temperatura Cama</label>
                                <input type="range" id="bed-temp-slider" min="25" max="120" value="25" 
                                       class="w-full h-2 temperature-slider rounded-lg appearance-none cursor-pointer"
                                       oninput="updateTemperature('bed', this.value)">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>25¬∞C</span>
                                    <span id="bed-temp" class="font-bold">25¬∞C</span>
                                    <span>120¬∞C</span>
                                </div>
                            </div>
                            <div class="pt-3 border-t space-y-2">
                                <button onclick="presetPLA()" class="interactive-btn w-full quick-actions text-white p-2 rounded-lg text-sm font-bold shadow-lg">
                                    üî• PLA (200¬∞C/60¬∞C)
                                </button>
                                <button onclick="presetABS()" class="interactive-btn w-full bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg text-sm font-bold shadow-lg">
                                    üî• ABS (240¬∞C/80¬∞C)
                                </button>
                                <button onclick="coolDown()" class="interactive-btn w-full bg-cyan-500 hover:bg-cyan-600 text-white p-2 rounded-lg text-sm font-bold shadow-lg">
                                    ‚ùÑÔ∏è Enfriar Todo
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Status Overview -->
                    <div class="control-panel rounded-2xl p-6 shadow-xl">
                        <h4 class="font-bold mb-4 text-blue-600 text-lg flex items-center gap-2">
                            üìä Estado del Sistema
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700 font-medium">Estado:</span>
                                <span id="quick-status" class="font-bold text-red-500">Apagada</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700 font-medium">Extrusor:</span>
                                <span id="quick-extruder-temp" class="font-bold text-orange-600">25¬∞C</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700 font-medium">Cama:</span>
                                <span id="quick-bed-temp" class="font-bold text-red-600">25¬∞C</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700 font-medium">Filamento:</span>
                                <span id="quick-filament-status" class="font-bold text-gray-500">No cargado</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700 font-medium">Nivelaci√≥n:</span>
                                <span id="quick-level-status" class="font-bold text-gray-500">Pendiente</span>
                            </div>
                            <button onclick="openLCDInterface()" class="interactive-btn w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl font-bold shadow-lg mt-4">
                                üì± Abrir Panel LCD Completo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Printer Visualization - ULTRA ENHANCED -->
            <div id="printer-visualization-container" class="flex flex-col xl:flex-row gap-8 p-6">
                <div id="printer-main-container" class="xl:w-2/3">
                    <div class="printer-container rounded-3xl p-8 h-[600px] relative overflow-hidden shadow-2xl border-2 border-gray-200">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-4">
                                <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                                    <span class="text-3xl">üñ®Ô∏è</span>
                                    Prusa i3 MK3S+ Professional
                                </h3>
                            </div>
                            
                            <!-- Enhanced View Selector - Fixed positioning -->
                            <div class="absolute top-4 right-4 z-10 flex items-center gap-3 bg-white rounded-2xl p-2 shadow-xl border-2 border-gray-200">
                                <span class="text-sm font-medium text-gray-600">Vista:</span>
                                <div class="flex bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-1">
                                    <button id="front-view-btn" onclick="switchView('front')" 
                                            onmouseenter="showTooltip(event, 'Vista frontal: Muestra los componentes principales de impresi√≥n como extrusor, cama y pantalla LCD')" 
                                            onmouseleave="hideTooltip()"
                                            class="px-4 py-2 rounded-lg font-bold text-white bg-gradient-to-r from-blue-500 to-blue-600 shadow-md transition-all duration-300 transform hover:scale-105 text-sm">
                                        üëÅÔ∏è Frontal
                                    </button>
                                    <button id="rear-view-btn" onclick="switchView('rear')" 
                                            onmouseenter="showTooltip(event, 'Vista trasera: Muestra la electr√≥nica, carrete de filamento y sistema de alimentaci√≥n')" 
                                            onmouseleave="hideTooltip()"
                                            class="px-4 py-2 rounded-lg font-bold text-gray-700 hover:bg-white hover:shadow-md transition-all duration-300 transform hover:scale-105 text-sm">
                                        üîÑ Trasera
                                    </button>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div id="connection-status" class="flex items-center gap-3 bg-white px-4 py-2 rounded-full shadow-lg glass-effect">
                                    <div id="connection-light" class="w-4 h-4 bg-red-400 rounded-full shadow-inner neon-glow"></div>
                                    <span id="connection-text" class="text-gray-700 font-bold">Desconectada</span>
                                </div>
                                <div id="print-status" class="bg-white px-4 py-2 rounded-full shadow-lg glass-effect">
                                    <span class="text-gray-700 font-bold">Inactiva</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Front View -->
                        <div id="front-view" class="absolute inset-6 printer-frame rounded-3xl shadow-2xl border-4 border-slate-600 overflow-hidden">
                            
                            <!-- Top Frame with Enhanced Logo -->
                            <div class="absolute top-0 left-0 right-0 h-10 bg-gradient-to-r from-slate-600 via-slate-500 to-slate-600 flex items-center justify-center">
                                <div class="text-sm font-bold text-white opacity-90 tracking-widest flex items-center gap-2">
                                    <span class="w-2 h-2 bg-orange-400 rounded-full animate-pulse"></span>
                                    PRUSA i3 MK3S+
                                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                                </div>
                            </div>
                            
                            <!-- Enhanced Base Platform -->
                            <div class="absolute bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-slate-900 via-slate-800 to-slate-700 rounded-b-3xl">
                                <!-- Ventilation and details -->
                                <div class="absolute bottom-3 left-6 right-6 h-4 bg-slate-900 rounded-lg flex items-center justify-center">
                                    <div class="flex gap-2">
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                    </div>
                                </div>
                                <!-- Power supply indicator -->
                                <div class="absolute bottom-8 right-6 w-6 h-4 bg-slate-800 rounded border border-slate-600">
                                    <div id="psu-indicator" class="w-2 h-2 bg-red-500 rounded-full mt-1 ml-1 opacity-0 transition-all"></div>
                                </div>
                            </div>
                            
                            <!-- Print Bed - Ultra Enhanced -->
                            <div class="printer-bed clickable-component bed-enhanced absolute bottom-10 left-10 right-10 h-20 rounded-2xl border-4 border-orange-300 shadow-2xl transform hover:scale-[1.01] transition-all duration-300" onclick="clickComponent('bed')" onmouseenter="showTooltip(event, 'Cama de impresi√≥n calefactada - Superficie donde se construye el objeto')" onmouseleave="hideTooltip()">
                                <!-- Enhanced heating indicator -->
                                <div id="bed-heat-indicator" class="temperature-indicator absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-br from-red-400 to-red-600 rounded-full opacity-0 transition-all duration-500 shadow-xl neon-glow">
                                    <div class="absolute inset-1 bg-red-300 rounded-full animate-pulse"></div>
                                    <div class="absolute inset-2 bg-red-200 rounded-full"></div>
                                </div>
                                
                                <!-- Bed surface with enhanced texture -->
                                <div class="absolute inset-3 opacity-50">
                                    <div class="grid grid-cols-16 grid-rows-10 h-full w-full gap-px">
                                        <!-- Grid pattern for bed texture -->
                                    </div>
                                </div>
                                
                                <!-- Enhanced bed clips -->
                                <div class="absolute -top-2 left-3 w-3 h-3 bg-slate-700 rounded-md shadow-lg border border-slate-500"></div>
                                <div class="absolute -top-2 right-3 w-3 h-3 bg-slate-700 rounded-md shadow-lg border border-slate-500"></div>
                                <div class="absolute -bottom-2 left-3 w-3 h-3 bg-slate-700 rounded-md shadow-lg border border-slate-500"></div>
                                <div class="absolute -bottom-2 right-3 w-3 h-3 bg-slate-700 rounded-md shadow-lg border border-slate-500"></div>
                                
                                <!-- Bed temperature display -->
                                <div class="absolute top-2 left-2 text-xs font-bold text-orange-800 bg-white bg-opacity-80 px-2 py-1 rounded">
                                    <span id="bed-temp-display">25¬∞C</span>
                                </div>
                            </div>
                            
                            <!-- Enhanced X-axis Rail System -->
                            <div class="absolute top-20 left-6 right-6 h-6 bg-gradient-to-r from-slate-500 via-slate-400 to-slate-500 rounded-full shadow-xl">
                                <div class="absolute inset-1 bg-gradient-to-r from-slate-300 to-slate-400 rounded-full"></div>
                                <div class="absolute top-1/2 left-0 right-0 h-px bg-slate-600 transform -translate-y-1/2"></div>
                                
                                <!-- Enhanced X-axis carriage -->
                                <div id="x-carriage" class="extruder-movable absolute -top-2 left-8 w-16 h-10 bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 rounded-xl shadow-2xl border-2 border-blue-400">
                                    <div class="absolute inset-1 bg-gradient-to-br from-blue-300 to-blue-400 rounded-lg opacity-60"></div>
                                    <!-- Carriage details -->
                                    <div class="absolute -top-1 left-2 w-3 h-3 bg-slate-700 rounded-full shadow-md"></div>
                                    <div class="absolute -top-1 right-2 w-3 h-3 bg-slate-700 rounded-full shadow-md"></div>
                                    <div class="absolute -bottom-1 left-2 w-3 h-3 bg-slate-700 rounded-full shadow-md"></div>
                                    <div class="absolute -bottom-1 right-2 w-3 h-3 bg-slate-700 rounded-full shadow-md"></div>
                                </div>
                            </div>
                            
                            <!-- Extruder Assembly - Ultra Premium Design -->
                            <div id="extruder" class="extruder-movable clickable-component extruder-enhanced absolute top-12 left-12 transform hover:scale-110 transition-all duration-300" onclick="clickComponent('extruder')" onmouseenter="showTooltip(event, 'Extrusor - Calienta y deposita el filamento fundido con precisi√≥n microm√©trica')" onmouseleave="hideTooltip()">
                                <!-- Main extruder body with enhanced design -->
                                <div class="w-16 h-16 bg-gradient-to-br from-orange-400 via-orange-500 to-orange-700 rounded-2xl shadow-2xl relative border-2 border-orange-300">
                                    <div class="absolute inset-2 bg-gradient-to-br from-orange-200 to-orange-300 rounded-xl opacity-40"></div>
                                    
                                    <!-- Enhanced extruder details -->
                                    <div class="absolute top-2 left-2 w-3 h-3 bg-slate-700 rounded-md shadow-inner border border-slate-600"></div>
                                    <div class="absolute top-2 right-2 w-3 h-3 bg-slate-700 rounded-md shadow-inner border border-slate-600"></div>
                                    
                                    <!-- Enhanced nozzle -->
                                    <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 w-4 h-6 bg-gradient-to-b from-yellow-500 via-yellow-600 to-yellow-800 rounded-b-full shadow-xl border-2 border-yellow-400">
                                        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-yellow-900 rounded-full"></div>
                                        <div class="absolute top-1 left-1/2 transform -translate-x-1/2 w-1 h-1 bg-yellow-300 rounded-full"></div>
                                    </div>
                                    
                                    <!-- Enhanced heat indicator -->
                                    <div id="extruder-heat-indicator" class="temperature-indicator absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-br from-red-400 to-red-600 rounded-full opacity-0 transition-all duration-500 shadow-xl neon-glow">
                                        <div class="absolute inset-1 bg-red-300 rounded-full animate-pulse"></div>
                                        <div class="absolute inset-2 bg-red-200 rounded-full"></div>
                                    </div>
                                    
                                    <!-- Enhanced cooling fan -->
                                    <div class="absolute -right-4 top-2 w-8 h-8 bg-gradient-to-br from-slate-800 to-black rounded-full shadow-xl border-2 border-slate-600">
                                        <div id="fan-blade" class="w-full h-full bg-gradient-to-br from-slate-300 to-slate-400 rounded-full relative" style="animation: none;">
                                            <div class="absolute inset-1 bg-slate-600 rounded-full">
                                                <div class="absolute top-0 left-1/2 w-px h-3 bg-slate-400 transform -translate-x-1/2"></div>
                                                <div class="absolute bottom-0 left-1/2 w-px h-3 bg-slate-400 transform -translate-x-1/2"></div>
                                                <div class="absolute left-0 top-1/2 w-3 h-px bg-slate-400 transform -translate-y-1/2"></div>
                                                <div class="absolute right-0 top-1/2 w-3 h-px bg-slate-400 transform -translate-y-1/2"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Enhanced filament guide -->
                                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-3 h-4 bg-gradient-to-b from-slate-600 to-slate-700 rounded-t-full shadow-lg border border-slate-500"></div>
                                    
                                    <!-- Extruder temperature display -->
                                    <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-orange-800 bg-white bg-opacity-90 px-2 py-1 rounded whitespace-nowrap">
                                        <span id="extruder-temp-display">25¬∞C</span>
                                    </div>
                                </div>
                                
                                <!-- Enhanced filament being extruded -->
                                <div id="filament-extrusion" class="filament-flow absolute top-16 left-6 w-4 h-8 bg-gradient-to-b from-blue-400 via-blue-500 to-transparent rounded-full opacity-0 shadow-xl layer-visualization">
                                    <div class="absolute inset-0 bg-gradient-to-b from-blue-300 to-transparent rounded-full animate-pulse"></div>
                                </div>
                            </div>
                            
                            <!-- Enhanced Z-axis Lead Screws -->
                            <div class="absolute left-3 top-12 bottom-32 w-4 bg-gradient-to-b from-slate-400 via-slate-500 to-slate-600 rounded-full shadow-xl">
                                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-slate-300 to-transparent opacity-60 rounded-full"></div>
                                <!-- Thread pattern -->
                                <div class="absolute top-3 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                <div class="absolute top-12 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                <div class="absolute top-21 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                            </div>
                            <div class="absolute right-3 top-12 bottom-32 w-4 bg-gradient-to-b from-slate-400 via-slate-500 to-slate-600 rounded-full shadow-xl">
                                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-slate-300 to-transparent opacity-60 rounded-full"></div>
                                <div class="absolute top-3 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                <div class="absolute top-12 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                <div class="absolute top-21 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                            </div>
                            
                            <!-- Enhanced Y-axis Rails -->
                            <div class="absolute bottom-32 left-6 right-6 h-4 bg-gradient-to-r from-slate-500 via-slate-400 to-slate-500 rounded-full shadow-lg">
                                <div class="absolute inset-1 bg-gradient-to-r from-slate-300 to-slate-400 rounded-full"></div>
                            </div>
                            
                            <!-- Enhanced Print Object -->
                            <div id="print-object" class="absolute bottom-28 left-1/2 transform -translate-x-1/2 w-12 h-0 bg-gradient-to-t from-blue-600 via-blue-500 to-blue-400 rounded-t-xl transition-all duration-2000 opacity-0 shadow-2xl layer-visualization">
                                <div class="absolute inset-0 bg-gradient-to-t from-blue-700 via-transparent to-transparent opacity-40 rounded-t-xl"></div>
                                <div class="absolute inset-1 bg-gradient-to-t from-blue-500 to-blue-300 rounded-t-xl opacity-60"></div>
                            </div>
                            
                            <!-- Enhanced LCD Screen -->
                            <div class="clickable-component absolute top-6 left-6 w-24 h-16 bg-gradient-to-br from-slate-900 via-slate-800 to-black rounded-xl border-2 border-slate-600 shadow-2xl transform hover:scale-105 transition-all duration-300" onclick="openLCDInterface()" onmouseenter="showTooltip(event, 'Pantalla LCD - Haz clic para abrir la interfaz de control completa')" onmouseleave="hideTooltip()">
                                <div class="absolute inset-1 bg-gradient-to-br from-slate-700 to-slate-800 rounded-lg">
                                    <div class="absolute inset-1 bg-gradient-to-br from-blue-900 to-slate-900 rounded">
                                        <div id="lcd-content" class="text-xs text-green-400 p-2 font-mono leading-tight h-full flex flex-col justify-center">
                                            <div class="text-center font-bold">Printer Ready</div>
                                            <div class="text-green-300 text-center">Temp: 25¬∞C</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Enhanced control knob -->
                                <div class="absolute -right-3 top-1/2 transform -translate-y-1/2 w-6 h-6 bg-gradient-to-br from-slate-600 to-slate-700 rounded-full shadow-xl border-2 border-slate-500">
                                    <div class="absolute inset-1 bg-slate-500 rounded-full">
                                        <div class="absolute top-0 left-1/2 w-px h-2 bg-slate-300 transform -translate-x-1/2"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Enhanced filament path -->
                            <div id="filament-path" class="absolute top-8 left-1/2 transform -translate-x-1/2 w-2 h-8 bg-gradient-to-b from-blue-400 to-blue-600 opacity-0 transition-all duration-500 rounded-full shadow-lg neon-glow">
                                <div class="absolute inset-0 bg-blue-300 rounded-full animate-pulse"></div>
                            </div>
                            
                            <!-- Enhanced ambient lighting effects -->
                            <div class="absolute inset-0 bg-gradient-to-t from-transparent via-transparent to-blue-500 opacity-5 rounded-3xl pointer-events-none"></div>
                            <div class="absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t from-blue-600 to-transparent opacity-10 rounded-b-3xl pointer-events-none"></div>
                        </div>

                        <!-- Rear View -->
                        <div id="rear-view" class="absolute inset-6 printer-frame rounded-3xl shadow-2xl border-4 border-slate-600 overflow-hidden hidden">
                            
                            <!-- Top Frame with Enhanced Logo -->
                            <div class="absolute top-0 left-0 right-0 h-10 bg-gradient-to-r from-slate-600 via-slate-500 to-slate-600 flex items-center justify-center">
                                <div class="text-sm font-bold text-white opacity-90 tracking-widest flex items-center gap-2">
                                    <span class="w-2 h-2 bg-orange-400 rounded-full animate-pulse"></span>
                                    PRUSA i3 MK3S+ - REAR VIEW
                                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                                </div>
                            </div>
                            
                            <!-- Enhanced Base Platform -->
                            <div class="absolute bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-slate-900 via-slate-800 to-slate-700 rounded-b-3xl">
                                <!-- Ventilation and details -->
                                <div class="absolute bottom-3 left-6 right-6 h-4 bg-slate-900 rounded-lg flex items-center justify-center">
                                    <div class="flex gap-2">
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                        <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Control Box - Full Width -->
                            <div class="clickable-component absolute bottom-6 left-6 right-6 h-20 bg-gradient-to-br from-slate-900 via-slate-800 to-black rounded-xl shadow-2xl border-2 border-slate-600 transform hover:scale-[1.02] transition-all duration-300" onclick="clickComponent('control')" onmouseenter="showTooltip(event, 'Caja de control principal - Electr√≥nica y procesador de 32-bit')" onmouseleave="hideTooltip()">
                                <div class="absolute inset-1 bg-gradient-to-br from-slate-700 to-slate-800 rounded-lg"></div>
                                
                                <!-- Control Box Label -->
                                <div class="absolute -top-6 left-0 bg-slate-800 text-white px-3 py-1 rounded-t-lg text-xs font-bold border-2 border-slate-600 border-b-0">
                                    üìã CAJA DE CONTROL
                                </div>
                                
                                <!-- Enhanced LEDs -->
                                <div id="power-led" class="status-light absolute top-3 left-6 w-4 h-4 bg-green-400 rounded-full opacity-0 transition-all duration-500 shadow-lg neon-glow">
                                    <div class="absolute inset-0.5 bg-green-300 rounded-full animate-pulse"></div>
                                </div>
                                <div class="absolute top-7 left-6 text-xs text-slate-300 font-bold">PWR</div>
                                
                                <div id="status-led" class="status-light absolute top-3 left-16 w-4 h-4 bg-blue-400 rounded-full opacity-0 transition-all duration-500 shadow-lg neon-glow">
                                    <div class="absolute inset-0.5 bg-blue-300 rounded-full animate-pulse"></div>
                                </div>
                                <div class="absolute top-7 left-16 text-xs text-slate-300 font-bold">STS</div>
                                
                                <div class="absolute top-3 left-26 w-4 h-4 bg-yellow-400 rounded-full opacity-60 shadow-lg">
                                    <div class="absolute inset-0.5 bg-yellow-300 rounded-full"></div>
                                </div>
                                <div class="absolute top-7 left-26 text-xs text-slate-300 font-bold">HDD</div>
                                
                                <!-- Enhanced ports and connectors -->
                                <div class="absolute bottom-3 left-6 w-8 h-4 bg-slate-900 rounded border border-slate-500">
                                    <div class="text-xs text-slate-400 text-center leading-4">USB</div>
                                </div>
                                <div class="absolute bottom-7 left-6 text-xs text-slate-400 font-bold">USB</div>
                                
                                <div class="absolute bottom-3 left-18 w-6 h-4 bg-slate-900 rounded border border-slate-500">
                                    <div class="text-xs text-slate-400 text-center leading-4">SD</div>
                                </div>
                                <div class="absolute bottom-7 left-18 text-xs text-slate-400 font-bold">SD CARD</div>
                                
                                <div class="absolute bottom-3 right-6 w-10 h-4 bg-slate-900 rounded border border-slate-500">
                                    <div class="text-xs text-slate-400 text-center leading-4">POWER</div>
                                </div>
                                <div class="absolute bottom-7 right-6 text-xs text-slate-400 font-bold">ALIMENTACI√ìN</div>
                                
                                <!-- Control board label -->
                                <div class="absolute top-3 left-1/2 transform -translate-x-1/2 text-center">
                                    <div class="text-sm font-bold text-slate-300">EINSY RAMBo</div>
                                    <div class="text-xs text-slate-400">32-bit Control Board</div>
                                </div>
                                
                                <!-- PSU integrated section -->
                                <div class="absolute top-3 right-6 w-20 h-14 bg-gradient-to-br from-slate-800 via-slate-700 to-slate-900 rounded-lg shadow-xl border border-slate-500">
                                    <!-- PSU Fan -->
                                    <div class="absolute top-1 right-1 w-6 h-6 bg-gradient-to-br from-slate-900 to-black rounded-full shadow-lg border border-slate-500">
                                        <div id="psu-fan" class="w-full h-full bg-gradient-to-br from-slate-400 to-slate-500 rounded-full relative">
                                            <div class="absolute inset-0.5 bg-slate-700 rounded-full">
                                                <div class="absolute top-0 left-1/2 w-px h-2 bg-slate-400 transform -translate-x-1/2"></div>
                                                <div class="absolute bottom-0 left-1/2 w-px h-2 bg-slate-400 transform -translate-x-1/2"></div>
                                                <div class="absolute left-0 top-1/2 w-2 h-px bg-slate-400 transform -translate-y-1/2"></div>
                                                <div class="absolute right-0 top-1/2 w-2 h-px bg-slate-400 transform -translate-y-1/2"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- PSU Label -->
                                    <div class="absolute top-1 left-1 text-xs font-bold text-slate-300">PSU</div>
                                    <div class="absolute top-4 left-1 text-xs text-slate-400">24V</div>
                                    <div class="absolute top-7 left-1 text-xs text-slate-400">240W</div>
                                    
                                    <!-- Power indicator -->
                                    <div id="psu-indicator-rear" class="absolute bottom-1 left-1 w-2 h-2 bg-red-500 rounded-full opacity-0 transition-all"></div>
                                    <div class="absolute bottom-1 left-4 text-xs text-slate-400">PWR</div>
                                </div>
                            </div>

                            <!-- Enhanced Filament Spool System - Centered -->
                            <div class="absolute top-12 left-1/2 transform -translate-x-1/2 w-8 h-32 bg-gradient-to-b from-slate-500 via-slate-600 to-slate-700 rounded-full shadow-xl">
                                <div class="absolute inset-1 bg-gradient-to-b from-slate-400 to-slate-500 rounded-full"></div>
                                <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-slate-800 rounded-full shadow-inner"></div>
                                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-slate-800 rounded-full shadow-inner"></div>
                                
                                <!-- Spool Holder Label -->
                                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-3 py-1 rounded-t-lg text-xs font-bold border-2 border-slate-600 border-b-0 whitespace-nowrap">
                                    üéØ SOPORTE CARRETE
                                </div>
                            </div>
                            
                            <!-- Enhanced Filament Spool - Centered -->
                            <div id="filament-spool-rear" class="clickable-component absolute top-16 left-1/2 transform -translate-x-1/2 w-24 h-24 bg-gradient-to-br from-blue-400 via-blue-500 to-blue-700 rounded-full border-4 border-blue-800 shadow-2xl hover:scale-110 transition-all duration-300" onclick="clickComponent('spool')" onmouseenter="showTooltip(event, 'Carrete de filamento PLA+ - Material premium de alta calidad')" onmouseleave="hideTooltip()">
                                <div class="absolute inset-6 bg-gradient-to-br from-slate-300 to-slate-400 rounded-full shadow-inner">
                                    <div class="absolute inset-1 bg-slate-200 rounded-full"></div>
                                </div>
                                <!-- Enhanced spool details -->
                                <div class="absolute inset-1 border-2 border-blue-300 rounded-full opacity-80"></div>
                                <div class="absolute inset-4 border border-blue-200 rounded-full opacity-60"></div>
                                <div class="absolute top-4 left-4 w-3 h-16 bg-blue-300 rounded-full opacity-40"></div>
                                <div class="absolute top-4 right-4 w-3 h-16 bg-blue-300 rounded-full opacity-40"></div>
                                
                                <!-- Filament wound on spool -->
                                <div class="absolute inset-3 border-4 border-blue-400 rounded-full opacity-60"></div>
                                <div class="absolute inset-5 border-2 border-blue-500 rounded-full opacity-40"></div>
                                
                                <!-- Spool label -->
                                <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 bg-blue-800 text-white px-3 py-1 rounded-b-lg text-xs font-bold border-2 border-blue-600 border-t-0">
                                    üßµ FILAMENTO PLA+
                                </div>
                            </div>
                            
                            <!-- Enhanced Filament Path - Centered -->
                            <div id="filament-path-rear" class="absolute top-24 left-1/2 transform -translate-x-1/2 translate-x-8 w-3 h-20 bg-gradient-to-b from-blue-400 to-blue-600 opacity-0 transition-all duration-500 rounded-full shadow-lg neon-glow">
                                <div class="absolute inset-0 bg-blue-300 rounded-full animate-pulse"></div>
                            </div>

                            <!-- Z-axis Lead Screws with Labels -->
                            <div class="absolute left-3 top-12 bottom-32 w-4 bg-gradient-to-b from-slate-400 via-slate-500 to-slate-600 rounded-full shadow-xl">
                                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-slate-300 to-transparent opacity-60 rounded-full"></div>
                                <!-- Thread pattern -->
                                <div class="absolute top-3 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                <div class="absolute top-12 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                <div class="absolute top-21 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                
                                <!-- Z-axis Label -->
                                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-2 py-1 rounded-t-lg text-xs font-bold border-2 border-slate-600 border-b-0 whitespace-nowrap">
                                    ‚öôÔ∏è EJE Z
                                </div>
                            </div>
                            <div class="absolute right-3 top-12 bottom-32 w-4 bg-gradient-to-b from-slate-400 via-slate-500 to-slate-600 rounded-full shadow-xl">
                                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-slate-300 to-transparent opacity-60 rounded-full"></div>
                                <div class="absolute top-3 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                <div class="absolute top-12 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                <div class="absolute top-21 left-1/2 transform -translate-x-1/2 w-px h-6 bg-slate-700"></div>
                                
                                <!-- Z-axis Label -->
                                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-2 py-1 rounded-t-lg text-xs font-bold border-2 border-slate-600 border-b-0 whitespace-nowrap">
                                    ‚öôÔ∏è EJE Z
                                </div>
                            </div>

                            <!-- Enhanced Y-axis Rails with Label -->
                            <div class="absolute bottom-32 left-6 right-6 h-4 bg-gradient-to-r from-slate-500 via-slate-400 to-slate-500 rounded-full shadow-lg">
                                <div class="absolute inset-1 bg-gradient-to-r from-slate-300 to-slate-400 rounded-full"></div>
                                
                                <!-- Y-axis Label -->
                                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-3 py-1 rounded-t-lg text-xs font-bold border-2 border-slate-600 border-b-0">
                                    üîÑ RIEL EJE Y
                                </div>
                            </div>

                            <!-- Wiring and cables with labels -->
                            <div class="absolute top-32 left-12 w-1 h-16 bg-gradient-to-b from-red-600 to-red-800 rounded-full opacity-80"></div>
                            <div class="absolute top-32 left-14 w-1 h-16 bg-gradient-to-b from-black to-gray-800 rounded-full opacity-80"></div>
                            <div class="absolute top-32 left-16 w-1 h-16 bg-gradient-to-b from-blue-600 to-blue-800 rounded-full opacity-80"></div>
                            
                            <!-- Wiring Label -->
                            <div class="absolute top-26 left-8 bg-slate-800 text-white px-2 py-1 rounded-lg text-xs font-bold border border-slate-600">
                                üîå CABLEADO
                            </div>

                            <!-- Enhanced ambient lighting effects -->
                            <div class="absolute inset-0 bg-gradient-to-t from-transparent via-transparent to-purple-500 opacity-5 rounded-3xl pointer-events-none"></div>
                            <div class="absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t from-purple-600 to-transparent opacity-10 rounded-b-3xl pointer-events-none"></div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Status Panel (Guided Mode Only) -->
                <div id="status-panel-container" class="xl:w-1/3 hidden">
                    <div class="status-panel rounded-3xl p-6 shadow-2xl border-2 border-slate-600 h-[600px] overflow-y-auto">
                        <h3 class="text-2xl font-bold mb-6 text-white flex items-center gap-3">
                            üìä Panel de Estado Avanzado
                        </h3>
                        
                        <!-- Enhanced Status Grid -->
                        <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                            <div class="bg-slate-700 rounded-xl p-4">
                                <span class="text-slate-300">Estado:</span>
                                <div id="printer-status" class="font-bold text-red-400 text-lg">Apagada</div>
                            </div>
                            <div class="bg-slate-700 rounded-xl p-4">
                                <span class="text-slate-300">Modo:</span>
                                <div id="current-mode" class="font-bold text-blue-400 text-lg">Guiado</div>
                            </div>
                            <div class="bg-slate-700 rounded-xl p-4">
                                <span class="text-slate-300">Pos X:</span>
                                <div id="pos-x" class="font-bold text-green-400">0mm</div>
                            </div>
                            <div class="bg-slate-700 rounded-xl p-4">
                                <span class="text-slate-300">Pos Y:</span>
                                <div id="pos-y" class="font-bold text-green-400">0mm</div>
                            </div>
                            <div class="bg-slate-700 rounded-xl p-4">
                                <span class="text-slate-300">Pos Z:</span>
                                <div id="pos-z" class="font-bold text-green-400">0mm</div>
                            </div>
                            <div class="bg-slate-700 rounded-xl p-4">
                                <span class="text-slate-300">Progreso:</span>
                                <div id="print-progress-text" class="font-bold text-purple-400">0%</div>
                            </div>
                        </div>

                        <!-- Temperature Status -->
                        <div class="bg-slate-700 rounded-xl p-4 mb-6">
                            <h4 class="font-bold mb-3 text-orange-400">üå°Ô∏è Temperaturas</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-300">Extrusor:</span>
                                    <span id="display-extruder-temp" class="font-bold text-orange-400">25¬∞C</span>
                                </div>
                                <div class="w-full bg-slate-600 rounded-full h-2">
                                    <div id="extruder-temp-bar" class="bg-gradient-to-r from-orange-400 to-red-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-300">Cama:</span>
                                    <span id="display-bed-temp" class="font-bold text-red-400">25¬∞C</span>
                                </div>
                                <div class="w-full bg-slate-600 rounded-full h-2">
                                    <div id="bed-temp-bar" class="bg-gradient-to-r from-red-400 to-red-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Print Progress (when printing) -->
                        <div id="print-progress-panel" class="bg-slate-700 rounded-xl p-4 mb-6 hidden">
                            <h4 class="font-bold mb-3 text-blue-400">üñ®Ô∏è Progreso de Impresi√≥n</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-slate-300">Capa actual:</span>
                                    <span id="current-layer" class="font-bold text-blue-400">0/0</span>
                                </div>
                                <div class="w-full bg-slate-600 rounded-full h-3">
                                    <div id="layer-progress" class="print-progress h-3 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-300">Tiempo restante:</span>
                                    <span id="time-remaining" class="font-bold text-purple-400">--:--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let simulatorMode = 'guided';
        let currentView = 'front';
        let moveIncrement = { x: 10, y: 10, z: 5 };
        let printingTimer = null;
        let printProgress = 0;
        let currentLayer = 0;
        let totalLayers = 50;
        let printStartTime = null;
        let estimatedPrintTime = 30000; // 30 segundos para demo (en producci√≥n ser√≠a horas)
        
        // PASO 2: Estado del filamento seleccionado
        let selectedFilament = {
            type: 'PLA',
            name: 'PLA (√Åcido Polil√°ctico)',
            extruderTemp: 200,
            bedTemp: 60,
            color: 'from-green-400 to-green-600',
            borderColor: 'border-green-300'
        };
        
        // Configuraciones de filamentos disponibles
        const filamentConfigs = {
            PLA: {
                type: 'PLA',
                name: 'PLA (√Åcido Polil√°ctico)',
                extruderTemp: 200,
                bedTemp: 60,
                color: 'from-green-400 to-green-600',
                borderColor: 'border-green-300',
                speed: '50-80mm/s',
                retraction: '4-6mm'
            },
            ABS: {
                type: 'ABS',
                name: 'ABS (Acrilonitrilo Butadieno Estireno)',
                extruderTemp: 240,
                bedTemp: 80,
                color: 'from-red-400 to-red-600',
                borderColor: 'border-red-300',
                speed: '40-60mm/s',
                retraction: '3-5mm'
            },
            PETG: {
                type: 'PETG',
                name: 'PETG (Polietileno Tereftalato Glicol)',
                extruderTemp: 230,
                bedTemp: 70,
                color: 'from-purple-400 to-purple-600',
                borderColor: 'border-purple-300',
                speed: '45-70mm/s',
                retraction: '2-4mm'
            }
        };
        
        let printerState = {
            powered: false,
            extruderTemp: 25,
            bedTemp: 25,
            position: { x: 0, y: 0, z: 0 },
            filamentLoaded: false,
            leveled: false,
            printing: false,
            paused: false,
            emergencyStop: false,
            printCompleted: false,
            printProgress: 0,
            currentLayer: 0,
            timeRemaining: 0,
            selectedFilament: 'PLA' // PASO 2: Filamento seleccionado por defecto
        };

        // Enhanced simulator steps content
        const simulatorSteps = {
            1: {
                title: "Preparaci√≥n inicial",
                description: "Verifica que la impresora est√© conectada y enci√©ndela",
                actionButton: "üîå Encender Impresora",
                actionFunction: "togglePower",
                checklist: [
                    { id: "power-cable", text: "Conectar cable de alimentaci√≥n", completed: true },
                    { id: "power-on", text: "Encender la impresora", completed: false, requiresAction: true },
                    { id: "lcd-check", text: "Verificar pantalla LCD activa", completed: false, requiresAction: true }
                ],
                tips: [
                    "Aseg√∫rate de que el cable de alimentaci√≥n est√© bien conectado",
                    "La pantalla LCD debe mostrar el men√∫ principal al encender",
                    "Verifica que todos los LEDs de estado se enciendan correctamente",
                    "El ventilador de la fuente de alimentaci√≥n debe funcionar"
                ]
            },
            2: {
                title: "Carga de filamento",
                description: "Calienta el extrusor e inserta el filamento correctamente",
                actionButton: "üî• Calentar y Cargar",
                actionFunction: "heatAndLoadFilament",
                checklist: [
                    { id: "heat-extruder", text: "Calentar extrusor a 200¬∞C", completed: false, requiresAction: true },
                    { id: "insert-filament", text: "Insertar filamento en el extrusor", completed: false, requiresAction: true },
                    { id: "verify-extrusion", text: "Verificar extrusi√≥n de material", completed: false, requiresAction: true }
                ],
                tips: [
                    "Espera a que el extrusor alcance la temperatura objetivo antes de insertar filamento",
                    "Corta el extremo del filamento en √°ngulo para facilitar la inserci√≥n",
                    "Empuja suavemente el filamento hasta que salga material por la boquilla",
                    "El material extruido debe ser uniforme y sin burbujas"
                ]
            },
            3: {
                title: "Nivelaci√≥n de la cama",
                description: "Ajusta la distancia entre el extrusor y la cama de impresi√≥n",
                actionButton: "üìê Ejecutar Auto-Nivelaci√≥n",
                actionFunction: "autoLevel",
                checklist: [
                    { id: "start-leveling", text: "Ejecutar auto-nivelaci√≥n", completed: false, requiresAction: true },
                    { id: "verify-mesh", text: "Verificar malla de puntos generada", completed: false, requiresAction: true },
                    { id: "confirm-level", text: "Confirmar nivelaci√≥n exitosa", completed: false, requiresAction: true }
                ],
                tips: [
                    "La auto-nivelaci√≥n mide 9 puntos en la superficie de la cama",
                    "Aseg√∫rate de que la cama est√© limpia antes de nivelar",
                    "El proceso toma aproximadamente 2-3 minutos",
                    "Una buena nivelaci√≥n es crucial para la primera capa"
                ]
            },
            4: {
                title: "Iniciar impresi√≥n",
                description: "Selecciona el archivo y comienza el proceso de impresi√≥n",
                actionButton: "üñ®Ô∏è Comenzar Impresi√≥n",
                actionFunction: "startPrint",
                checklist: [
                    { id: "select-file", text: "Seleccionar archivo .gcode", completed: true },
                    { id: "start-printing", text: "Iniciar proceso de impresi√≥n", completed: false, requiresAction: true },
                    { id: "monitor-layer", text: "Monitorear primera capa", completed: false, requiresAction: true }
                ],
                tips: [
                    "Aseg√∫rate de que el archivo .gcode sea compatible con tu impresora",
                    "Observa atentamente la primera capa - debe adherirse bien a la cama",
                    "Si la primera capa no se adhiere correctamente, pausa y ajusta",
                    "El tiempo de impresi√≥n depende del tama√±o y complejidad del objeto"
                ]
            }
        };

        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification bg-white border-l-4 p-4 rounded-lg shadow-xl max-w-sm ${
                type === 'success' ? 'border-green-500' : 
                type === 'error' ? 'border-red-500' : 
                type === 'warning' ? 'border-yellow-500' : 'border-blue-500'
            }`;
            
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="text-xl mr-3">${icon}</span>
                    <span class="text-sm text-gray-700 font-medium">${message}</span>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Tooltip system
        function showTooltip(event, text) {
            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = text;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 30 + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('show');
        }

        // View switching
        function switchView(view) {
            currentView = view;
            
            const frontViewBtn = document.getElementById('front-view-btn');
            const rearViewBtn = document.getElementById('rear-view-btn');
            const frontView = document.getElementById('front-view');
            const rearView = document.getElementById('rear-view');
            
            if (view === 'front') {
                frontViewBtn.className = 'px-4 py-2 rounded-lg font-bold text-white bg-gradient-to-r from-blue-500 to-blue-600 shadow-md transition-all duration-300 transform hover:scale-105 text-sm';
                rearViewBtn.className = 'px-4 py-2 rounded-lg font-bold text-gray-700 hover:bg-white hover:shadow-md transition-all duration-300 transform hover:scale-105 text-sm';
                frontView.classList.remove('hidden');
                rearView.classList.add('hidden');
                showNotification('Vista frontal - Componentes principales de impresi√≥n', 'info');
            } else {
                rearViewBtn.className = 'px-4 py-2 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-purple-600 shadow-md transition-all duration-300 transform hover:scale-105 text-sm';
                frontViewBtn.className = 'px-4 py-2 rounded-lg font-bold text-gray-700 hover:bg-white hover:shadow-md transition-all duration-300 transform hover:scale-105 text-sm';
                frontView.classList.add('hidden');
                rearView.classList.remove('hidden');
                showNotification('Vista trasera - Electr√≥nica y sistema de alimentaci√≥n', 'info');
            }
            
            // Sync power state between views
            syncViewStates();
        }

        // Enhanced LED synchronization system
        function syncAllLEDs() {
            // Power LED synchronization
            const powerLed = document.getElementById('power-led');
            const statusLed = document.getElementById('status-led');
            const connectionLight = document.getElementById('connection-light');
            
            if (powerLed) {
                if (printerState.powered) {
                    powerLed.style.opacity = '1';
                    powerLed.className = 'status-light absolute top-3 left-6 w-4 h-4 bg-green-400 rounded-full transition-all duration-500 shadow-lg neon-glow';
                } else {
                    powerLed.style.opacity = '0';
                    powerLed.className = 'status-light absolute top-3 left-6 w-4 h-4 bg-red-400 rounded-full opacity-0 transition-all duration-500 shadow-lg';
                }
            }
            
            if (statusLed) {
                if (printerState.powered) {
                    if (printerState.printing && !printerState.paused) {
                        statusLed.style.opacity = '1';
                        statusLed.className = 'status-light absolute top-3 left-16 w-4 h-4 bg-green-400 rounded-full transition-all duration-500 shadow-lg neon-glow';
                    } else if (printerState.paused) {
                        statusLed.style.opacity = '1';
                        statusLed.className = 'status-light absolute top-3 left-16 w-4 h-4 bg-yellow-400 rounded-full transition-all duration-500 shadow-lg neon-glow';
                    } else {
                        statusLed.style.opacity = '1';
                        statusLed.className = 'status-light absolute top-3 left-16 w-4 h-4 bg-blue-400 rounded-full transition-all duration-500 shadow-lg neon-glow';
                    }
                } else {
                    statusLed.style.opacity = '0';
                    statusLed.className = 'status-light absolute top-3 left-16 w-4 h-4 bg-gray-400 rounded-full opacity-0 transition-all duration-500 shadow-lg';
                }
            }
            
            if (connectionLight) {
                if (printerState.powered) {
                    connectionLight.className = 'w-4 h-4 bg-green-400 rounded-full shadow-inner neon-glow';
                } else {
                    connectionLight.className = 'w-4 h-4 bg-red-400 rounded-full shadow-inner neon-glow';
                }
            }
            
            // PSU indicators synchronization
            syncPSUIndicators();
            
            // Sync other visual elements
            syncFilamentPath();
            syncFanAnimations();
        }
        
        function syncPSUIndicators() {
            const psuIndicator = document.getElementById('psu-indicator');
            const psuIndicatorRear = document.getElementById('psu-indicator-rear');
            
            const opacity = printerState.powered ? '1' : '0';
            const bgColor = printerState.powered ? 'bg-green-500' : 'bg-red-500';
            
            if (psuIndicator) {
                psuIndicator.style.opacity = opacity;
                psuIndicator.className = `w-2 h-2 ${bgColor} rounded-full mt-1 ml-1 transition-all`;
            }
            
            if (psuIndicatorRear) {
                psuIndicatorRear.style.opacity = opacity;
                psuIndicatorRear.className = `absolute bottom-1 left-1 w-2 h-2 ${bgColor} rounded-full transition-all`;
            }
        }
        
        function syncFilamentPath() {
            const filamentPath = document.getElementById('filament-path');
            const filamentPathRear = document.getElementById('filament-path-rear');
            
            const opacity = printerState.filamentLoaded ? '1' : '0';
            
            if (filamentPath) filamentPath.style.opacity = opacity;
            if (filamentPathRear) filamentPathRear.style.opacity = opacity;
        }
        
        function syncFanAnimations() {
            // PSU Fan - should run whenever printer is powered (both views)
            const psuFan = document.getElementById('psu-fan');
            const rearViewPsuFan = document.querySelector('#rear-view .absolute.top-1.right-1 > div');
            
            // Extruder Fan - should run only when printing and not paused
            const fanBlade = document.getElementById('fan-blade');
            
            // PSU fan animation - runs when powered
            const psuAnimation = printerState.powered ? 'spin 2s linear infinite' : 'none';
            
            // Extruder fan animation - runs when printing and not paused
            const extruderAnimation = (printerState.printing && !printerState.paused) ? 'spin 0.5s linear infinite' : 'none';
            
            // Apply PSU fan animations
            if (psuFan) {
                psuFan.style.animation = psuAnimation;
                psuFan.style.transformOrigin = 'center';
            }
            if (rearViewPsuFan) {
                rearViewPsuFan.style.animation = psuAnimation;
                rearViewPsuFan.style.transformOrigin = 'center';
            }
            
            // Apply extruder fan animation
            if (fanBlade) {
                fanBlade.style.animation = extruderAnimation;
                fanBlade.style.transformOrigin = 'center';
            }
            
            // Debug logging for fan states
            console.log('Fan Animation Sync:', {
                powered: printerState.powered,
                printing: printerState.printing,
                paused: printerState.paused,
                psuAnimation: psuAnimation,
                extruderAnimation: extruderAnimation
            });
        }

        function syncViewStates() {
            // Use the enhanced LED synchronization system
            syncAllLEDs();
        }

        // Mode switching
        function setMode(mode) {
            simulatorMode = mode;
            
            const guidedBtn = document.getElementById('guided-mode');
            const manualBtn = document.getElementById('manual-mode');
            const progressSection = document.getElementById('progress-section');
            const stepIndicators = document.getElementById('step-indicators');
            const guidedStepPanel = document.getElementById('guided-step-panel');
            const manualControls = document.getElementById('manual-controls');
            const currentModeDisplay = document.getElementById('current-mode');
            const statusPanelContainer = document.getElementById('status-panel-container');
            const printerMainContainer = document.getElementById('printer-main-container');
            
            if (mode === 'guided') {
                guidedBtn.className = 'px-8 py-4 rounded-xl font-bold text-white bg-white bg-opacity-20 backdrop-blur-sm transition-all duration-300 shadow-lg';
                manualBtn.className = 'px-8 py-4 rounded-xl font-bold text-white hover:bg-white hover:bg-opacity-10 transition-all duration-300';
                progressSection.classList.remove('hidden');
                stepIndicators.classList.remove('hidden');
                guidedStepPanel.classList.remove('hidden');
                manualControls.classList.add('hidden');
                statusPanelContainer.classList.add('hidden');
                printerMainContainer.className = 'w-full';
                if (currentModeDisplay) currentModeDisplay.textContent = 'Guiado';
                
                // Initialize guided mode
                updateSimulatorStep();
            } else {
                manualBtn.className = 'px-8 py-4 rounded-xl font-bold text-white bg-white bg-opacity-20 backdrop-blur-sm transition-all duration-300 shadow-lg';
                guidedBtn.className = 'px-8 py-4 rounded-xl font-bold text-white hover:bg-white hover:bg-opacity-10 transition-all duration-300';
                progressSection.classList.add('hidden');
                stepIndicators.classList.add('hidden');
                guidedStepPanel.classList.add('hidden');
                manualControls.classList.remove('hidden');
                statusPanelContainer.classList.add('hidden');
                printerMainContainer.className = 'w-full';
                if (currentModeDisplay) currentModeDisplay.textContent = 'Manual';
            }
            
            showNotification(`Cambiado a modo ${mode === 'guided' ? 'guiado' : 'manual'}`, 'info');
        }

        // Guided mode functions
        function updateSimulatorStep() {
            const step = simulatorSteps[currentStep];
            if (!step) return;
            
            // Update step content
            document.getElementById('current-step-number').textContent = currentStep;
            document.getElementById('step-title').textContent = step.title;
            document.getElementById('step-description').textContent = step.description;
            document.getElementById('step-counter').textContent = currentStep;
            document.getElementById('step-progress-percent').textContent = Math.round((currentStep - 1) / 4 * 100);
            
            // Update action button
            const actionBtn = document.getElementById('step-action-btn');
            actionBtn.textContent = step.actionButton;
            actionBtn.onclick = () => executeStepAction();
            
            // Update checklist
            updateChecklist();
            
            // Update tips
            updateTips();
            
            // Update navigation buttons
            updateNavigationButtons();
            
            // Update step indicators
            updateStepIndicators();
            
            // Update progress bar
            updateProgressBar();
        }

        // Step execution functions
        function executeStepAction() {
            const step = simulatorSteps[currentStep];
            if (step && step.actionFunction) {
                // Execute the step action
                if (step.actionFunction === 'togglePower') {
                    togglePower();
                    // Mark power-related checklist items as completed
                    setTimeout(() => {
                        markChecklistItem('power-on', true);
                        markChecklistItem('lcd-check', true);
                        updateSimulatorStep();
                        checkStepCompletion();
                    }, 500);
                } else if (step.actionFunction === 'heatAndLoadFilament') {
                    heatAndLoadFilament();
                } else if (step.actionFunction === 'autoLevel') {
                    autoLevel();
                } else if (step.actionFunction === 'startPrint') {
                    startPrint();
                }
            }
        }

        function markChecklistItem(itemId, completed) {
            const step = simulatorSteps[currentStep];
            if (step && step.checklist) {
                const item = step.checklist.find(item => item.id === itemId);
                if (item) {
                    item.completed = completed;
                }
            }
        }

        function checkStepCompletion() {
            const step = simulatorSteps[currentStep];
            if (!step) return;
            
            const allCompleted = step.checklist.every(item => item.completed);
            const nextBtn = document.getElementById('next-btn');
            
            if (allCompleted) {
                nextBtn.disabled = false;
                nextBtn.className = 'interactive-btn px-6 py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-xl flex items-center gap-2 shadow-lg transition-all';
                showNotification('¬°Paso completado! Puedes continuar al siguiente paso', 'success');
            } else {
                nextBtn.disabled = true;
                nextBtn.className = 'interactive-btn px-6 py-4 bg-gray-400 text-gray-600 rounded-xl cursor-not-allowed flex items-center gap-2 shadow-lg';
            }
        }

        function updateChecklist() {
            const step = simulatorSteps[currentStep];
            const checklistContainer = document.getElementById('step-checklist');
            
            if (!step || !checklistContainer) return;
            
            checklistContainer.innerHTML = '';
            
            step.checklist.forEach(item => {
                const checklistItem = document.createElement('div');
                checklistItem.className = `flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${
                    item.completed ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'
                }`;
                
                checklistItem.innerHTML = `
                    <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                        item.completed ? 'bg-green-500 border-green-500' : 'border-gray-300'
                    }">
                        ${item.completed ? '<span class="text-white text-sm">‚úì</span>' : ''}
                    </div>
                    <span class="flex-1 ${item.completed ? 'text-green-800 font-medium' : 'text-gray-700'}">${item.text}</span>
                    ${item.requiresAction && !item.completed ? '<span class="text-blue-600 text-sm font-bold">‚Üê Acci√≥n requerida</span>' : ''}
                `;
                
                checklistContainer.appendChild(checklistItem);
            });
        }

        function updateTips() {
            const step = simulatorSteps[currentStep];
            const tipsList = document.getElementById('step-tips-list');
            
            if (!step || !tipsList) return;
            
            tipsList.innerHTML = '';
            
            step.tips.forEach(tip => {
                const tipItem = document.createElement('li');
                tipItem.textContent = tip;
                tipsList.appendChild(tipItem);
            });
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            // Previous button
            if (currentStep > 1) {
                prevBtn.disabled = false;
                prevBtn.className = 'interactive-btn px-6 py-4 bg-gray-500 hover:bg-gray-600 text-white rounded-xl flex items-center gap-2 shadow-lg transition-all';
            } else {
                prevBtn.disabled = true;
                prevBtn.className = 'interactive-btn px-6 py-4 bg-gray-300 text-gray-600 rounded-xl cursor-not-allowed flex items-center gap-2 shadow-lg';
            }
            
            // Next button - check if step is completed
            checkStepCompletion();
        }

        function updateStepIndicators() {
            for (let i = 1; i <= 4; i++) {
                const indicators = document.querySelectorAll('.step-indicator');
                const indicator = indicators[i - 1];
                
                if (!indicator) continue;
                
                const stepNumber = indicator.querySelector('.step-number');
                const stepCheck = indicator.querySelector('.step-check');
                
                if (i < currentStep) {
                    // Completed step
                    indicator.className = 'step-indicator flex flex-col items-center p-4 rounded-xl bg-gradient-to-br from-green-500 to-green-600 text-white shadow-xl cursor-pointer hover:scale-105 transition-all duration-300';
                    if (stepNumber) stepNumber.classList.add('hidden');
                    if (stepCheck) stepCheck.classList.remove('hidden');
                } else if (i === currentStep) {
                    // Current step
                    indicator.className = 'step-indicator active flex flex-col items-center p-4 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-xl transform scale-110 cursor-pointer hover:scale-115 transition-all duration-300';
                    if (stepNumber) stepNumber.classList.remove('hidden');
                    if (stepCheck) stepCheck.classList.add('hidden');
                } else {
                    // Future step
                    indicator.className = 'step-indicator flex flex-col items-center p-4 rounded-xl bg-gray-200 text-gray-600 shadow-lg cursor-pointer hover:scale-105 transition-all duration-300';
                    if (stepNumber) stepNumber.classList.remove('hidden');
                    if (stepCheck) stepCheck.classList.add('hidden');
                }
            }
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            // FIXED: Calcular progreso correctamente, incluyendo el estado completado (currentStep = 5)
            let progress;
            if (currentStep >= 5) {
                progress = 100; // Proceso completado
            } else {
                progress = Math.round((currentStep - 1) / 4 * 100);
            }
            
            if (progressBar) progressBar.style.width = progress + '%';
            if (progressText) progressText.textContent = progress + '% completado';
        }

        function nextStep() {
            if (currentStep < 4) {
                currentStep++;
                updateSimulatorStep();
                showNotification(`Avanzando al paso ${currentStep}`, 'info');
            } else if (currentStep === 4) {
                // FIXED: Finalizar el proceso guiado cuando se completa el √∫ltimo paso
                showNotification('üéâ ¬°Proceso de impresi√≥n completado exitosamente!', 'success');
                
                // FIXED: Forzar currentStep a 5 para calcular 100% correctamente
                currentStep = 5;
                
                // Actualizar indicadores finales con progreso al 100%
                updateProgressBar();
                
                // Marcar todos los pasos como completados
                for (let i = 1; i <= 4; i++) {
                    const indicators = document.querySelectorAll('.step-indicator');
                    const indicator = indicators[i - 1];
                    
                    if (indicator) {
                        const stepNumber = indicator.querySelector('.step-number');
                        const stepCheck = indicator.querySelector('.step-check');
                        
                        indicator.className = 'step-indicator flex flex-col items-center p-4 rounded-xl bg-gradient-to-br from-green-500 to-green-600 text-white shadow-xl cursor-pointer hover:scale-105 transition-all duration-300';
                        if (stepNumber) stepNumber.classList.add('hidden');
                        if (stepCheck) stepCheck.classList.remove('hidden');
                    }
                }
                
                // FIXED: Forzar barra de progreso al 100% expl√≠citamente
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                if (progressBar) progressBar.style.width = '100%';
                if (progressText) progressText.textContent = '100% completado';
                
                // FIXED: Actualizar tambi√©n el porcentaje del paso
                const stepProgressPercent = document.getElementById('step-progress-percent');
                if (stepProgressPercent) stepProgressPercent.textContent = '100';
                
                // Deshabilitar bot√≥n siguiente y mostrar mensaje de finalizaci√≥n
                const nextBtn = document.getElementById('next-btn');
                if (nextBtn) {
                    nextBtn.disabled = true;
                    nextBtn.textContent = '‚úÖ Proceso Completado';
                    nextBtn.className = 'interactive-btn px-6 py-4 bg-green-500 text-white rounded-xl cursor-default flex items-center gap-2 shadow-lg';
                }
                
                // Actualizar panel de paso con mensaje de finalizaci√≥n
                const stepTitle = document.getElementById('step-title');
                const stepDescription = document.getElementById('step-description');
                
                if (stepTitle) stepTitle.textContent = 'üéâ ¬°Proceso Completado!';
                if (stepDescription) stepDescription.textContent = 'Has completado exitosamente todos los pasos del proceso de impresi√≥n 3D';
                
                // Ocultar bot√≥n de acci√≥n y mostrar mensaje de √©xito
                const actionBtn = document.getElementById('step-action-btn');
                if (actionBtn) {
                    actionBtn.style.display = 'none';
                }
                
                // Actualizar checklist final
                const checklistContainer = document.getElementById('step-checklist');
                if (checklistContainer) {
                    checklistContainer.innerHTML = `
                        <div class="flex items-center gap-4 p-4 rounded-xl border-2 bg-green-50 border-green-200">
                            <div class="w-6 h-6 rounded-full border-2 bg-green-500 border-green-500 flex items-center justify-center">
                                <span class="text-white text-sm">‚úì</span>
                            </div>
                            <span class="flex-1 text-green-800 font-medium">Proceso de impresi√≥n 3D completado exitosamente</span>
                            <span class="text-green-600 text-sm font-bold">üéâ ¬°Finalizado!</span>
                        </div>
                    `;
                }
                
                // Actualizar tips finales
                const tipsList = document.getElementById('step-tips-list');
                if (tipsList) {
                    tipsList.innerHTML = `
                        <li>¬°Felicitaciones! Has completado el proceso completo de impresi√≥n 3D</li>
                        <li>Puedes cambiar al modo manual para explorar m√°s funciones</li>
                        <li>La impresi√≥n continuar√° hasta completarse autom√°ticamente</li>
                        <li>Monitorea la primera capa para asegurar buena adherencia</li>
                    `;
                }
                
                setTimeout(() => {
                    showNotification('üîÑ Puedes cambiar al modo manual para m√°s control', 'info');
                }, 3000);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateSimulatorStep();
                showNotification(`Regresando al paso ${currentStep}`, 'info');
            }
        }

        function goToStep(step) {
            if (step >= 1 && step <= 4) {
                currentStep = step;
                updateSimulatorStep();
                showNotification(`Saltando al paso ${currentStep}`, 'info');
            }
        }

        // Heat and load filament function for guided mode
        function heatAndLoadFilament() {
            if (!printerState.powered) {
                showNotification('Enciende la impresora primero', 'warning');
                return;
            }
            
            showNotification('üî• Calentando extrusor a 200¬∞C...', 'info');
            
            // Heat extruder to 200¬∞C con sincronizaci√≥n completa
            printerState.extruderTemp = 200;
            syncAllTemperatureControls();
            updateHeatIndicators();
            updateLCDDisplay();
            
            setTimeout(() => {
                markChecklistItem('heat-extruder', true);
                updateSimulatorStep();
                showNotification('üå°Ô∏è Extrusor calentado. Insertando filamento...', 'info');
                
                setTimeout(() => {
                    loadFilament();
                    markChecklistItem('insert-filament', true);
                    markChecklistItem('verify-extrusion', true);
                    updateSimulatorStep();
                    checkStepCompletion();
                }, 1500);
            }, 2000);
        }

        // Sync modal temperatures - COMPLETE IMPLEMENTATION FIXED
        function syncModalTemperatures() {
            // Update modal temperature displays
            const modalExtruderTemp = document.getElementById('modal-extruder-temp');
            const modalBedTemp = document.getElementById('modal-bed-temp');
            const modalExtruderSlider = document.getElementById('modal-extruder-temp-slider');
            const modalBedSlider = document.getElementById('modal-bed-temp-slider');
            
            if (modalExtruderTemp) modalExtruderTemp.textContent = printerState.extruderTemp;
            if (modalBedTemp) modalBedTemp.textContent = printerState.bedTemp;
            if (modalExtruderSlider) modalExtruderSlider.value = printerState.extruderTemp;
            if (modalBedSlider) modalBedSlider.value = printerState.bedTemp;
            
            // Sync main interface sliders
            const extruderSlider = document.getElementById('extruder-temp-slider');
            const bedSlider = document.getElementById('bed-temp-slider');
            
            if (extruderSlider) extruderSlider.value = printerState.extruderTemp;
            if (bedSlider) bedSlider.value = printerState.bedTemp;
            
            // Update all temperature displays across the interface
            syncAllTemperatureDisplays();
            
            // Update visual heat indicators
            updateHeatIndicators();
            
            // Update LCD display with current temperatures
            updateLCDDisplay();
        }
        
        // Fixed function to sync all temperature displays
        function syncAllTemperatureDisplays() {
            // Displays principales
            const extruderTemp = document.getElementById('extruder-temp');
            const bedTemp = document.getElementById('bed-temp');
            
            // Displays en la impresora
            const extruderTempDisplay = document.getElementById('extruder-temp-display');
            const bedTempDisplay = document.getElementById('bed-temp-display');
            
            // Displays del modal
            const modalExtruderTemp = document.getElementById('modal-extruder-temp');
            const modalBedTemp = document.getElementById('modal-bed-temp');
            
            // Displays de estado r√°pido
            const quickExtruderTemp = document.getElementById('quick-extruder-temp');
            const quickBedTemp = document.getElementById('quick-bed-temp');
            
            // Displays del panel de estado
            const displayExtruderTemp = document.getElementById('display-extruder-temp');
            const displayBedTemp = document.getElementById('display-bed-temp');
            
            // Actualizar TODOS los displays del extrusor
            const extruderTempText = printerState.extruderTemp + '¬∞C';
            if (extruderTemp) extruderTemp.textContent = extruderTempText;
            if (extruderTempDisplay) extruderTempDisplay.textContent = extruderTempText;
            if (modalExtruderTemp) modalExtruderTemp.textContent = printerState.extruderTemp;
            if (quickExtruderTemp) quickExtruderTemp.textContent = extruderTempText;
            if (displayExtruderTemp) displayExtruderTemp.textContent = extruderTempText;
            
            // Actualizar TODOS los displays de la cama
            const bedTempText = printerState.bedTemp + '¬∞C';
            if (bedTemp) bedTemp.textContent = bedTempText;
            if (bedTempDisplay) bedTempDisplay.textContent = bedTempText;
            if (modalBedTemp) modalBedTemp.textContent = printerState.bedTemp;
            if (quickBedTemp) quickBedTemp.textContent = bedTempText;
            if (displayBedTemp) displayBedTemp.textContent = bedTempText;
            
            // Actualizar barras de progreso de temperatura
            updateTemperatureBars();
        }
        
        // Update heat indicators based on temperature
        function updateHeatIndicators() {
            const extruderHeatIndicator = document.getElementById('extruder-heat-indicator');
            const bedHeatIndicator = document.getElementById('bed-heat-indicator');
            
            // Extruder heat indicator
            if (extruderHeatIndicator) {
                if (printerState.extruderTemp > 50) {
                    extruderHeatIndicator.style.opacity = '1';
                    extruderHeatIndicator.classList.add('heating');
                    // Intensity based on temperature
                    const intensity = Math.min((printerState.extruderTemp - 50) / 250, 1);
                    extruderHeatIndicator.style.filter = `brightness(${1 + intensity})`;
                } else {
                    extruderHeatIndicator.style.opacity = '0';
                    extruderHeatIndicator.classList.remove('heating');
                    extruderHeatIndicator.style.filter = 'brightness(1)';
                }
            }
            
            // Bed heat indicator
            if (bedHeatIndicator) {
                if (printerState.bedTemp > 40) {
                    bedHeatIndicator.style.opacity = '1';
                    bedHeatIndicator.classList.add('heating');
                    // Intensity based on temperature
                    const intensity = Math.min((printerState.bedTemp - 40) / 80, 1);
                    bedHeatIndicator.style.filter = `brightness(${1 + intensity})`;
                } else {
                    bedHeatIndicator.style.opacity = '0';
                    bedHeatIndicator.classList.remove('heating');
                    bedHeatIndicator.style.filter = 'brightness(1)';
                }
            }
        }
        
        // Update LCD display content
        function updateLCDDisplay() {
            const lcdContent = document.getElementById('lcd-content');
            if (lcdContent) {
                if (printerState.powered) {
                    if (printerState.printing) {
                        if (printerState.paused) {
                            lcdContent.innerHTML = `
                                <div class="text-center font-bold text-yellow-400">PAUSED</div>
                                <div class="text-green-300 text-center text-xs">E:${printerState.extruderTemp}¬∞C B:${printerState.bedTemp}¬∞C</div>
                            `;
                        } else {
                            lcdContent.innerHTML = `
                                <div class="text-center font-bold text-green-400">PRINTING</div>
                                <div class="text-green-300 text-center text-xs">E:${printerState.extruderTemp}¬∞C B:${printerState.bedTemp}¬∞C</div>
                            `;
                        }
                    } else {
                        lcdContent.innerHTML = `
                            <div class="text-center font-bold text-blue-400">Ready</div>
                            <div class="text-green-300 text-center text-xs">E:${printerState.extruderTemp}¬∞C B:${printerState.bedTemp}¬∞C</div>
                        `;
                    }
                } else {
                    lcdContent.innerHTML = `
                        <div class="text-center font-bold text-red-400">Offline</div>
                        <div class="text-gray-500 text-center text-xs">Power Off</div>
                    `;
                }
            }
        }

        // FIXED: Comprehensive print status synchronization across ALL interface elements
        function syncPrintStatus() {
            const printStatus = document.getElementById('print-status');
            const printerStatus = document.getElementById('printer-status');
            const modalPrinterStatus = document.getElementById('modal-printer-status');
            const quickStatus = document.getElementById('quick-status');
            const connectionText = document.getElementById('connection-text');
            const lcdContent = document.getElementById('lcd-content');
            
            let statusText = '';
            let statusClass = '';
            let connectionStatusText = '';
            let lcdStatusText = '';
            let lcdTempText = '';
            
            // FIXED: Comprehensive state determination with proper priority
            if (printerState.emergencyStop) {
                statusText = 'PARADA DE EMERGENCIA';
                statusClass = 'font-bold text-red-500';
                connectionStatusText = 'EMERGENCIA';
                lcdStatusText = 'EMERGENCY';
                lcdTempText = 'STOP';
            } else if (!printerState.powered) {
                statusText = 'Apagada';
                statusClass = 'font-bold text-red-500';
                connectionStatusText = 'Desconectada';
                lcdStatusText = 'Offline';
                lcdTempText = 'Power Off';
            } else if (printerState.printing) {
                if (printerState.paused) {
                    statusText = 'Pausada';
                    statusClass = 'font-bold text-yellow-500';
                    connectionStatusText = 'Pausada';
                    lcdStatusText = 'PAUSED';
                    lcdTempText = `E:${printerState.extruderTemp}¬∞C B:${printerState.bedTemp}¬∞C`;
                } else {
                    statusText = 'Imprimiendo';
                    statusClass = 'font-bold text-green-500';
                    connectionStatusText = 'Imprimiendo';
                    lcdStatusText = 'PRINTING';
                    lcdTempText = `E:${printerState.extruderTemp}¬∞C B:${printerState.bedTemp}¬∞C`;
                }
            } else {
                statusText = 'Lista';
                statusClass = 'font-bold text-green-500';
                connectionStatusText = 'Conectada';
                lcdStatusText = 'Ready';
                lcdTempText = `E:${printerState.extruderTemp}¬∞C B:${printerState.bedTemp}¬∞C`;
            }
            
            // FIXED: Update ALL status displays with consistent formatting
            if (printStatus) {
                if (printerState.emergencyStop) {
                    printStatus.innerHTML = '<span class="text-red-700 font-bold animate-pulse">üõë PARADA DE EMERGENCIA</span>';
                } else if (printerState.printing && !printerState.paused) {
                    printStatus.innerHTML = '<span class="text-green-700 font-bold">üñ®Ô∏è Imprimiendo</span>';
                } else if (printerState.paused) {
                    printStatus.innerHTML = '<span class="text-yellow-700 font-bold">‚è∏Ô∏è Pausada</span>';
                } else if (!printerState.powered) {
                    printStatus.innerHTML = '<span class="text-red-700 font-bold">‚ö´ Apagada</span>';
                } else {
                    printStatus.innerHTML = '<span class="text-blue-700 font-bold">üü¢ Lista</span>';
                }
            }
            
            // FIXED: Synchronize all status text elements
            const statusElements = [
                { element: printerStatus, text: statusText, className: statusClass + ' text-lg' },
                { element: modalPrinterStatus, text: statusText, className: statusClass },
                { element: quickStatus, text: statusText, className: statusClass }
            ];
            
            statusElements.forEach(({ element, text, className }) => {
                if (element) {
                    element.textContent = text;
                    element.className = className;
                }
            });
            
            // FIXED: Update connection status with proper state indication
            if (connectionText) {
                connectionText.textContent = connectionStatusText;
            }
            
            // FIXED: Update LCD display with comprehensive state information
            if (lcdContent) {
                const lcdColorClass = printerState.emergencyStop ? 'text-red-400' :
                                    !printerState.powered ? 'text-red-400' :
                                    printerState.printing && !printerState.paused ? 'text-green-400' :
                                    printerState.paused ? 'text-yellow-400' : 'text-blue-400';
                
                lcdContent.innerHTML = `
                    <div class="text-center font-bold ${lcdColorClass}">${lcdStatusText}</div>
                    <div class="text-green-300 text-center text-xs">${lcdTempText}</div>
                `;
            }
            
            // FIXED: Update connection light with proper color coding
            updateConnectionLight();
            
            // FIXED: Update print progress panel visibility
            updatePrintProgressPanel();
            
            console.log('Print Status Sync Complete:', {
                state: printerState,
                statusText: statusText,
                connectionText: connectionStatusText,
                lcdStatus: lcdStatusText
            });
        }
        
        // NEW: Function to update connection light based on current state
        function updateConnectionLight() {
            const connectionLight = document.getElementById('connection-light');
            
            if (connectionLight) {
                if (printerState.emergencyStop) {
                    connectionLight.className = 'w-4 h-4 bg-red-500 rounded-full shadow-inner neon-glow animate-pulse';
                } else if (!printerState.powered) {
                    connectionLight.className = 'w-4 h-4 bg-red-400 rounded-full shadow-inner neon-glow';
                } else if (printerState.printing && !printerState.paused) {
                    connectionLight.className = 'w-4 h-4 bg-green-400 rounded-full shadow-inner neon-glow animate-pulse';
                } else if (printerState.paused) {
                    connectionLight.className = 'w-4 h-4 bg-yellow-400 rounded-full shadow-inner neon-glow';
                } else {
                    connectionLight.className = 'w-4 h-4 bg-green-400 rounded-full shadow-inner neon-glow';
                }
            }
        }
        
        // NEW: Function to update print progress panel visibility and content
        function updatePrintProgressPanel() {
            const printProgressPanel = document.getElementById('print-progress-panel');
            
            if (printProgressPanel) {
                if (printerState.printing) {
                    printProgressPanel.classList.remove('hidden');
                    
                    // Update progress content
                    const currentLayer = document.getElementById('current-layer');
                    const timeRemaining = document.getElementById('time-remaining');
                    const layerProgress = document.getElementById('layer-progress');
                    
                    if (currentLayer) {
                        const layer = printerState.paused ? 'PAUSADO' : '15/50';
                        currentLayer.textContent = layer;
                    }
                    
                    if (timeRemaining) {
                        if (printerState.paused) {
                            timeRemaining.textContent = 'PAUSADO';
                            timeRemaining.className = 'font-bold text-yellow-400';
                        } else {
                            timeRemaining.textContent = '15:30';
                            timeRemaining.className = 'font-bold text-purple-400';
                        }
                    }
                    
                    if (layerProgress) {
                        const progressWidth = printerState.paused ? '30%' : '30%';
                        layerProgress.style.width = progressWidth;
                        
                        if (printerState.paused) {
                            layerProgress.style.animationPlayState = 'paused';
                            layerProgress.style.filter = 'brightness(0.7)';
                        } else {
                            layerProgress.style.animationPlayState = 'running';
                            layerProgress.style.filter = 'brightness(1)';
                        }
                    }
                } else {
                    printProgressPanel.classList.add('hidden');
                }
            }
        }

        // Update all modal elements
        function updateModalElements() {
            // Update temperature displays
            syncModalTemperatures();
            
            // Update position displays
            const modalPosX = document.getElementById('modal-pos-x');
            const modalPosY = document.getElementById('modal-pos-y');
            const modalPosZ = document.getElementById('modal-pos-z');
            
            if (modalPosX) modalPosX.textContent = printerState.position.x + 'mm';
            if (modalPosY) modalPosY.textContent = printerState.position.y + 'mm';
            if (modalPosZ) modalPosZ.textContent = printerState.position.z + 'mm';
            
            // Update status displays
            const modalPrinterStatus = document.getElementById('modal-printer-status');
            const modalFilamentStatus = document.getElementById('modal-filament-status');
            const modalLevelStatus = document.getElementById('modal-level-status');
            
            if (modalPrinterStatus) {
                modalPrinterStatus.textContent = printerState.powered ? 'Encendida' : 'Apagada';
                modalPrinterStatus.className = printerState.powered ? 'font-bold text-green-500' : 'font-bold text-red-500';
            }
            
            if (modalFilamentStatus) {
                modalFilamentStatus.textContent = printerState.filamentLoaded ? 'Cargado' : 'No cargado';
                modalFilamentStatus.className = printerState.filamentLoaded ? 'font-bold text-green-500' : 'font-bold text-gray-500';
            }
            
            if (modalLevelStatus) {
                modalLevelStatus.textContent = printerState.leveled ? 'Completada' : 'Pendiente';
                modalLevelStatus.className = printerState.leveled ? 'font-bold text-green-500' : 'font-bold text-gray-500';
            }
            
            // Update button states
            updateModalButtonStates();
        }

        // Update modal button states
        function updateModalButtonStates() {
            const modalPowerBtn = document.getElementById('modal-power-btn');
            const modalFilamentBtn = document.getElementById('modal-filament-btn');
            const modalLevelBtn = document.getElementById('modal-level-btn');
            const modalPrintBtn = document.getElementById('modal-print-btn');
            const modalPauseBtn = document.getElementById('modal-pause-btn');
            
            // Power button
            if (modalPowerBtn) {
                if (printerState.powered) {
                    modalPowerBtn.textContent = 'üîå Apagar';
                    modalPowerBtn.className = 'interactive-btn w-full bg-red-500 hover:bg-red-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                } else {
                    modalPowerBtn.textContent = 'üîå Encender';
                    modalPowerBtn.className = 'interactive-btn w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                }
            }
            
            // Other buttons - enable/disable based on power state with proper class management
            const buttonsConfig = [
                { 
                    btn: modalFilamentBtn, 
                    enabled: printerState.powered,
                    enabledClass: 'interactive-btn w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all',
                    disabledClass: 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed'
                },
                { 
                    btn: modalLevelBtn, 
                    enabled: printerState.powered,
                    enabledClass: 'interactive-btn w-full bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all',
                    disabledClass: 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed'
                },
                { 
                    btn: modalPrintBtn, 
                    enabled: printerState.powered && printerState.filamentLoaded && printerState.leveled,
                    enabledClass: 'interactive-btn w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all',
                    disabledClass: 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed'
                },
                { 
                    btn: modalPauseBtn, 
                    enabled: printerState.printing,
                    enabledClass: 'interactive-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all',
                    disabledClass: 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed'
                }
            ];
            
            buttonsConfig.forEach(({ btn, enabled, enabledClass, disabledClass }) => {
                if (btn) {
                    btn.disabled = !enabled;
                    btn.className = enabled ? enabledClass : disabledClass;
                }
            });
        }

        // FIXED: Comprehensive button state management across all interfaces
        function updateAllButtonStates() {
            // FIXED: Power buttons with proper state management
            updatePowerButtons();
            
            // FIXED: Filament buttons with dependency checking
            updateFilamentButtons();
            
            // FIXED: Level buttons with dependency checking
            updateLevelButtons();
            
            // FIXED: Print buttons with comprehensive requirements checking
            updatePrintButtons();
            
            // FIXED: Pause/Resume buttons with proper state transitions
            updatePauseResumeButtons();
            
            console.log('All Button States Updated:', {
                powered: printerState.powered,
                filamentLoaded: printerState.filamentLoaded,
                leveled: printerState.leveled,
                printing: printerState.printing,
                paused: printerState.paused,
                emergencyStop: printerState.emergencyStop
            });
        }
        
        // NEW: Dedicated power button update function
        function updatePowerButtons() {
            const powerBtn = document.getElementById('power-btn');
            const modalPowerBtn = document.getElementById('modal-power-btn');
            
            const buttons = [powerBtn, modalPowerBtn];
            
            buttons.forEach(btn => {
                if (btn) {
                    if (printerState.emergencyStop) {
                        btn.disabled = true;
                        btn.textContent = 'üîå Bloqueado';
                        btn.className = 'interactive-btn w-full bg-gray-400 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed';
                    } else if (printerState.powered) {
                        btn.disabled = false;
                        btn.textContent = 'üîå Apagar';
                        btn.className = 'interactive-btn w-full bg-red-500 hover:bg-red-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                        btn.onclick = () => togglePower();
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'üîå Encender';
                        btn.className = 'interactive-btn w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                        btn.onclick = () => togglePower();
                    }
                }
            });
        }
        
        // NEW: Dedicated filament button update function
        function updateFilamentButtons() {
            const filamentBtn = document.getElementById('filament-btn');
            const modalFilamentBtn = document.getElementById('modal-filament-btn');
            const unloadBtn = document.getElementById('unload-btn');
            const modalUnloadBtn = document.getElementById('modal-unload-btn');
            const validateBtn = document.getElementById('validate-btn');
            const modalValidateBtn = document.getElementById('modal-validate-btn');
            
            const loadButtons = [filamentBtn, modalFilamentBtn];
            const unloadButtons = [unloadBtn, modalUnloadBtn];
            const validateButtons = [validateBtn, modalValidateBtn];
            
            const canLoadFilament = printerState.powered && !printerState.emergencyStop;
            const canUnloadFilament = printerState.powered && !printerState.emergencyStop && printerState.filamentLoaded;
            const canValidate = printerState.powered && !printerState.emergencyStop;
            
            // PASO 3: Actualizar botones de carga
            loadButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = !canLoadFilament;
                    
                    if (canLoadFilament) {
                        if (printerState.filamentLoaded) {
                            btn.textContent = 'üßµ Filamento Cargado ‚úì';
                            btn.className = 'interactive-btn w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                        } else {
                            btn.textContent = 'üßµ Cargar Filamento';
                            btn.className = 'interactive-btn w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                        }
                        btn.onclick = () => loadFilament();
                    } else {
                        btn.textContent = 'üßµ Cargar Filamento';
                        btn.className = 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed';
                        btn.onclick = null;
                    }
                }
            });
            
            // PASO 3: Actualizar botones de descarga
            unloadButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = !canUnloadFilament;
                    
                    if (canUnloadFilament) {
                        btn.textContent = 'üîÑ Descargar Filamento';
                        btn.className = 'interactive-btn w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                        btn.onclick = () => unloadFilament();
                    } else {
                        btn.textContent = 'üîÑ Descargar Filamento';
                        btn.className = 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed';
                        btn.onclick = null;
                    }
                }
            });
            
            // PASO 3: Actualizar botones de validaci√≥n
            validateButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = !canValidate;
                    
                    if (canValidate) {
                        btn.textContent = '‚úÖ Validar Configuraci√≥n';
                        btn.className = 'interactive-btn w-full bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                        btn.onclick = () => showConfigurationValidation();
                    } else {
                        btn.textContent = '‚úÖ Validar Configuraci√≥n';
                        btn.className = 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed';
                        btn.onclick = null;
                    }
                }
            });
            
            // PASO 4: Actualizar botones de monitoreo avanzado
            updateAdvancedMonitoringButtons();
        }
        
        // PASO 4: Funci√≥n para actualizar botones de monitoreo avanzado
        function updateAdvancedMonitoringButtons() {
            // Botones de optimizaci√≥n
            const optimizeBtn = document.getElementById('optimize-btn');
            const modalOptimizeBtn = document.getElementById('modal-optimize-btn');
            
            // Botones de calibraci√≥n
            const calibrateBtn = document.getElementById('calibrate-btn');
            const modalCalibrateBtn = document.getElementById('modal-calibrate-btn');
            
            // Botones de mantenimiento
            const maintenanceBtn = document.getElementById('maintenance-btn');
            const modalMaintenanceBtn = document.getElementById('modal-maintenance-btn');
            
            // Botones de reporte
            const reportBtn = document.getElementById('report-btn');
            const modalReportBtn = document.getElementById('modal-report-btn');
            
            const canOptimize = printerState.powered && printerState.printing && !printerState.emergencyStop;
            const canCalibrate = printerState.powered && !printerState.printing && !printerState.emergencyStop;
            const canMaintenance = printerState.powered && !printerState.emergencyStop;
            const canReport = printerState.powered && (printerState.printing || printerState.printCompleted) && !printerState.emergencyStop;
            
            // Actualizar botones de optimizaci√≥n
            [optimizeBtn, modalOptimizeBtn].forEach(btn => {
                if (btn) {
                    btn.disabled = !canOptimize;
                    if (canOptimize) {
                        btn.className = btn.className.replace('bg-gray-300 text-gray-600', 'bg-indigo-500 hover:bg-indigo-600 text-white').replace('cursor-not-allowed', '');
                        btn.onclick = () => autoOptimizePrintSettings();
                    } else {
                        btn.className = btn.className.replace('bg-indigo-500 hover:bg-indigo-600 text-white', 'bg-gray-300 text-gray-600').replace('transition-all', 'cursor-not-allowed');
                        btn.onclick = null;
                    }
                }
            });
            
            // Actualizar botones de calibraci√≥n
            [calibrateBtn, modalCalibrateBtn].forEach(btn => {
                if (btn) {
                    btn.disabled = !canCalibrate;
                    if (canCalibrate) {
                        btn.className = btn.className.replace('bg-gray-300 text-gray-600', 'bg-teal-500 hover:bg-teal-600 text-white').replace('cursor-not-allowed', '');
                        btn.onclick = () => autoCalibrateMechanics();
                    } else {
                        btn.className = btn.className.replace('bg-teal-500 hover:bg-teal-600 text-white', 'bg-gray-300 text-gray-600').replace('transition-all', 'cursor-not-allowed');
                        btn.onclick = null;
                    }
                }
            });
            
            // Actualizar botones de mantenimiento
            [maintenanceBtn, modalMaintenanceBtn].forEach(btn => {
                if (btn) {
                    btn.disabled = !canMaintenance;
                    if (canMaintenance) {
                        btn.className = btn.className.replace('bg-gray-300 text-gray-600', 'bg-amber-500 hover:bg-amber-600 text-white').replace('cursor-not-allowed', '');
                        btn.onclick = () => performMaintenanceCheck();
                    } else {
                        btn.className = btn.className.replace('bg-amber-500 hover:bg-amber-600 text-white', 'bg-gray-300 text-gray-600').replace('transition-all', 'cursor-not-allowed');
                        btn.onclick = null;
                    }
                }
            });
            
            // Actualizar botones de reporte
            [reportBtn, modalReportBtn].forEach(btn => {
                if (btn) {
                    btn.disabled = !canReport;
                    if (canReport) {
                        btn.className = btn.className.replace('bg-gray-300 text-gray-600', 'bg-cyan-500 hover:bg-cyan-600 text-white').replace('cursor-not-allowed', '');
                        btn.onclick = () => generatePrintReport();
                    } else {
                        btn.className = btn.className.replace('bg-cyan-500 hover:bg-cyan-600 text-white', 'bg-gray-300 text-gray-600').replace('transition-all', 'cursor-not-allowed');
                        btn.onclick = null;
                    }
                }
            });
        }
        
        // NEW: Dedicated level button update function
        function updateLevelButtons() {
            const levelBtn = document.getElementById('level-btn');
            const modalLevelBtn = document.getElementById('modal-level-btn');
            
            const buttons = [levelBtn, modalLevelBtn];
            const canLevel = printerState.powered && !printerState.emergencyStop && !printerState.printing;
            
            buttons.forEach(btn => {
                if (btn) {
                    btn.disabled = !canLevel;
                    
                    if (canLevel) {
                        if (printerState.leveled) {
                            btn.textContent = 'üìê Nivelaci√≥n Completa ‚úì';
                            btn.className = 'interactive-btn w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                        } else {
                            btn.textContent = 'üìê Auto Nivelaci√≥n';
                            btn.className = 'interactive-btn w-full bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                        }
                        btn.onclick = () => autoLevel();
                    } else {
                        btn.textContent = 'üìê Auto Nivelaci√≥n';
                        btn.className = 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed';
                        btn.onclick = null;
                    }
                }
            });
        }
        
        // NEW: Dedicated print button update function
        function updatePrintButtons() {
            const printBtn = document.getElementById('print-btn');
            const modalPrintBtn = document.getElementById('modal-print-btn');
            
            const buttons = [printBtn, modalPrintBtn];
            const canPrint = printerState.powered && 
                           printerState.filamentLoaded && 
                           printerState.leveled && 
                           !printerState.printing && 
                           !printerState.emergencyStop;
            
            buttons.forEach(btn => {
                if (btn) {
                    btn.disabled = !canPrint;
                    
                    if (canPrint) {
                        btn.textContent = 'üñ®Ô∏è Iniciar Impresi√≥n';
                        btn.className = 'interactive-btn w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                        btn.onclick = () => startPrint();
                    } else {
                        let reasonText = 'üñ®Ô∏è Iniciar Impresi√≥n';
                        
                        if (!printerState.powered) {
                            reasonText = 'üñ®Ô∏è Requiere Encender';
                        } else if (!printerState.filamentLoaded) {
                            reasonText = 'üñ®Ô∏è Requiere Filamento';
                        } else if (!printerState.leveled) {
                            reasonText = 'üñ®Ô∏è Requiere Nivelaci√≥n';
                        } else if (printerState.printing) {
                            reasonText = 'üñ®Ô∏è Ya Imprimiendo';
                        } else if (printerState.emergencyStop) {
                            reasonText = 'üñ®Ô∏è Bloqueado';
                        }
                        
                        btn.textContent = reasonText;
                        btn.className = 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed';
                        btn.onclick = null;
                    }
                }
            });
        }

        // Manual control functions
        function togglePower() {
            if (printerState.emergencyStop) {
                showNotification('Desactiva la parada de emergencia primero', 'error');
                return;
            }

            printerState.powered = !printerState.powered;
            const connectionLight = document.getElementById('connection-light');
            const connectionText = document.getElementById('connection-text');
            const printerStatus = document.getElementById('printer-status');
            const modalPrinterStatus = document.getElementById('modal-printer-status');
            const powerLed = document.getElementById('power-led');
            const psuIndicator = document.getElementById('psu-indicator');
            
            if (printerState.powered) {
                // Update status displays
                if (connectionLight) connectionLight.className = 'w-4 h-4 bg-green-400 rounded-full shadow-inner neon-glow';
                if (connectionText) connectionText.textContent = 'Conectada';
                if (printerStatus) {
                    printerStatus.textContent = 'Encendida';
                    printerStatus.className = 'font-bold text-green-400 text-lg';
                }
                if (modalPrinterStatus) {
                    modalPrinterStatus.textContent = 'Encendida';
                    modalPrinterStatus.className = 'font-bold text-green-500';
                }
                
                // Update LEDs
                if (powerLed) powerLed.style.opacity = '1';
                if (psuIndicator) {
                    psuIndicator.style.opacity = '1';
                    psuIndicator.className = 'w-2 h-2 bg-green-500 rounded-full mt-1 ml-1 transition-all';
                }
                
                // Update quick status
                const quickStatus = document.getElementById('quick-status');
                if (quickStatus) {
                    quickStatus.textContent = 'Encendida';
                    quickStatus.className = 'font-bold text-green-500';
                }
                
                // Use centralized fan animation sync
                syncFanAnimations();
                
                // Sync views
                syncViewStates();
                
                showNotification('Impresora encendida correctamente', 'success');
            } else {
                // Update status displays
                if (connectionLight) connectionLight.className = 'w-4 h-4 bg-red-400 rounded-full shadow-inner neon-glow';
                if (connectionText) connectionText.textContent = 'Desconectada';
                if (printerStatus) {
                    printerStatus.textContent = 'Apagada';
                    printerStatus.className = 'font-bold text-red-400 text-lg';
                }
                if (modalPrinterStatus) {
                    modalPrinterStatus.textContent = 'Apagada';
                    modalPrinterStatus.className = 'font-bold text-red-500';
                }
                
                // Update LEDs
                if (powerLed) powerLed.style.opacity = '0';
                if (psuIndicator) {
                    psuIndicator.style.opacity = '0';
                    psuIndicator.className = 'w-2 h-2 bg-red-500 rounded-full mt-1 ml-1 opacity-0 transition-all';
                }
                
                // Update quick status
                const quickStatus = document.getElementById('quick-status');
                if (quickStatus) {
                    quickStatus.textContent = 'Apagada';
                    quickStatus.className = 'font-bold text-red-500';
                }
                
                // Reset temperatures when powered off
                printerState.extruderTemp = 25;
                printerState.bedTemp = 25;
                updateAllTemperatureDisplays();
                
                // Reset printing state when powered off
                printerState.printing = false;
                printerState.paused = false;
                
                // Use centralized fan animation sync
                syncFanAnimations();
                
                // Sync views
                syncViewStates();
                
                showNotification('Impresora apagada', 'info');
            }
            
            // Sync all interface elements
            syncPrintStatus();
            updateAllButtonStates();
            updateModalElements();
            updateLCDDisplay();
            
            // Sync all LEDs to reflect new state
            syncAllLEDs();
        }

        function loadFilament() {
            // PASO 3: Usar sistema avanzado de carga de filamento
            return advancedLoadFilament();
        }

        function autoLevel() {
            if (!printerState.powered) {
                showNotification('Enciende la impresora primero', 'warning');
                return;
            }
            
            showNotification('üîÑ Iniciando auto-nivelaci√≥n - Moviendo extrusor...', 'info');
            
            // FIXED: Simulate realistic leveling process with extruder movement
            const levelingPoints = [
                { x: 20, y: 20, z: 5 },   // Punto 1: Esquina frontal izquierda
                { x: 100, y: 20, z: 5 },  // Punto 2: Centro frontal
                { x: 180, y: 20, z: 5 },  // Punto 3: Esquina frontal derecha
                { x: 20, y: 100, z: 5 },  // Punto 4: Centro izquierdo
                { x: 100, y: 100, z: 5 }, // Punto 5: Centro absoluto
                { x: 180, y: 100, z: 5 }, // Punto 6: Centro derecho
                { x: 20, y: 180, z: 5 },  // Punto 7: Esquina trasera izquierda
                { x: 100, y: 180, z: 5 }, // Punto 8: Centro trasero
                { x: 180, y: 180, z: 5 }  // Punto 9: Esquina trasera derecha
            ];
            
            let currentPoint = 0;
            
            // Funci√≥n para mover a cada punto de nivelaci√≥n
            function moveToLevelingPoint() {
                if (currentPoint < levelingPoints.length) {
                    const point = levelingPoints[currentPoint];
                    
                    // Actualizar posici√≥n del extrusor
                    printerState.position.x = point.x;
                    printerState.position.y = point.y;
                    printerState.position.z = point.z;
                    
                    // Actualizar displays de posici√≥n
                    updateAllPositionDisplays();
                    
                    // Animar movimiento del extrusor
                    updateExtruderPosition();
                    
                    // Mostrar progreso de nivelaci√≥n
                    const progress = Math.round(((currentPoint + 1) / levelingPoints.length) * 100);
                    showNotification(`üìê Nivelando punto ${currentPoint + 1}/9 (${progress}%) - X:${point.x} Y:${point.y}`, 'info');
                    
                    // Efecto visual de medici√≥n en el punto actual
                    showLevelingMeasurement(point);
                    
                    currentPoint++;
                    
                    // Continuar al siguiente punto despu√©s de 1.5 segundos
                    setTimeout(moveToLevelingPoint, 1500);
                } else {
                    // Nivelaci√≥n completada - regresar al centro
                    completeLeveling();
                }
            }
            
            // Funci√≥n para completar la nivelaci√≥n
            function completeLeveling() {
                // Mover extrusor al centro y altura segura
                printerState.position.x = 100;
                printerState.position.y = 100;
                printerState.position.z = 50;
                
                updateAllPositionDisplays();
                updateExtruderPosition();
                
                // Marcar como nivelado
                printerState.leveled = true;
                
                // Update level status displays
                const levelStatus = document.getElementById('quick-level-status');
                const modalLevelStatus = document.getElementById('modal-level-status');
                
                if (levelStatus) {
                    levelStatus.textContent = 'Completada';
                    levelStatus.className = 'font-bold text-green-500';
                }
                
                if (modalLevelStatus) {
                    modalLevelStatus.textContent = 'Completada';
                    modalLevelStatus.className = 'font-bold text-green-500';
                }
                
                updateModalElements();
                updateAllButtonStates();
                
                showNotification('‚úÖ Auto-nivelaci√≥n completada exitosamente - Malla de 9 puntos generada', 'success');
                
                // Mark checklist items if in guided mode
                if (simulatorMode === 'guided' && currentStep === 3) {
                    markChecklistItem('start-leveling', true);
                    markChecklistItem('verify-mesh', true);
                    markChecklistItem('confirm-level', true);
                    updateSimulatorStep();
                    checkStepCompletion();
                }
                
                // Mostrar informaci√≥n adicional despu√©s de completar
                setTimeout(() => {
                    showNotification('üìä Malla de nivelaci√≥n guardada - Primera capa optimizada', 'info');
                }, 2000);
            }
            
            // Funci√≥n para mostrar efecto visual de medici√≥n
            function showLevelingMeasurement(point) {
                const extruder = document.getElementById('extruder');
                if (extruder) {
                    // Efecto de medici√≥n con pulso azul
                    extruder.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.8), 0 0 40px rgba(59, 130, 246, 0.4)';
                    extruder.style.transform += ' scale(1.1)';
                    
                    setTimeout(() => {
                        extruder.style.boxShadow = '';
                        extruder.style.transform = extruder.style.transform.replace(' scale(1.1)', '');
                    }, 800);
                }
            }
            
            // Funci√≥n para actualizar todos los displays de posici√≥n
            function updateAllPositionDisplays() {
                const posX = document.getElementById('pos-x');
                const posY = document.getElementById('pos-y');
                const posZ = document.getElementById('pos-z');
                const modalPosX = document.getElementById('modal-pos-x');
                const modalPosY = document.getElementById('modal-pos-y');
                const modalPosZ = document.getElementById('modal-pos-z');
                
                if (posX) posX.textContent = printerState.position.x + 'mm';
                if (posY) posY.textContent = printerState.position.y + 'mm';
                if (posZ) posZ.textContent = printerState.position.z + 'mm';
                if (modalPosX) modalPosX.textContent = printerState.position.x + 'mm';
                if (modalPosY) modalPosY.textContent = printerState.position.y + 'mm';
                if (modalPosZ) modalPosZ.textContent = printerState.position.z + 'mm';
            }
            
            // Iniciar el proceso de nivelaci√≥n
            moveToLevelingPoint();
        }

        function startPrint() {
            if (!printerState.powered) {
                showNotification('Enciende la impresora primero', 'warning');
                return;
            }
            
            // PASO 3: Validaci√≥n completa de configuraci√≥n antes de imprimir
            const canPrint = showConfigurationValidation();
            if (!canPrint) {
                showNotification('‚ùå Corrige los errores antes de imprimir', 'error');
                return;
            }
            
            if (!printerState.filamentLoaded) {
                showNotification('Carga el filamento primero', 'warning');
                return;
            }
            
            if (!printerState.leveled) {
                showNotification('Realiza la auto-nivelaci√≥n primero', 'warning');
                return;
            }
            
            // Inicializar estado de impresi√≥n
            printerState.printing = true;
            printerState.paused = false;
            printerState.printCompleted = false;
            printerState.printProgress = 0;
            printerState.currentLayer = 1;
            printProgress = 0;
            currentLayer = 1;
            printStartTime = Date.now();
            
            // Iniciar simulaci√≥n de impresi√≥n con progreso real
            startPrintingSimulation();
            
            // Sync all print status displays across the interface
            syncPrintStatus();
            
            // Show print object growing
            const printObject = document.getElementById('print-object');
            if (printObject) {
                printObject.style.opacity = '1';
                printObject.style.height = '5px'; // Empezar peque√±o
                printObject.style.transition = 'height 1s ease-in-out';
            }
            
            // Show filament extrusion
            const filamentExtrusion = document.getElementById('filament-extrusion');
            if (filamentExtrusion) {
                filamentExtrusion.style.opacity = '1';
            }
            
            // Start extruder animation
            const extruder = document.getElementById('extruder');
            if (extruder) {
                extruder.classList.add('extruder');
            }
            
            // Use centralized fan animation sync
            syncFanAnimations();
            
            // Update all interface elements
            updateAllButtonStates();
            updateModalElements();
            updateLCDDisplay();
            
            // Sync all LEDs across the interface
            syncAllLEDs();
            
            showNotification('üñ®Ô∏è Impresi√≥n iniciada - Simulando 50 capas en 30 segundos', 'success');
            
            // Mark checklist items if in guided mode
            if (simulatorMode === 'guided' && currentStep === 4) {
                markChecklistItem('start-printing', true);
                setTimeout(() => {
                    markChecklistItem('monitor-layer', true);
                    updateSimulatorStep();
                    checkStepCompletion();
                }, 2000);
            }
        }

        // NUEVA: Funci√≥n principal de simulaci√≥n de impresi√≥n con progreso real
        function startPrintingSimulation() {
            // Limpiar timer anterior si existe
            if (printingTimer) {
                clearInterval(printingTimer);
            }
            
            const updateInterval = 600; // Actualizar cada 600ms para suavidad
            const layerTime = estimatedPrintTime / totalLayers; // Tiempo por capa
            
            printingTimer = setInterval(() => {
                // Verificar si la impresi√≥n est√° pausada o detenida
                if (!printerState.printing || printerState.emergencyStop) {
                    clearInterval(printingTimer);
                    printingTimer = null;
                    return;
                }
                
                // Si est√° pausada, no actualizar progreso pero mantener timer
                if (printerState.paused) {
                    return;
                }
                
                // Calcular progreso basado en tiempo transcurrido
                const elapsedTime = Date.now() - printStartTime;
                const newProgress = Math.min((elapsedTime / estimatedPrintTime) * 100, 100);
                const newLayer = Math.min(Math.floor((elapsedTime / layerTime)) + 1, totalLayers);
                
                // Actualizar estado global
                printProgress = newProgress;
                currentLayer = newLayer;
                printerState.printProgress = newProgress;
                printerState.currentLayer = newLayer;
                printerState.timeRemaining = Math.max(0, estimatedPrintTime - elapsedTime);
                
                // Actualizar visualizaci√≥n del objeto impreso
                updatePrintObjectGrowth(newProgress);
                
                // Actualizar displays de progreso
                updatePrintProgressDisplays();
                
                // Simular movimiento del extrusor durante impresi√≥n
                simulateExtruderMovement();
                
                // Verificar si la impresi√≥n est√° completa
                if (newProgress >= 100) {
                    completePrint();
                }
                
            }, updateInterval);
        }
        
        // NUEVA: Funci√≥n para actualizar el crecimiento del objeto impreso
        function updatePrintObjectGrowth(progress) {
            const printObject = document.getElementById('print-object');
            if (printObject) {
                // Crecimiento progresivo del objeto (de 5px a 60px)
                const maxHeight = 60;
                const minHeight = 5;
                const currentHeight = minHeight + ((maxHeight - minHeight) * (progress / 100));
                
                printObject.style.height = currentHeight + 'px';
                
                // Cambiar colores por capas para efecto visual
                const hue = (progress / 100) * 60; // De azul (240) a cian (180) a verde (120)
                printObject.style.filter = `hue-rotate(${hue}deg) brightness(${1 + (progress / 200)})`;
            }
        }
        
        // NUEVA: Funci√≥n para actualizar todos los displays de progreso
        function updatePrintProgressDisplays() {
            // Actualizar progreso principal
            const printProgressText = document.getElementById('print-progress-text');
            if (printProgressText) {
                printProgressText.textContent = Math.round(printProgress) + '%';
            }
            
            // Actualizar panel de progreso de impresi√≥n
            const currentLayerDisplay = document.getElementById('current-layer');
            const timeRemainingDisplay = document.getElementById('time-remaining');
            const layerProgressBar = document.getElementById('layer-progress');
            
            if (currentLayerDisplay) {
                currentLayerDisplay.textContent = `${currentLayer}/${totalLayers}`;
            }
            
            if (timeRemainingDisplay) {
                const minutes = Math.floor(printerState.timeRemaining / 60000);
                const seconds = Math.floor((printerState.timeRemaining % 60000) / 1000);
                timeRemainingDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            if (layerProgressBar) {
                layerProgressBar.style.width = printProgress + '%';
            }
            
            // Actualizar LCD con informaci√≥n de progreso
            updateLCDWithProgress();
        }
        
        // NUEVA: Funci√≥n para simular movimiento realista del extrusor durante impresi√≥n
        function simulateExtruderMovement() {
            // Simular patrones de movimiento t√≠picos de impresi√≥n 3D
            const time = Date.now() / 1000;
            const baseX = 50 + Math.sin(time * 0.5) * 30; // Movimiento sinusoidal en X
            const baseY = 50 + Math.cos(time * 0.3) * 25; // Movimiento en Y
            const baseZ = Math.min(currentLayer * 0.2, 40); // Z aumenta con las capas
            
            // Actualizar posici√≥n del extrusor
            printerState.position.x = Math.round(baseX);
            printerState.position.y = Math.round(baseY);
            printerState.position.z = Math.round(baseZ);
            
            // Actualizar displays de posici√≥n
            updateAllPositionDisplays();
            
            // Actualizar posici√≥n visual del extrusor
            updateExtruderPosition();
        }
        
        // NUEVA: Funci√≥n para actualizar LCD con informaci√≥n de progreso
        function updateLCDWithProgress() {
            const lcdContent = document.getElementById('lcd-content');
            if (lcdContent && printerState.printing && !printerState.paused) {
                lcdContent.innerHTML = `
                    <div class="text-center font-bold text-green-400">PRINTING ${Math.round(printProgress)}%</div>
                    <div class="text-green-300 text-center text-xs">Layer ${currentLayer}/${totalLayers}</div>
                `;
            }
        }
        
        // NUEVA: Funci√≥n para completar la impresi√≥n
        function completePrint() {
            // Limpiar timer
            if (printingTimer) {
                clearInterval(printingTimer);
                printingTimer = null;
            }
            
            // Actualizar estado
            printerState.printing = false;
            printerState.paused = false;
            printerState.printCompleted = true;
            printerState.printProgress = 100;
            printerState.currentLayer = totalLayers;
            printerState.timeRemaining = 0;
            
            // Detener animaciones
            const extruder = document.getElementById('extruder');
            const filamentExtrusion = document.getElementById('filament-extrusion');
            
            if (extruder) {
                extruder.classList.remove('extruder');
            }
            
            if (filamentExtrusion) {
                filamentExtrusion.style.opacity = '0';
            }
            
            // Mover extruder a posici√≥n final segura
            printerState.position = { x: 0, y: 0, z: 50 };
            updateAllPositionDisplays();
            updateExtruderPosition();
            
            // Sincronizar toda la interfaz
            syncCompleteInterface();
            
            // Notificaciones de finalizaci√≥n
            showNotification('üéâ ¬°Impresi√≥n completada exitosamente!', 'success');
            
            setTimeout(() => {
                showNotification('üì¶ Objeto listo para retirar de la cama', 'info');
            }, 2000);
            
            setTimeout(() => {
                showNotification('üîÑ Puedes iniciar una nueva impresi√≥n cuando desees', 'info');
            }, 4000);
            
            // Actualizar LCD final
            const lcdContent = document.getElementById('lcd-content');
            if (lcdContent) {
                lcdContent.innerHTML = `
                    <div class="text-center font-bold text-green-400">COMPLETED</div>
                    <div class="text-green-300 text-center text-xs">Print Finished</div>
                `;
            }
        }
        
        // NUEVA: Funci√≥n auxiliar para actualizar displays de posici√≥n
        function updateAllPositionDisplays() {
            const posX = document.getElementById('pos-x');
            const posY = document.getElementById('pos-y');
            const posZ = document.getElementById('pos-z');
            const modalPosX = document.getElementById('modal-pos-x');
            const modalPosY = document.getElementById('modal-pos-y');
            const modalPosZ = document.getElementById('modal-pos-z');
            
            if (posX) posX.textContent = printerState.position.x + 'mm';
            if (posY) posY.textContent = printerState.position.y + 'mm';
            if (posZ) posZ.textContent = printerState.position.z + 'mm';
            if (modalPosX) modalPosX.textContent = printerState.position.x + 'mm';
            if (modalPosY) modalPosY.textContent = printerState.position.y + 'mm';
            if (modalPosZ) modalPosZ.textContent = printerState.position.z + 'mm';
        }

        // FIXED: Complete pause/resume functionality with proper state management
        function pausePrint() {
            if (!printerState.printing) {
                showNotification('No hay impresi√≥n en curso para pausar', 'warning');
                return;
            }
            
            // Toggle pause state
            printerState.paused = !printerState.paused;
            
            if (printerState.paused) {
                // PAUSE: Ajustar tiempo de inicio para compensar pausa
                const elapsedTime = Date.now() - printStartTime;
                printerState.pausedElapsedTime = elapsedTime;
                
                // PAUSE: Stop all animations and visual effects
                pauseAllAnimations();
                pauseVisualEffects();
                pauseProgressIndicators();
                
                showNotification('‚è∏Ô∏è Impresi√≥n pausada - Todos los sistemas en espera', 'warning');
            } else {
                // RESUME: Ajustar tiempo de inicio para continuar desde donde se paus√≥
                if (printerState.pausedElapsedTime) {
                    printStartTime = Date.now() - printerState.pausedElapsedTime;
                }
                
                // RESUME: Restore all animations and visual effects
                resumeAllAnimations();
                resumeVisualEffects();
                resumeProgressIndicators();
                
                showNotification('‚ñ∂Ô∏è Impresi√≥n reanudada - Sistemas activos', 'success');
            }
            
            // FIXED: Complete interface synchronization with proper button updates
            syncCompleteInterface();
            
            // FIXED: Update pause/resume button text and state immediately
            updatePauseResumeButtons();
            
            console.log('Pause/Resume Action:', {
                printing: printerState.printing,
                paused: printerState.paused,
                action: printerState.paused ? 'PAUSED' : 'RESUMED'
            });
        }
        
        // NEW: Function to update pause/resume button states across all interfaces
        function updatePauseResumeButtons() {
            const pauseBtn = document.getElementById('pause-btn');
            const modalPauseBtn = document.getElementById('modal-pause-btn');
            
            const buttons = [pauseBtn, modalPauseBtn];
            
            buttons.forEach(btn => {
                if (btn) {
                    if (printerState.printing) {
                        btn.disabled = false;
                        
                        if (printerState.paused) {
                            // Show RESUME button
                            btn.textContent = '‚ñ∂Ô∏è Reanudar';
                            btn.className = 'interactive-btn w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                            btn.onclick = () => pausePrint(); // Resume action
                        } else {
                            // Show PAUSE button
                            btn.textContent = '‚è∏Ô∏è Pausar';
                            btn.className = 'interactive-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-xl font-bold shadow-lg transition-all';
                            btn.onclick = () => pausePrint(); // Pause action
                        }
                    } else {
                        // Disabled when not printing
                        btn.disabled = true;
                        btn.textContent = '‚è∏Ô∏è Pausar';
                        btn.className = 'interactive-btn w-full bg-gray-300 text-gray-600 p-3 rounded-xl font-bold shadow-lg cursor-not-allowed';
                        btn.onclick = null;
                    }
                }
            });
        }
        
        // Funci√≥n para pausar todas las animaciones
        function pauseAllAnimations() {
            // Detener animaci√≥n del extrusor
            const extruder = document.getElementById('extruder');
            if (extruder) {
                extruder.classList.remove('extruder');
                extruder.style.transform = 'scale(1)';
            }
            
            // Use centralized fan animation sync (will handle pause state)
            syncFanAnimations();
        }
        
        // Funci√≥n para pausar efectos visuales
        function pauseVisualEffects() {
            // Detener extrusi√≥n de filamento
            const filamentExtrusion = document.getElementById('filament-extrusion');
            if (filamentExtrusion) {
                filamentExtrusion.style.opacity = '0';
                filamentExtrusion.classList.remove('filament-flow');
            }
            
            // Pausar crecimiento del objeto impreso
            const printObject = document.getElementById('print-object');
            if (printObject) {
                printObject.style.animationPlayState = 'paused';
                printObject.style.filter = 'brightness(0.7) saturate(0.5)';
            }
            
            // Cambiar indicadores de calor a modo pausado
            const extruderHeatIndicator = document.getElementById('extruder-heat-indicator');
            const bedHeatIndicator = document.getElementById('bed-heat-indicator');
            
            if (extruderHeatIndicator && printerState.extruderTemp > 50) {
                extruderHeatIndicator.style.animation = 'pulse 2s ease-in-out infinite alternate';
                extruderHeatIndicator.style.filter = 'hue-rotate(60deg)'; // Cambiar a amarillo
            }
            
            if (bedHeatIndicator && printerState.bedTemp > 40) {
                bedHeatIndicator.style.animation = 'pulse 2s ease-in-out infinite alternate';
                bedHeatIndicator.style.filter = 'hue-rotate(60deg)'; // Cambiar a amarillo
            }
        }
        
        // Funci√≥n para pausar indicadores de progreso
        function pauseProgressIndicators() {
            // Pausar barra de progreso
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.animationPlayState = 'paused';
                progressBar.style.filter = 'brightness(0.8)';
            }
            
            // Actualizar panel de progreso de impresi√≥n
            const printProgressPanel = document.getElementById('print-progress-panel');
            if (printProgressPanel && !printProgressPanel.classList.contains('hidden')) {
                const timeRemaining = document.getElementById('time-remaining');
                if (timeRemaining) {
                    timeRemaining.textContent = 'PAUSADO';
                    timeRemaining.className = 'font-bold text-yellow-400';
                }
            }
        }
        
        // Funci√≥n para reanudar todas las animaciones
        function resumeAllAnimations() {
            // Reanudar animaci√≥n del extrusor
            const extruder = document.getElementById('extruder');
            if (extruder) {
                extruder.classList.add('extruder');
            }
            
            // Use centralized fan animation sync (will handle resume state)
            syncFanAnimations();
        }
        
        // Funci√≥n para reanudar efectos visuales
        function resumeVisualEffects() {
            // Reanudar extrusi√≥n de filamento
            const filamentExtrusion = document.getElementById('filament-extrusion');
            if (filamentExtrusion) {
                filamentExtrusion.style.opacity = '1';
                filamentExtrusion.classList.add('filament-flow');
            }
            
            // Reanudar crecimiento del objeto impreso
            const printObject = document.getElementById('print-object');
            if (printObject) {
                printObject.style.animationPlayState = 'running';
                printObject.style.filter = 'brightness(1) saturate(1)';
            }
            
            // Restaurar indicadores de calor normales
            const extruderHeatIndicator = document.getElementById('extruder-heat-indicator');
            const bedHeatIndicator = document.getElementById('bed-heat-indicator');
            
            if (extruderHeatIndicator && printerState.extruderTemp > 50) {
                extruderHeatIndicator.style.animation = 'pulse 1s ease-in-out infinite alternate';
                extruderHeatIndicator.style.filter = 'brightness(1)'; // Restaurar color original
            }
            
            if (bedHeatIndicator && printerState.bedTemp > 40) {
                bedHeatIndicator.style.animation = 'pulse 1s ease-in-out infinite alternate';
                bedHeatIndicator.style.filter = 'brightness(1)'; // Restaurar color original
            }
        }
        
        // Funci√≥n para reanudar indicadores de progreso
        function resumeProgressIndicators() {
            // Reanudar barra de progreso
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.animationPlayState = 'running';
                progressBar.style.filter = 'brightness(1)';
            }
            
            // Restaurar panel de progreso de impresi√≥n
            const printProgressPanel = document.getElementById('print-progress-panel');
            if (printProgressPanel && !printProgressPanel.classList.contains('hidden')) {
                const timeRemaining = document.getElementById('time-remaining');
                if (timeRemaining) {
                    timeRemaining.textContent = '15:30'; // Tiempo estimado
                    timeRemaining.className = 'font-bold text-purple-400';
                }
            }
        }
        
        // Funci√≥n de sincronizaci√≥n completa de la interfaz
        function syncCompleteInterface() {
            // Sincronizar estado de impresi√≥n en todos los elementos
            syncPrintStatus();
            
            // Actualizar todos los botones con estados correctos
            updateAllButtonStates();
            
            // Sincronizar elementos del modal
            updateModalElements();
            
            // Actualizar pantalla LCD
            updateLCDDisplay();
            
            // Sincronizar todos los LEDs
            syncAllLEDs();
            
            // Actualizar indicadores de conexi√≥n
            updateConnectionIndicators();
            
            // Sincronizar vistas (frontal/trasera)
            syncViewStates();
        }
        
        // Funci√≥n para actualizar indicadores de conexi√≥n
        function updateConnectionIndicators() {
            const connectionLight = document.getElementById('connection-light');
            const connectionText = document.getElementById('connection-text');
            
            if (connectionLight && connectionText) {
                if (printerState.powered) {
                    if (printerState.printing && !printerState.paused) {
                        connectionLight.className = 'w-4 h-4 bg-green-400 rounded-full shadow-inner neon-glow animate-pulse';
                        connectionText.textContent = 'Imprimiendo';
                    } else if (printerState.paused) {
                        connectionLight.className = 'w-4 h-4 bg-yellow-400 rounded-full shadow-inner neon-glow';
                        connectionText.textContent = 'Pausada';
                    } else {
                        connectionLight.className = 'w-4 h-4 bg-green-400 rounded-full shadow-inner neon-glow';
                        connectionText.textContent = 'Conectada';
                    }
                } else {
                    connectionLight.className = 'w-4 h-4 bg-red-400 rounded-full shadow-inner neon-glow';
                    connectionText.textContent = 'Desconectada';
                }
            }
        }

        function emergencyStop() {
            printerState.emergencyStop = true;
            printerState.printing = false;
            printerState.paused = false;
            
            // Detener timer de impresi√≥n
            if (printingTimer) {
                clearInterval(printingTimer);
                printingTimer = null;
            }
            
            // Stop all animations
            const extruder = document.getElementById('extruder');
            const filamentExtrusion = document.getElementById('filament-extrusion');
            const printObject = document.getElementById('print-object');
            
            if (extruder) extruder.classList.remove('extruder');
            if (filamentExtrusion) filamentExtrusion.style.opacity = '0';
            if (printObject) {
                printObject.style.opacity = '0';
                printObject.style.height = '0px';
            }
            
            // Use centralized fan animation sync (will handle emergency stop state)
            syncFanAnimations();
            
            // Sync all interface elements immediately
            syncPrintStatus();
            updateAllButtonStates();
            updateModalElements();
            updateLCDDisplay();
            
            // Immediately sync all LEDs for emergency state
            syncAllLEDs();
            
            showNotification('¬°PARADA DE EMERGENCIA ACTIVADA!', 'error');
            
            // Reset emergency stop after 3 seconds
            setTimeout(() => {
                printerState.emergencyStop = false;
                
                // Sync interface again after reset
                syncPrintStatus();
                updateAllButtonStates();
                updateModalElements();
                updateLCDDisplay();
                
                // Sync LEDs after emergency reset
                syncAllLEDs();
                
                showNotification('Sistema restablecido', 'info');
            }, 3000);
        }

        function updateTemperature(type, value) {
            if (type === 'extruder') {
                printerState.extruderTemp = parseInt(value);
            } else if (type === 'bed') {
                printerState.bedTemp = parseInt(value);
            }
            
            // Sincronizaci√≥n completa de todos los controles de temperatura
            syncAllTemperatureControls();
            updateHeatIndicators();
            updateLCDDisplay();
        }
        
        // FUNCI√ìN PRINCIPAL: Sincronizar TODOS los controles de temperatura
        function syncAllTemperatureControls() {
            // Sliders principales (modo manual)
            const extruderSlider = document.getElementById('extruder-temp-slider');
            const bedSlider = document.getElementById('bed-temp-slider');
            
            // Sliders del modal LCD
            const modalExtruderSlider = document.getElementById('modal-extruder-temp-slider');
            const modalBedSlider = document.getElementById('modal-bed-temp-slider');
            
            // Sincronizar slider del extrusor
            if (extruderSlider) extruderSlider.value = printerState.extruderTemp;
            if (modalExtruderSlider) modalExtruderSlider.value = printerState.extruderTemp;
            
            // Sincronizar slider de la cama
            if (bedSlider) bedSlider.value = printerState.bedTemp;
            if (modalBedSlider) modalBedSlider.value = printerState.bedTemp;
            
            // Sincronizar todos los displays de temperatura
            updateAllTemperatureDisplays();
        }
        
        // Funci√≥n mejorada para sincronizar displays de temperatura
        function syncAllTemperatureDisplays() {
            // Displays principales
            const extruderTemp = document.getElementById('extruder-temp');
            const bedTemp = document.getElementById('bed-temp');
            
            // Displays en la impresora
            const extruderTempDisplay = document.getElementById('extruder-temp-display');
            const bedTempDisplay = document.getElementById('bed-temp-display');
            
            // Displays del modal
            const modalExtruderTemp = document.getElementById('modal-extruder-temp');
            const modalBedTemp = document.getElementById('modal-bed-temp');
            
            // Displays de estado r√°pido
            const quickExtruderTemp = document.getElementById('quick-extruder-temp');
            const quickBedTemp = document.getElementById('quick-bed-temp');
            
            // Displays del panel de estado
            const displayExtruderTemp = document.getElementById('display-extruder-temp');
            const displayBedTemp = document.getElementById('display-bed-temp');
            
            // Actualizar TODOS los displays del extrusor
            const extruderTempText = printerState.extruderTemp + '¬∞C';
            if (extruderTemp) extruderTemp.textContent = extruderTempText;
            if (extruderTempDisplay) extruderTempDisplay.textContent = extruderTempText;
            if (modalExtruderTemp) modalExtruderTemp.textContent = printerState.extruderTemp;
            if (quickExtruderTemp) quickExtruderTemp.textContent = extruderTempText;
            if (displayExtruderTemp) displayExtruderTemp.textContent = extruderTempText;
            
            // Actualizar TODOS los displays de la cama
            const bedTempText = printerState.bedTemp + '¬∞C';
            if (bedTemp) bedTemp.textContent = bedTempText;
            if (bedTempDisplay) bedTempDisplay.textContent = bedTempText;
            if (modalBedTemp) modalBedTemp.textContent = printerState.bedTemp;
            if (quickBedTemp) quickBedTemp.textContent = bedTempText;
            if (displayBedTemp) displayBedTemp.textContent = bedTempText;
            
            // Actualizar barras de progreso de temperatura
            updateTemperatureBars();
        }
        
        // Nueva funci√≥n para actualizar barras de progreso de temperatura
        function updateTemperatureBars() {
            const extruderTempBar = document.getElementById('extruder-temp-bar');
            const bedTempBar = document.getElementById('bed-temp-bar');
            
            if (extruderTempBar) {
                const extruderPercent = Math.min((printerState.extruderTemp - 25) / 275 * 100, 100);
                extruderTempBar.style.width = Math.max(0, extruderPercent) + '%';
                
                // Cambiar color seg√∫n temperatura
                if (printerState.extruderTemp >= 200) {
                    extruderTempBar.className = 'bg-gradient-to-r from-red-400 to-red-600 h-2 rounded-full transition-all';
                } else if (printerState.extruderTemp >= 100) {
                    extruderTempBar.className = 'bg-gradient-to-r from-orange-400 to-red-500 h-2 rounded-full transition-all';
                } else if (printerState.extruderTemp >= 50) {
                    extruderTempBar.className = 'bg-gradient-to-r from-yellow-400 to-orange-500 h-2 rounded-full transition-all';
                } else {
                    extruderTempBar.className = 'bg-gradient-to-r from-blue-400 to-blue-500 h-2 rounded-full transition-all';
                }
            }
            
            if (bedTempBar) {
                const bedPercent = Math.min((printerState.bedTemp - 25) / 95 * 100, 100);
                bedTempBar.style.width = Math.max(0, bedPercent) + '%';
                
                // Cambiar color seg√∫n temperatura
                if (printerState.bedTemp >= 80) {
                    bedTempBar.className = 'bg-gradient-to-r from-red-400 to-red-600 h-2 rounded-full transition-all';
                } else if (printerState.bedTemp >= 60) {
                    bedTempBar.className = 'bg-gradient-to-r from-orange-400 to-red-500 h-2 rounded-full transition-all';
                } else if (printerState.bedTemp >= 40) {
                    bedTempBar.className = 'bg-gradient-to-r from-yellow-400 to-orange-500 h-2 rounded-full transition-all';
                } else {
                    bedTempBar.className = 'bg-gradient-to-r from-blue-400 to-blue-500 h-2 rounded-full transition-all';
                }
            }
        }

        // CONSOLIDATED: Single comprehensive temperature display update function
        function updateAllTemperatureDisplays() {
            // Displays principales
            const extruderTemp = document.getElementById('extruder-temp');
            const bedTemp = document.getElementById('bed-temp');
            
            // Displays en la impresora
            const extruderTempDisplay = document.getElementById('extruder-temp-display');
            const bedTempDisplay = document.getElementById('bed-temp-display');
            
            // Displays del modal
            const modalExtruderTemp = document.getElementById('modal-extruder-temp');
            const modalBedTemp = document.getElementById('modal-bed-temp');
            
            // Displays de estado r√°pido
            const quickExtruderTemp = document.getElementById('quick-extruder-temp');
            const quickBedTemp = document.getElementById('quick-bed-temp');
            
            // Displays del panel de estado
            const displayExtruderTemp = document.getElementById('display-extruder-temp');
            const displayBedTemp = document.getElementById('display-bed-temp');
            
            // Actualizar TODOS los displays del extrusor
            const extruderTempText = printerState.extruderTemp + '¬∞C';
            if (extruderTemp) extruderTemp.textContent = extruderTempText;
            if (extruderTempDisplay) extruderTempDisplay.textContent = extruderTempText;
            if (modalExtruderTemp) modalExtruderTemp.textContent = printerState.extruderTemp;
            if (quickExtruderTemp) quickExtruderTemp.textContent = extruderTempText;
            if (displayExtruderTemp) displayExtruderTemp.textContent = extruderTempText;
            
            // Actualizar TODOS los displays de la cama
            const bedTempText = printerState.bedTemp + '¬∞C';
            if (bedTemp) bedTemp.textContent = bedTempText;
            if (bedTempDisplay) bedTempDisplay.textContent = bedTempText;
            if (modalBedTemp) modalBedTemp.textContent = printerState.bedTemp;
            if (quickBedTemp) quickBedTemp.textContent = bedTempText;
            if (displayBedTemp) displayBedTemp.textContent = bedTempText;
            
            // Actualizar barras de progreso de temperatura
            updateTemperatureBars();
            
            // Heat indicators
            const extruderHeatIndicator = document.getElementById('extruder-heat-indicator');
            const bedHeatIndicator = document.getElementById('bed-heat-indicator');
            
            if (extruderHeatIndicator) {
                extruderHeatIndicator.style.opacity = printerState.extruderTemp > 50 ? '1' : '0';
                if (printerState.extruderTemp > 50) {
                    extruderHeatIndicator.classList.add('heating');
                } else {
                    extruderHeatIndicator.classList.remove('heating');
                }
            }
            
            if (bedHeatIndicator) {
                bedHeatIndicator.style.opacity = printerState.bedTemp > 40 ? '1' : '0';
                if (printerState.bedTemp > 40) {
                    bedHeatIndicator.classList.add('heating');
                } else {
                    bedHeatIndicator.classList.remove('heating');
                }
            }
        }

        function presetPLA() {
            if (!printerState.powered) {
                showNotification('Enciende la impresora primero', 'warning');
                return;
            }
            
            // Actualizar estado global
            printerState.extruderTemp = 200;
            printerState.bedTemp = 60;
            
            // Usar la funci√≥n de sincronizaci√≥n completa
            syncAllTemperatureControls();
            updateHeatIndicators();
            updateLCDDisplay();
            
            showNotification('üî• Preset PLA aplicado: 200¬∞C/60¬∞C - Todos los controles sincronizados', 'success');
        }

        function presetABS() {
            if (!printerState.powered) {
                showNotification('Enciende la impresora primero', 'warning');
                return;
            }
            
            // Actualizar estado global
            printerState.extruderTemp = 240;
            printerState.bedTemp = 80;
            
            // Usar la funci√≥n de sincronizaci√≥n completa
            syncAllTemperatureControls();
            updateHeatIndicators();
            updateLCDDisplay();
            
            showNotification('üî• Preset ABS aplicado: 240¬∞C/80¬∞C - Todos los controles sincronizados', 'success');
        }

        function coolDown() {
            if (!printerState.powered) {
                showNotification('Enciende la impresora primero', 'warning');
                return;
            }
            
            // Guardar temperaturas iniciales para el enfriamiento gradual
            const initialExtruderTemp = printerState.extruderTemp;
            const initialBedTemp = printerState.bedTemp;
            const targetTemp = 25;
            
            // Verificar si ya est√°n a temperatura ambiente
            if (initialExtruderTemp <= 30 && initialBedTemp <= 30) {
                showNotification('‚ùÑÔ∏è Las temperaturas ya est√°n en rango ambiente', 'info');
                return;
            }
            
            showNotification('‚ùÑÔ∏è Iniciando enfriamiento gradual progresivo...', 'info');
            
            // Funci√≥n de enfriamiento gradual con curva realista
            function gradualCooling() {
                let currentTime = 0;
                const coolingInterval = 500; // Actualizar cada 500ms para suavidad
                const totalCoolingTime = 15000; // 15 segundos para enfriamiento completo
                
                const coolingTimer = setInterval(() => {
                    currentTime += coolingInterval;
                    const progress = Math.min(currentTime / totalCoolingTime, 1);
                    
                    // Curva de enfriamiento exponencial realista (m√°s r√°pido al inicio, m√°s lento al final)
                    const coolingFactor = 1 - Math.pow(1 - progress, 2);
                    
                    // Calcular temperaturas actuales con enfriamiento diferencial
                    // El extrusor se enfr√≠a m√°s r√°pido que la cama (m√°s masa t√©rmica en la cama)
                    const extruderCoolingRate = 0.8; // Extrusor se enfr√≠a al 80% de la velocidad base
                    const bedCoolingRate = 0.6; // Cama se enfr√≠a al 60% de la velocidad base (m√°s lenta)
                    
                    const newExtruderTemp = Math.round(
                        initialExtruderTemp - (initialExtruderTemp - targetTemp) * (coolingFactor * extruderCoolingRate)
                    );
                    const newBedTemp = Math.round(
                        initialBedTemp - (initialBedTemp - targetTemp) * (coolingFactor * bedCoolingRate)
                    );
                    
                    // Actualizar temperaturas gradualmente
                    printerState.extruderTemp = Math.max(targetTemp, newExtruderTemp);
                    printerState.bedTemp = Math.max(targetTemp, newBedTemp);
                    
                    // Sincronizar todos los controles en tiempo real
                    syncAllTemperatureControls();
                    updateHeatIndicators();
                    updateLCDDisplay();
                    
                    // Efectos visuales de enfriamiento
                    updateCoolingVisualEffects(progress);
                    
                    // Notificaciones de progreso cada 25%
                    if (currentTime % 3750 === 0 && progress < 1) {
                        const progressPercent = Math.round(progress * 100);
                        showNotification(`üå°Ô∏è Enfriamiento ${progressPercent}% - E:${printerState.extruderTemp}¬∞C B:${printerState.bedTemp}¬∞C`, 'info');
                    }
                    
                    // Verificar si el enfriamiento est√° completo
                    if (progress >= 1 || (printerState.extruderTemp <= targetTemp && printerState.bedTemp <= targetTemp)) {
                        clearInterval(coolingTimer);
                        
                        // Asegurar temperaturas finales exactas
                        printerState.extruderTemp = targetTemp;
                        printerState.bedTemp = targetTemp;
                        
                        // Sincronizaci√≥n final
                        syncAllTemperatureControls();
                        updateHeatIndicators();
                        updateLCDDisplay();
                        
                        // Efectos visuales finales
                        completeCoolingEffects();
                        
                        showNotification('‚ùÑÔ∏è Enfriamiento completado - Temperaturas en ambiente (25¬∞C)', 'success');
                    }
                }, coolingInterval);
            }
            
            // Iniciar el proceso de enfriamiento gradual
            gradualCooling();
        }
        
        // Funci√≥n para efectos visuales durante el enfriamiento
        function updateCoolingVisualEffects(progress) {
            const extruderHeatIndicator = document.getElementById('extruder-heat-indicator');
            const bedHeatIndicator = document.getElementById('bed-heat-indicator');
            
            // Reducir intensidad de los indicadores de calor gradualmente
            if (extruderHeatIndicator && printerState.extruderTemp > 50) {
                const intensity = Math.max(0.3, 1 - progress * 0.7);
                extruderHeatIndicator.style.opacity = intensity;
                extruderHeatIndicator.style.filter = `brightness(${intensity}) hue-rotate(${progress * 180}deg)`;
            }
            
            if (bedHeatIndicator && printerState.bedTemp > 40) {
                const intensity = Math.max(0.3, 1 - progress * 0.7);
                bedHeatIndicator.style.opacity = intensity;
                bedHeatIndicator.style.filter = `brightness(${intensity}) hue-rotate(${progress * 180}deg)`;
            }
            
            // Efecto de enfriamiento en la cama
            const printBed = document.querySelector('.printer-bed');
            if (printBed) {
                const coolingIntensity = progress * 0.3;
                printBed.style.filter = `brightness(${1 - coolingIntensity}) saturate(${1 - coolingIntensity * 0.5})`;
            }
        }
        
        // Funci√≥n para completar efectos visuales de enfriamiento
        function completeCoolingEffects() {
            const extruderHeatIndicator = document.getElementById('extruder-heat-indicator');
            const bedHeatIndicator = document.getElementById('bed-heat-indicator');
            const printBed = document.querySelector('.printer-bed');
            
            // Ocultar completamente los indicadores de calor
            if (extruderHeatIndicator) {
                extruderHeatIndicator.style.opacity = '0';
                extruderHeatIndicator.style.filter = 'brightness(1) hue-rotate(0deg)';
                extruderHeatIndicator.classList.remove('heating');
            }
            
            if (bedHeatIndicator) {
                bedHeatIndicator.style.opacity = '0';
                bedHeatIndicator.style.filter = 'brightness(1) hue-rotate(0deg)';
                bedHeatIndicator.classList.remove('heating');
            }
            
            // Restaurar apariencia normal de la cama
            if (printBed) {
                printBed.style.filter = 'brightness(1) saturate(1)';
            }
            
            // Efecto visual de "vapor fr√≠o" temporal
            showCoolingVaporEffect();
        }
        
        // Funci√≥n para mostrar efecto de vapor fr√≠o
        function showCoolingVaporEffect() {
            const extruder = document.getElementById('extruder');
            const printBed = document.querySelector('.printer-bed');
            
            if (extruder) {
                // Crear efecto de vapor fr√≠o temporal
                const vapor = document.createElement('div');
                vapor.className = 'absolute -top-4 left-1/2 transform -translate-x-1/2 w-8 h-8 bg-gradient-to-t from-cyan-200 to-transparent rounded-full opacity-0 pointer-events-none';
                vapor.style.animation = 'pulse 2s ease-in-out 3';
                extruder.appendChild(vapor);
                
                // Remover el efecto despu√©s de 6 segundos
                setTimeout(() => {
                    if (vapor.parentNode) {
                        vapor.parentNode.removeChild(vapor);
                    }
                }, 6000);
            }
            
            if (printBed) {
                // Efecto sutil de enfriamiento en la cama
                printBed.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3), inset 0 2px 4px rgba(0,0,0,0.1)';
                
                setTimeout(() => {
                    printBed.style.boxShadow = 'inset 0 2px 4px rgba(0,0,0,0.1), 0 4px 16px rgba(251, 146, 60, 0.3)';
                }, 3000);
            }
        }

        function moveExtruder(axis, distance) {
            if (!printerState.powered) {
                showNotification('Enciende la impresora primero', 'warning');
                return;
            }
            
            if (axis === 'x') {
                printerState.position.x = Math.max(0, Math.min(200, printerState.position.x + distance));
            } else if (axis === 'y') {
                printerState.position.y = Math.max(0, Math.min(200, printerState.position.y + distance));
            } else if (axis === 'z') {
                printerState.position.z = Math.max(0, Math.min(200, printerState.position.z + distance));
            }
            
            // Update position displays
            const posX = document.getElementById('pos-x');
            const posY = document.getElementById('pos-y');
            const posZ = document.getElementById('pos-z');
            const modalPosX = document.getElementById('modal-pos-x');
            const modalPosY = document.getElementById('modal-pos-y');
            const modalPosZ = document.getElementById('modal-pos-z');
            
            if (posX) posX.textContent = printerState.position.x + 'mm';
            if (posY) posY.textContent = printerState.position.y + 'mm';
            if (posZ) posZ.textContent = printerState.position.z + 'mm';
            if (modalPosX) modalPosX.textContent = printerState.position.x + 'mm';
            if (modalPosY) modalPosY.textContent = printerState.position.y + 'mm';
            if (modalPosZ) modalPosZ.textContent = printerState.position.z + 'mm';
            
            // Animate extruder movement with enhanced visual feedback
            updateExtruderPosition();
            
            showNotification(`Movido ${axis.toUpperCase()}: ${distance > 0 ? '+' : ''}${distance}mm`, 'info');
        }

        // FIXED: Enhanced extruder position update function with proper visual mapping
        function updateExtruderPosition() {
            const extruder = document.getElementById('extruder');
            const xCarriage = document.getElementById('x-carriage');
            
            if (!extruder || !xCarriage) {
                console.warn('Extruder position update failed: Elements not found');
                return;
            }
            
            // FIXED: Proper coordinate system mapping based on actual printer frame dimensions
            const maxX = 200; // mm - printer X range
            const maxY = 200; // mm - printer Y range  
            const maxZ = 200; // mm - printer Z range
            
            // FIXED: Accurate visual boundaries based on printer frame container
            const frameContainer = document.querySelector('#front-view');
            if (!frameContainer) return;
            
            const containerRect = frameContainer.getBoundingClientRect();
            const frameWidth = 400; // Fixed frame width in pixels
            const frameHeight = 500; // Fixed frame height in pixels
            
            // FIXED: Proper movement boundaries within the printer frame
            const movementBounds = {
                left: 48,    // Left boundary (accounting for frame and rails)
                right: 352,  // Right boundary (frameWidth - margins)
                top: 48,     // Top boundary (below top frame)
                bottom: 280, // Bottom boundary (above bed level)
                zMin: 48,    // Minimum Z (top of frame)
                zMax: 280    // Maximum Z (bed level)
            };
            
            // FIXED: Calculate accurate visual positions with proper scaling
            const xPercent = Math.max(0, Math.min(1, printerState.position.x / maxX));
            const yPercent = Math.max(0, Math.min(1, printerState.position.y / maxY));
            const zPercent = Math.max(0, Math.min(1, printerState.position.z / maxZ));
            
            // FIXED: Map coordinates to visual positions
            const visualX = movementBounds.left + (xPercent * (movementBounds.right - movementBounds.left - 64)); // 64px extruder width
            const visualY = movementBounds.top + (yPercent * (movementBounds.bottom - movementBounds.top - 40)); // Y affects depth
            const visualZ = movementBounds.zMax - (zPercent * (movementBounds.zMax - movementBounds.zMin)); // Z inverted (up = lower pixel value)
            
            // FIXED: Apply smooth transitions with proper easing
            const transitionStyle = 'all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            extruder.style.transition = transitionStyle;
            xCarriage.style.transition = transitionStyle;
            
            // FIXED: Update extruder position with transform for better performance
            extruder.style.transform = `translate(${visualX - 48}px, ${visualZ - 48}px) scale(1)`;
            
            // FIXED: Update X-carriage position to follow extruder X movement
            xCarriage.style.transform = `translateX(${visualX - 56}px)`; // Offset for carriage alignment
            
            // FIXED: Enhanced visual feedback with proper scaling animation
            extruder.style.filter = 'brightness(1.1) drop-shadow(0 4px 12px rgba(59, 130, 246, 0.4))';
            
            setTimeout(() => {
                extruder.style.filter = 'drop-shadow(0 4px 8px rgba(0,0,0,0.3))';
            }, 300);
            
            // FIXED: Dynamic bed shadow based on Z position with realistic physics
            const printBed = document.querySelector('.printer-bed');
            if (printBed) {
                const shadowIntensity = Math.max(0.1, Math.min(1, zPercent));
                const shadowBlur = 8 + (zPercent * 24); // 8px to 32px blur
                const shadowOffset = 4 + (zPercent * 12); // 4px to 16px offset
                
                printBed.style.boxShadow = `
                    inset 0 2px 4px rgba(0,0,0,0.1),
                    0 ${shadowOffset}px ${shadowBlur}px rgba(0,0,0,${0.2 + shadowIntensity * 0.3}),
                    0 4px 16px rgba(251, 146, 60, 0.3)
                `;
            }
            
            // FIXED: Update position indicators with visual feedback
            updatePositionIndicators(visualX, visualY, visualZ);
            
            // FIXED: Debug logging for position tracking
            console.log('Extruder Position Update:', {
                logical: printerState.position,
                visual: { x: visualX, y: visualY, z: visualZ },
                percentages: { x: xPercent, y: yPercent, z: zPercent }
            });
        }
        
        // NEW: Function to update position indicators with visual feedback
        function updatePositionIndicators(visualX, visualY, visualZ) {
            // Update all position displays with enhanced formatting
            const positionElements = [
                { id: 'pos-x', value: printerState.position.x },
                { id: 'pos-y', value: printerState.position.y },
                { id: 'pos-z', value: printerState.position.z },
                { id: 'modal-pos-x', value: printerState.position.x },
                { id: 'modal-pos-y', value: printerState.position.y },
                { id: 'modal-pos-z', value: printerState.position.z }
            ];
            
            positionElements.forEach(({ id, value }) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = `${value}mm`;
                    
                    // Add visual feedback for position changes
                    element.style.transition = 'all 0.3s ease';
                    element.style.transform = 'scale(1.1)';
                    element.style.color = '#3b82f6'; // Blue highlight
                    
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                        element.style.color = ''; // Reset to default
                    }, 500);
                }
            });
        }

        function homeExtruder() {
            if (!printerState.powered) {
                showNotification('Enciende la impresora primero', 'warning');
                return;
            }
            
            printerState.position = { x: 0, y: 0, z: 0 };
            
            // Update position displays
            const posX = document.getElementById('pos-x');
            const posY = document.getElementById('pos-y');
            const posZ = document.getElementById('pos-z');
            const modalPosX = document.getElementById('modal-pos-x');
            const modalPosY = document.getElementById('modal-pos-y');
            const modalPosZ = document.getElementById('modal-pos-z');
            
            if (posX) posX.textContent = '0mm';
            if (posY) posY.textContent = '0mm';
            if (posZ) posZ.textContent = '0mm';
            if (modalPosX) modalPosX.textContent = '0mm';
            if (modalPosY) modalPosY.textContent = '0mm';
            if (modalPosZ) modalPosZ.textContent = '0mm';
            
            // Use enhanced position update function
            updateExtruderPosition();
            
            showNotification('Extrusor enviado a posici√≥n inicial (Home)', 'success');
        }

        function setMoveIncrement(value) {
            moveIncrement.x = value;
            moveIncrement.y = value;
            moveIncrement.z = value === 50 ? 10 : value === 10 ? 5 : 1;
            showNotification(`Incremento de movimiento: ${value}mm`, 'info');
        }

        // PASO 2: Funci√≥n para seleccionar filamento
        function selectFilament(filamentType) {
            if (!filamentConfigs[filamentType]) {
                showNotification('Tipo de filamento no v√°lido', 'error');
                return;
            }
            
            const config = filamentConfigs[filamentType];
            
            // Actualizar estado global del filamento seleccionado
            selectedFilament = { ...config };
            printerState.selectedFilament = filamentType;
            
            // Actualizar visualizaci√≥n del modal
            updateFilamentModalDisplay();
            
            // Aplicar configuraci√≥n autom√°tica de temperaturas si la impresora est√° encendida
            if (printerState.powered) {
                applyFilamentTemperatures(config);
            }
            
            // Actualizar carrete visual en vista trasera
            updateSpoolVisual(config);
            
            showNotification(`üßµ Filamento ${filamentType} seleccionado - Configuraci√≥n aplicada`, 'success');
        }
        
        // PASO 2: Funci√≥n para cerrar modal de filamento
        function closeFilamentModal() {
            const modal = document.getElementById('filament-modal');
            if (modal) {
                modal.classList.add('hidden');
                showNotification('Selecci√≥n de filamento guardada', 'info');
            }
        }
        
        // PASO 2: Funci√≥n para actualizar display del modal
        function updateFilamentModalDisplay() {
            const currentFilamentIndicator = document.getElementById('current-filament-indicator');
            const currentFilamentName = document.getElementById('current-filament-name');
            const currentFilamentTemp = document.getElementById('current-filament-temp');
            
            if (currentFilamentIndicator) {
                currentFilamentIndicator.className = `w-8 h-8 bg-gradient-to-br ${selectedFilament.color} rounded-full ${selectedFilament.borderColor} border-2`;
            }
            
            if (currentFilamentName) {
                currentFilamentName.textContent = selectedFilament.type;
            }
            
            if (currentFilamentTemp) {
                currentFilamentTemp.textContent = `Extrusor: ${selectedFilament.extruderTemp}¬∞C | Cama: ${selectedFilament.bedTemp}¬∞C`;
            }
            
            // Actualizar selecci√≥n visual en las opciones
            updateFilamentOptionsSelection();
        }
        
        // PASO 2: Funci√≥n para actualizar selecci√≥n visual
        function updateFilamentOptionsSelection() {
            const filamentOptions = document.querySelectorAll('.filament-option');
            
            filamentOptions.forEach(option => {
                const filamentType = option.getAttribute('data-filament');
                
                if (filamentType === selectedFilament.type) {
                    // Opci√≥n seleccionada
                    option.className = `filament-option border-2 ${selectedFilament.borderColor.replace('border-', 'border-')} bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 cursor-pointer shadow-xl transition-all duration-300 ring-4 ring-blue-300 ring-opacity-50`;
                } else {
                    // Opci√≥n no seleccionada
                    option.className = 'filament-option border-2 border-gray-200 rounded-2xl p-6 cursor-pointer hover:border-gray-400 hover:shadow-xl transition-all duration-300';
                }
            });
        }
        
        // PASO 2: Funci√≥n para aplicar temperaturas del filamento
        function applyFilamentTemperatures(config) {
            printerState.extruderTemp = config.extruderTemp;
            printerState.bedTemp = config.bedTemp;
            
            // Sincronizar todos los controles de temperatura
            syncAllTemperatureControls();
            updateHeatIndicators();
            updateLCDDisplay();
            
            showNotification(`üå°Ô∏è Temperaturas aplicadas: E:${config.extruderTemp}¬∞C B:${config.bedTemp}¬∞C`, 'info');
        }
        
        // PASO 2: Funci√≥n para actualizar visual del carrete
        function updateSpoolVisual(config) {
            const filamentSpoolRear = document.getElementById('filament-spool-rear');
            
            if (filamentSpoolRear) {
                // Actualizar colores del carrete seg√∫n el filamento
                filamentSpoolRear.className = `clickable-component absolute top-16 left-1/2 transform -translate-x-1/2 w-24 h-24 bg-gradient-to-br ${config.color} rounded-full border-4 ${config.borderColor.replace('border-', 'border-')} shadow-2xl hover:scale-110 transition-all duration-300`;
                
                // Actualizar etiqueta del carrete
                const spoolLabel = filamentSpoolRear.querySelector('.absolute.-bottom-6');
                if (spoolLabel) {
                    spoolLabel.textContent = `üßµ FILAMENTO ${config.type}`;
                    spoolLabel.className = `absolute -bottom-6 left-1/2 transform -translate-x-1/2 bg-${config.type === 'PLA' ? 'green' : config.type === 'ABS' ? 'red' : 'purple'}-800 text-white px-3 py-1 rounded-b-lg text-xs font-bold border-2 ${config.borderColor.replace('border-', 'border-')} border-t-0`;
                }
            }
        }

        function clickComponent(component) {
            switch(component) {
                case 'extruder':
                    showNotification('Extrusor E3D V6 - Temperatura m√°xima: 300¬∞C', 'info');
                    break;
                case 'bed':
                    showNotification('Cama calefactada magn√©tica - Superficie PEI', 'info');
                    break;
                case 'spool':
                    // PASO 2: Abrir modal de selecci√≥n de filamento al hacer clic en el carrete
                    openFilamentModal();
                    break;
                case 'control':
                    showNotification('Caja de control EINSY RAMBo - 32-bit ARM', 'info');
                    break;
            }
        }
        
        // PASO 2: Funci√≥n para abrir modal de selecci√≥n de filamento
        function openFilamentModal() {
            const modal = document.getElementById('filament-modal');
            if (modal) {
                modal.classList.remove('hidden');
                updateFilamentModalDisplay();
                showNotification('üßµ Selecciona el tipo de filamento para optimizar la impresi√≥n', 'info');
            }
        }

        // PASO 3: Sistema avanzado de detecci√≥n y validaci√≥n de filamento
        function detectFilamentCompatibility(targetTemp) {
            const currentFilament = filamentConfigs[printerState.selectedFilament];
            if (!currentFilament) return { compatible: false, reason: 'Filamento no seleccionado' };
            
            const tempRange = {
                min: currentFilament.extruderTemp - 20,
                max: currentFilament.extruderTemp + 30
            };
            
            if (targetTemp < tempRange.min) {
                return { 
                    compatible: false, 
                    reason: `Temperatura muy baja para ${currentFilament.type}. M√≠nimo: ${tempRange.min}¬∞C` 
                };
            }
            
            if (targetTemp > tempRange.max) {
                return { 
                    compatible: false, 
                    reason: `Temperatura muy alta para ${currentFilament.type}. M√°ximo: ${tempRange.max}¬∞C` 
                };
            }
            
            return { compatible: true, reason: 'Temperatura compatible' };
        }

        // PASO 3: Sistema de carga autom√°tica de filamento con validaci√≥n
        function advancedLoadFilament() {
            if (!printerState.powered) {
                showNotification('‚ö†Ô∏è Enciende la impresora primero', 'warning');
                return false;
            }
            
            // Validar temperatura del extrusor
            const compatibility = detectFilamentCompatibility(printerState.extruderTemp);
            if (!compatibility.compatible) {
                showNotification(`‚ùå ${compatibility.reason}`, 'error');
                return false;
            }
            
            // Proceso de carga con animaci√≥n realista
            showNotification('üîÑ Iniciando secuencia de carga de filamento...', 'info');
            
            // Fase 1: Preparaci√≥n del extrusor
            setTimeout(() => {
                showNotification('üå°Ô∏è Verificando temperatura del extrusor...', 'info');
                
                // Fase 2: Inserci√≥n del filamento
                setTimeout(() => {
                    showNotification('üßµ Insertando filamento en el extrusor...', 'info');
                    animateFilamentInsertion();
                    
                    // Fase 3: Purga y verificaci√≥n
                    setTimeout(() => {
                        showNotification('üíß Purgando material anterior...', 'info');
                        animateFilamentPurge();
                        
                        // Fase 4: Finalizaci√≥n
                        setTimeout(() => {
                            printerState.filamentLoaded = true;
                            updateFilamentLoadedStatus();
                            showNotification(`‚úÖ Filamento ${printerState.selectedFilament} cargado correctamente`, 'success');
                            
                            // Actualizar interfaz completa
                            syncCompleteInterface();
                            
                            return true;
                        }, 2000);
                    }, 1500);
                }, 1000);
            }, 500);
        }

        // PASO 3: Animaci√≥n de inserci√≥n de filamento
        function animateFilamentInsertion() {
            const filamentPath = document.getElementById('filament-path');
            const filamentPathRear = document.getElementById('filament-path-rear');
            
            // Animaci√≥n progresiva del filamento
            if (filamentPath) {
                filamentPath.style.opacity = '0.3';
                filamentPath.style.height = '20px';
                filamentPath.style.transition = 'all 1s ease-in-out';
                
                setTimeout(() => {
                    filamentPath.style.opacity = '0.7';
                    filamentPath.style.height = '40px';
                }, 500);
                
                setTimeout(() => {
                    filamentPath.style.opacity = '1';
                    filamentPath.style.height = '32px';
                }, 1000);
            }
            
            if (filamentPathRear) {
                filamentPathRear.style.opacity = '0.3';
                filamentPathRear.style.height = '50px';
                filamentPathRear.style.transition = 'all 1s ease-in-out';
                
                setTimeout(() => {
                    filamentPathRear.style.opacity = '0.7';
                    filamentPathRear.style.height = '70px';
                }, 500);
                
                setTimeout(() => {
                    filamentPathRear.style.opacity = '1';
                    filamentPathRear.style.height = '80px';
                }, 1000);
            }
        }

        // PASO 3: Animaci√≥n de purga de filamento
        function animateFilamentPurge() {
            const filamentExtrusion = document.getElementById('filament-extrusion');
            const extruder = document.getElementById('extruder');
            
            if (filamentExtrusion) {
                // Simular extrusi√≥n de purga
                filamentExtrusion.style.opacity = '1';
                filamentExtrusion.style.animation = 'flow 0.5s linear infinite';
                filamentExtrusion.style.background = `linear-gradient(to bottom, ${getFilamentColor()}, transparent)`;
                
                // Detener purga despu√©s de 2 segundos
                setTimeout(() => {
                    filamentExtrusion.style.opacity = '0';
                    filamentExtrusion.style.animation = 'none';
                }, 2000);
            }
            
            if (extruder) {
                // Efecto visual de purga en el extrusor
                extruder.style.boxShadow = `0 0 20px ${getFilamentGlowColor()}, 0 0 40px ${getFilamentGlowColor()}`;
                
                setTimeout(() => {
                    extruder.style.boxShadow = '';
                }, 2000);
            }
        }

        // PASO 3: Obtener color del filamento actual
        function getFilamentColor() {
            const colors = {
                'PLA': '#22c55e',
                'ABS': '#ef4444', 
                'PETG': '#a855f7'
            };
            return colors[printerState.selectedFilament] || '#3b82f6';
        }

        // PASO 3: Obtener color de brillo del filamento
        function getFilamentGlowColor() {
            const glowColors = {
                'PLA': 'rgba(34, 197, 94, 0.6)',
                'ABS': 'rgba(239, 68, 68, 0.6)',
                'PETG': 'rgba(168, 85, 247, 0.6)'
            };
            return glowColors[printerState.selectedFilament] || 'rgba(59, 130, 246, 0.6)';
        }

        // PASO 3: Actualizar estado de filamento cargado
        function updateFilamentLoadedStatus() {
            // Actualizar displays de estado
            const filamentStatus = document.getElementById('quick-filament-status');
            const modalFilamentStatus = document.getElementById('modal-filament-status');
            
            if (filamentStatus) {
                filamentStatus.textContent = `${printerState.selectedFilament} Cargado`;
                filamentStatus.className = 'font-bold text-green-500';
            }
            
            if (modalFilamentStatus) {
                modalFilamentStatus.textContent = `${printerState.selectedFilament} Cargado`;
                modalFilamentStatus.className = 'font-bold text-green-500';
            }
            
            // Actualizar indicadores visuales
            updateFilamentVisualIndicators();
        }

        // PASO 3: Actualizar indicadores visuales del filamento
        function updateFilamentVisualIndicators() {
            const filamentPath = document.getElementById('filament-path');
            const filamentPathRear = document.getElementById('filament-path-rear');
            const filamentSpool = document.getElementById('filament-spool-rear');
            
            // Mostrar camino del filamento con color apropiado
            if (filamentPath) {
                filamentPath.style.opacity = '1';
                filamentPath.style.background = `linear-gradient(to bottom, ${getFilamentColor()}, ${getFilamentColor()}dd)`;
                filamentPath.style.boxShadow = `0 0 10px ${getFilamentGlowColor()}`;
            }
            
            if (filamentPathRear) {
                filamentPathRear.style.opacity = '1';
                filamentPathRear.style.background = `linear-gradient(to bottom, ${getFilamentColor()}, ${getFilamentColor()}dd)`;
                filamentPathRear.style.boxShadow = `0 0 10px ${getFilamentGlowColor()}`;
            }
            
            // Actualizar carrete con indicador de uso
            if (filamentSpool) {
                filamentSpool.style.filter = 'brightness(1.1) saturate(1.2)';
                filamentSpool.style.boxShadow = `0 0 20px ${getFilamentGlowColor()}, 0 8px 32px rgba(0,0,0,0.3)`;
            }
        }

        // PASO 3: Sistema de descarga de filamento
        function unloadFilament() {
            if (!printerState.powered) {
                showNotification('‚ö†Ô∏è Enciende la impresora primero', 'warning');
                return;
            }
            
            if (!printerState.filamentLoaded) {
                showNotification('‚ÑπÔ∏è No hay filamento cargado para descargar', 'info');
                return;
            }
            
            if (printerState.extruderTemp < 180) {
                showNotification('üå°Ô∏è Calienta el extrusor a al menos 180¬∞C para descargar', 'warning');
                return;
            }
            
            showNotification('üîÑ Iniciando descarga de filamento...', 'info');
            
            // Animaci√≥n de descarga
            animateFilamentUnload();
            
            setTimeout(() => {
                printerState.filamentLoaded = false;
                
                // Actualizar estado visual
                const filamentPath = document.getElementById('filament-path');
                const filamentPathRear = document.getElementById('filament-path-rear');
                
                if (filamentPath) {
                    filamentPath.style.opacity = '0';
                    filamentPath.style.background = '';
                    filamentPath.style.boxShadow = '';
                }
                
                if (filamentPathRear) {
                    filamentPathRear.style.opacity = '0';
                    filamentPathRear.style.background = '';
                    filamentPathRear.style.boxShadow = '';
                }
                
                // Actualizar displays de estado
                const filamentStatus = document.getElementById('quick-filament-status');
                const modalFilamentStatus = document.getElementById('modal-filament-status');
                
                if (filamentStatus) {
                    filamentStatus.textContent = 'No cargado';
                    filamentStatus.className = 'font-bold text-gray-500';
                }
                
                if (modalFilamentStatus) {
                    modalFilamentStatus.textContent = 'No cargado';
                    modalFilamentStatus.className = 'font-bold text-gray-500';
                }
                
                syncCompleteInterface();
                showNotification('‚úÖ Filamento descargado correctamente', 'success');
            }, 3000);
        }

        // PASO 3: Animaci√≥n de descarga de filamento
        function animateFilamentUnload() {
            const filamentPath = document.getElementById('filament-path');
            const filamentPathRear = document.getElementById('filament-path-rear');
            const filamentExtrusion = document.getElementById('filament-extrusion');
            
            // Animaci√≥n de retracci√≥n
            if (filamentPath) {
                filamentPath.style.transition = 'all 2s ease-out';
                filamentPath.style.height = '10px';
                filamentPath.style.opacity = '0.3';
            }
            
            if (filamentPathRear) {
                filamentPathRear.style.transition = 'all 2s ease-out';
                filamentPathRear.style.height = '20px';
                filamentPathRear.style.opacity = '0.3';
            }
            
            // Simular extrusi√≥n final
            if (filamentExtrusion) {
                filamentExtrusion.style.opacity = '1';
                filamentExtrusion.style.animation = 'flow 0.3s linear infinite';
                
                setTimeout(() => {
                    filamentExtrusion.style.opacity = '0';
                    filamentExtrusion.style.animation = 'none';
                }, 1000);
            }
        }

        // PASO 3: Validaci√≥n autom√°tica de configuraci√≥n de impresi√≥n
        function validatePrintConfiguration() {
            const issues = [];
            
            // Validar filamento
            if (!printerState.filamentLoaded) {
                issues.push({
                    type: 'error',
                    message: 'No hay filamento cargado',
                    solution: 'Cargar filamento antes de imprimir'
                });
            }
            
            // Validar temperaturas
            const compatibility = detectFilamentCompatibility(printerState.extruderTemp);
            if (!compatibility.compatible) {
                issues.push({
                    type: 'warning',
                    message: compatibility.reason,
                    solution: `Ajustar temperatura a ${filamentConfigs[printerState.selectedFilament].extruderTemp}¬∞C`
                });
            }
            
            // Validar nivelaci√≥n
            if (!printerState.leveled) {
                issues.push({
                    type: 'error',
                    message: 'Cama no nivelada',
                    solution: 'Ejecutar auto-nivelaci√≥n antes de imprimir'
                });
            }
            
            // Validar temperatura de la cama
            const selectedFilament = filamentConfigs[printerState.selectedFilament];
            if (selectedFilament && Math.abs(printerState.bedTemp - selectedFilament.bedTemp) > 10) {
                issues.push({
                    type: 'warning',
                    message: `Temperatura de cama no √≥ptima para ${printerState.selectedFilament}`,
                    solution: `Ajustar a ${selectedFilament.bedTemp}¬∞C`
                });
            }
            
            return issues;
        }

        // PASO 3: Mostrar validaci√≥n de configuraci√≥n
        function showConfigurationValidation() {
            const issues = validatePrintConfiguration();
            
            if (issues.length === 0) {
                showNotification('‚úÖ Configuraci√≥n de impresi√≥n √≥ptima', 'success');
                return true;
            }
            
            // Mostrar issues encontrados
            issues.forEach((issue, index) => {
                setTimeout(() => {
                    showNotification(`${issue.type === 'error' ? '‚ùå' : '‚ö†Ô∏è'} ${issue.message}`, issue.type);
                }, index * 1000);
            });
            
            return issues.filter(issue => issue.type === 'error').length === 0;
        }

        // PASO 3: Sistema inteligente de recomendaciones
        function getFilamentRecommendations() {
            const recommendations = {
                'PLA': {
                    advantages: ['F√°cil de imprimir', 'Biodegradable', 'Sin olores', 'Buena precisi√≥n'],
                    applications: ['Prototipos', 'Figuras decorativas', 'Juguetes', 'Objetos de uso dom√©stico'],
                    tips: ['Ideal para principiantes', 'No requiere cama caliente', 'Buena adherencia']
                },
                'ABS': {
                    advantages: ['Alta resistencia', 'Flexible', 'Resistente al calor', 'Post-procesable'],
                    applications: ['Piezas funcionales', 'Carcasas', 'Herramientas', 'Piezas automotrices'],
                    tips: ['Requiere cama caliente', 'Usar en √°rea ventilada', 'Puede requerir enclosure']
                },
                'PETG': {
                    advantages: ['Transparente', 'Resistente qu√≠mico', 'Sin warping', 'F√°cil de imprimir'],
                    applications: ['Contenedores', 'Piezas transparentes', 'Prototipos funcionales', 'Recipientes alimentarios'],
                    tips: ['Combina lo mejor de PLA y ABS', 'Excelente para piezas claras', 'Buena resistencia qu√≠mica']
                }
            };
            
            return recommendations[printerState.selectedFilament] || null;
        }

        function openLCDInterface() {
            const modal = document.getElementById('lcd-modal');
            if (modal) {
                modal.classList.remove('hidden');
                updateModalElements();
                showNotification('Panel LCD abierto - Control completo disponible', 'info');
            }
        }

        function closeLCDInterface() {
            const modal = document.getElementById('lcd-modal');
            if (modal) {
                modal.classList.add('hidden');
                showNotification('Panel LCD cerrado', 'info');
            }
        }

        // PASO 4: Sistema avanzado de monitoreo y an√°lisis en tiempo real
        let monitoringSystem = {
            active: false,
            sensors: {
                vibration: { value: 0, threshold: 5, status: 'normal' },
                noise: { value: 0, threshold: 60, status: 'normal' },
                powerConsumption: { value: 0, baseline: 150, status: 'normal' },
                layerQuality: { value: 100, threshold: 85, status: 'excellent' }
            },
            alerts: [],
            statistics: {
                totalPrintTime: 0,
                successfulPrints: 0,
                failedPrints: 0,
                filamentUsed: 0,
                averageLayerTime: 0
            }
        };

        // PASO 4: Sistema de detecci√≥n inteligente de problemas
        function intelligentProblemDetection() {
            const problems = [];
            
            // Detecci√≥n de problemas de adhesi√≥n
            if (printerState.printing && currentLayer <= 3) {
                const bedTempDiff = Math.abs(printerState.bedTemp - filamentConfigs[printerState.selectedFilament].bedTemp);
                if (bedTempDiff > 15) {
                    problems.push({
                        type: 'adhesion',
                        severity: 'high',
                        message: 'Posible problema de adhesi√≥n en primera capa',
                        solution: 'Ajustar temperatura de cama',
                        autoFix: () => applyFilamentTemperatures(filamentConfigs[printerState.selectedFilament])
                    });
                }
            }
            
            // Detecci√≥n de problemas de extrusi√≥n
            if (printerState.printing && monitoringSystem.sensors.powerConsumption.value < 100) {
                problems.push({
                    type: 'extrusion',
                    severity: 'medium',
                    message: 'Posible obstrucci√≥n en extrusor',
                    solution: 'Verificar flujo de filamento',
                    autoFix: () => performMaintenanceCheck()
                });
            }
            
            // Detecci√≥n de problemas de vibraci√≥n
            if (monitoringSystem.sensors.vibration.value > monitoringSystem.sensors.vibration.threshold) {
                problems.push({
                    type: 'mechanical',
                    severity: 'medium',
                    message: 'Vibraci√≥n excesiva detectada',
                    solution: 'Verificar tensi√≥n de correas y nivelaci√≥n',
                    autoFix: () => autoCalibrateMechanics()
                });
            }
            
            return problems;
        }

        // PASO 4: Sistema de mantenimiento predictivo
        function predictiveMaintenance() {
            const maintenanceNeeds = [];
            
            // An√°lisis de uso del extrusor
            if (monitoringSystem.statistics.totalPrintTime > 100) { // 100 horas simuladas
                maintenanceNeeds.push({
                    component: 'Extrusor',
                    action: 'Limpieza de boquilla recomendada',
                    urgency: 'low',
                    estimatedTime: '15 minutos'
                });
            }
            
            // An√°lisis de la cama de impresi√≥n
            if (monitoringSystem.statistics.successfulPrints > 50) {
                maintenanceNeeds.push({
                    component: 'Cama de impresi√≥n',
                    action: 'Recalibraci√≥n de nivelaci√≥n',
                    urgency: 'medium',
                    estimatedTime: '10 minutos'
                });
            }
            
            // An√°lisis de correas y mec√°nica
            if (monitoringSystem.sensors.vibration.value > 3) {
                maintenanceNeeds.push({
                    component: 'Sistema mec√°nico',
                    action: 'Tensi√≥n de correas y lubricaci√≥n',
                    urgency: 'high',
                    estimatedTime: '30 minutos'
                });
            }
            
            return maintenanceNeeds;
        }

        // PASO 4: An√°lisis de calidad de impresi√≥n en tiempo real
        function realTimeQualityAnalysis() {
            if (!printerState.printing) return;
            
            const qualityMetrics = {
                layerAdhesion: calculateLayerAdhesion(),
                dimensionalAccuracy: calculateDimensionalAccuracy(),
                surfaceFinish: calculateSurfaceFinish(),
                overallScore: 0
            };
            
            // Calcular puntuaci√≥n general
            qualityMetrics.overallScore = Math.round(
                (qualityMetrics.layerAdhesion + qualityMetrics.dimensionalAccuracy + qualityMetrics.surfaceFinish) / 3
            );
            
            // Actualizar sensor de calidad
            monitoringSystem.sensors.layerQuality.value = qualityMetrics.overallScore;
            monitoringSystem.sensors.layerQuality.status = 
                qualityMetrics.overallScore >= 95 ? 'excellent' :
                qualityMetrics.overallScore >= 85 ? 'good' :
                qualityMetrics.overallScore >= 70 ? 'fair' : 'poor';
            
            return qualityMetrics;
        }

        // PASO 4: Funciones auxiliares de an√°lisis de calidad
        function calculateLayerAdhesion() {
            // Simular an√°lisis basado en temperatura y velocidad
            const tempOptimal = Math.abs(printerState.extruderTemp - filamentConfigs[printerState.selectedFilament].extruderTemp) <= 10;
            const bedTempOptimal = Math.abs(printerState.bedTemp - filamentConfigs[printerState.selectedFilament].bedTemp) <= 5;
            
            let score = 100;
            if (!tempOptimal) score -= 15;
            if (!bedTempOptimal) score -= 10;
            if (monitoringSystem.sensors.vibration.value > 3) score -= 20;
            
            return Math.max(0, score);
        }

        function calculateDimensionalAccuracy() {
            // Simular an√°lisis basado en calibraci√≥n y condiciones
            let score = 100;
            if (!printerState.leveled) score -= 25;
            if (monitoringSystem.sensors.vibration.value > 4) score -= 15;
            if (Math.abs(printerState.extruderTemp - filamentConfigs[printerState.selectedFilament].extruderTemp) > 20) score -= 20;
            
            return Math.max(0, score);
        }

        function calculateSurfaceFinish() {
            // Simular an√°lisis basado en configuraci√≥n y ambiente
            let score = 100;
            if (monitoringSystem.sensors.vibration.value > 2) score -= 10;
            if (monitoringSystem.sensors.noise.value > 50) score -= 5;
            
            // Bonus por configuraci√≥n √≥ptima
            const tempDiff = Math.abs(printerState.extruderTemp - filamentConfigs[printerState.selectedFilament].extruderTemp);
            if (tempDiff <= 5) score += 5;
            
            return Math.max(0, Math.min(100, score));
        }

        // PASO 4: Sistema de optimizaci√≥n autom√°tica
        function autoOptimizePrintSettings() {
            if (!printerState.printing) {
                showNotification('‚ö†Ô∏è Inicia una impresi√≥n para optimizar configuraciones', 'warning');
                return;
            }
            
            showNotification('üîß Analizando configuraci√≥n actual...', 'info');
            
            setTimeout(() => {
                const qualityMetrics = realTimeQualityAnalysis();
                const optimizations = [];
                
                // Optimizaci√≥n de temperatura
                if (qualityMetrics.layerAdhesion < 90) {
                    const optimalTemp = filamentConfigs[printerState.selectedFilament].extruderTemp;
                    if (Math.abs(printerState.extruderTemp - optimalTemp) > 5) {
                        printerState.extruderTemp = optimalTemp;
                        optimizations.push(`Temperatura extrusor ajustada a ${optimalTemp}¬∞C`);
                    }
                }
                
                // Optimizaci√≥n de cama
                if (qualityMetrics.dimensionalAccuracy < 90) {
                    const optimalBedTemp = filamentConfigs[printerState.selectedFilament].bedTemp;
                    if (Math.abs(printerState.bedTemp - optimalBedTemp) > 5) {
                        printerState.bedTemp = optimalBedTemp;
                        optimizations.push(`Temperatura cama ajustada a ${optimalBedTemp}¬∞C`);
                    }
                }
                
                // Aplicar optimizaciones
                if (optimizations.length > 0) {
                    syncAllTemperatureControls();
                    updateHeatIndicators();
                    updateLCDDisplay();
                    
                    showNotification(`‚úÖ Optimizaciones aplicadas: ${optimizations.join(', ')}`, 'success');
                } else {
                    showNotification('‚úÖ Configuraci√≥n ya est√° optimizada', 'success');
                }
                
            }, 2000);
        }

        // PASO 4: Sistema de calibraci√≥n autom√°tica avanzada
        function autoCalibrateMechanics() {
            if (!printerState.powered) {
                showNotification('‚ö†Ô∏è Enciende la impresora primero', 'warning');
                return;
            }
            
            showNotification('üîß Iniciando calibraci√≥n mec√°nica avanzada...', 'info');
            
            // Secuencia de calibraci√≥n realista
            const calibrationSteps = [
                { name: 'Verificando tensi√≥n de correas', duration: 2000 },
                { name: 'Calibrando pasos del motor', duration: 3000 },
                { name: 'Ajustando backlash', duration: 2500 },
                { name: 'Verificando perpendicularidad', duration: 2000 },
                { name: 'Optimizando aceleraci√≥n', duration: 1500 }
            ];
            
            let currentStep = 0;
            
            function executeCalibrationStep() {
                if (currentStep < calibrationSteps.length) {
                    const step = calibrationSteps[currentStep];
                    showNotification(`üîß ${step.name}...`, 'info');
                    
                    // Simular movimiento del extrusor durante calibraci√≥n
                    simulateCalibrationMovement(currentStep);
                    
                    setTimeout(() => {
                        currentStep++;
                        executeCalibrationStep();
                    }, step.duration);
                } else {
                    // Calibraci√≥n completada
                    monitoringSystem.sensors.vibration.value = Math.max(0, monitoringSystem.sensors.vibration.value - 2);
                    monitoringSystem.sensors.vibration.status = 'normal';
                    
                    showNotification('‚úÖ Calibraci√≥n mec√°nica completada - Precisi√≥n mejorada', 'success');
                    updateMonitoringDisplay();
                }
            }
            
            executeCalibrationStep();
        }

        // PASO 4: Simular movimiento durante calibraci√≥n
        function simulateCalibrationMovement(stepIndex) {
            const movements = [
                { x: 50, y: 50, z: 10 },   // Verificaci√≥n de correas
                { x: 100, y: 100, z: 20 }, // Calibraci√≥n de pasos
                { x: 150, y: 50, z: 15 },  // Ajuste de backlash
                { x: 75, y: 150, z: 25 },  // Verificaci√≥n perpendicularidad
                { x: 100, y: 100, z: 30 }  // Optimizaci√≥n aceleraci√≥n
            ];
            
            const targetPos = movements[stepIndex];
            
            // Animar movimiento gradual
            const startPos = { ...printerState.position };
            const steps = 20;
            let currentStepMove = 0;
            
            const moveInterval = setInterval(() => {
                if (currentStepMove < steps) {
                    const progress = currentStepMove / steps;
                    
                    printerState.position.x = Math.round(startPos.x + (targetPos.x - startPos.x) * progress);
                    printerState.position.y = Math.round(startPos.y + (targetPos.y - startPos.y) * progress);
                    printerState.position.z = Math.round(startPos.z + (targetPos.z - startPos.z) * progress);
                    
                    updateAllPositionDisplays();
                    updateExtruderPosition();
                    
                    currentStepMove++;
                } else {
                    clearInterval(moveInterval);
                }
            }, 100);
        }

        // PASO 4: Sistema de monitoreo de sensores en tiempo real
        function startSensorMonitoring() {
            if (monitoringSystem.active) return;
            
            monitoringSystem.active = true;
            
            const monitoringInterval = setInterval(() => {
                if (!monitoringSystem.active) {
                    clearInterval(monitoringInterval);
                    return;
                }
                
                // Simular lecturas de sensores realistas
                updateSensorReadings();
                
                // An√°lisis de problemas en tiempo real
                const problems = intelligentProblemDetection();
                if (problems.length > 0) {
                    handleDetectedProblems(problems);
                }
                
                // An√°lisis de calidad si est√° imprimiendo
                if (printerState.printing && !printerState.paused) {
                    realTimeQualityAnalysis();
                }
                
                // Actualizar displays de monitoreo
                updateMonitoringDisplay();
                
            }, 2000); // Actualizar cada 2 segundos
        }

        // PASO 4: Actualizar lecturas de sensores
        function updateSensorReadings() {
            // Vibraci√≥n - afectada por velocidad de impresi√≥n y estado mec√°nico
            if (printerState.printing && !printerState.paused) {
                monitoringSystem.sensors.vibration.value = Math.random() * 3 + (printerState.leveled ? 0 : 2);
            } else {
                monitoringSystem.sensors.vibration.value = Math.random() * 0.5;
            }
            
            // Ruido - correlacionado con vibraci√≥n y ventiladores
            const fanNoise = printerState.powered ? 25 : 0;
            const printNoise = (printerState.printing && !printerState.paused) ? 20 : 0;
            monitoringSystem.sensors.noise.value = fanNoise + printNoise + (Math.random() * 10);
            
            // Consumo de energ√≠a - basado en componentes activos
            let powerConsumption = 0;
            if (printerState.powered) powerConsumption += 50; // Base
            if (printerState.extruderTemp > 100) powerConsumption += printerState.extruderTemp * 0.8;
            if (printerState.bedTemp > 40) powerConsumption += printerState.bedTemp * 1.2;
            if (printerState.printing && !printerState.paused) powerConsumption += 30;
            
            monitoringSystem.sensors.powerConsumption.value = powerConsumption + (Math.random() * 20 - 10);
            
            // Actualizar estados de sensores
            updateSensorStatuses();
        }

        // PASO 4: Actualizar estados de sensores
        function updateSensorStatuses() {
            // Estado de vibraci√≥n
            if (monitoringSystem.sensors.vibration.value > monitoringSystem.sensors.vibration.threshold) {
                monitoringSystem.sensors.vibration.status = 'warning';
            } else if (monitoringSystem.sensors.vibration.value > monitoringSystem.sensors.vibration.threshold * 0.7) {
                monitoringSystem.sensors.vibration.status = 'caution';
            } else {
                monitoringSystem.sensors.vibration.status = 'normal';
            }
            
            // Estado de ruido
            if (monitoringSystem.sensors.noise.value > monitoringSystem.sensors.noise.threshold) {
                monitoringSystem.sensors.noise.status = 'warning';
            } else if (monitoringSystem.sensors.noise.value > monitoringSystem.sensors.noise.threshold * 0.8) {
                monitoringSystem.sensors.noise.status = 'caution';
            } else {
                monitoringSystem.sensors.noise.status = 'normal';
            }
            
            // Estado de consumo de energ√≠a
            const powerDiff = Math.abs(monitoringSystem.sensors.powerConsumption.value - monitoringSystem.sensors.powerConsumption.baseline);
            if (powerDiff > 50) {
                monitoringSystem.sensors.powerConsumption.status = 'warning';
            } else if (powerDiff > 25) {
                monitoringSystem.sensors.powerConsumption.status = 'caution';
            } else {
                monitoringSystem.sensors.powerConsumption.status = 'normal';
            }
        }

        // PASO 4: Manejar problemas detectados
        function handleDetectedProblems(problems) {
            problems.forEach(problem => {
                // Agregar a lista de alertas si no existe
                const existingAlert = monitoringSystem.alerts.find(alert => alert.type === problem.type);
                if (!existingAlert) {
                    monitoringSystem.alerts.push({
                        ...problem,
                        timestamp: Date.now(),
                        resolved: false
                    });
                    
                    // Mostrar notificaci√≥n
                    const icon = problem.severity === 'high' ? 'üö®' : problem.severity === 'medium' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                    showNotification(`${icon} ${problem.message}`, problem.severity === 'high' ? 'error' : 'warning');
                }
            });
        }

        // PASO 4: Actualizar display de monitoreo
        function updateMonitoringDisplay() {
            // Esta funci√≥n se implementar√° cuando se agregue la interfaz de monitoreo
            console.log('Monitoring Update:', {
                sensors: monitoringSystem.sensors,
                alerts: monitoringSystem.alerts.filter(alert => !alert.resolved),
                statistics: monitoringSystem.statistics
            });
        }

        // PASO 4: Realizar verificaci√≥n de mantenimiento
        function performMaintenanceCheck() {
            showNotification('üîß Ejecutando verificaci√≥n de mantenimiento...', 'info');
            
            setTimeout(() => {
                const maintenanceNeeds = predictiveMaintenance();
                
                if (maintenanceNeeds.length === 0) {
                    showNotification('‚úÖ Sistema en √≥ptimas condiciones', 'success');
                } else {
                    maintenanceNeeds.forEach((need, index) => {
                        setTimeout(() => {
                            const urgencyIcon = need.urgency === 'high' ? 'üö®' : need.urgency === 'medium' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                            showNotification(`${urgencyIcon} ${need.component}: ${need.action}`, 
                                need.urgency === 'high' ? 'error' : 'warning');
                        }, index * 1000);
                    });
                }
            }, 2000);
        }

        // PASO 4: Generar reporte de impresi√≥n
        function generatePrintReport() {
            if (!printerState.printCompleted && !printerState.printing) {
                showNotification('‚ÑπÔ∏è No hay datos de impresi√≥n para generar reporte', 'info');
                return;
            }
            
            const report = {
                timestamp: new Date().toLocaleString(),
                filament: printerState.selectedFilament,
                duration: printerState.printing ? 'En progreso' : '30 minutos (simulado)',
                layers: `${currentLayer}/${totalLayers}`,
                quality: realTimeQualityAnalysis(),
                issues: monitoringSystem.alerts.filter(alert => !alert.resolved),
                powerConsumption: Math.round(monitoringSystem.sensors.powerConsumption.value),
                recommendations: generateRecommendations()
            };
            
            showPrintReportModal(report);
        }

        // PASO 4: Generar recomendaciones basadas en an√°lisis
        function generateRecommendations() {
            const recommendations = [];
            
            // Recomendaciones basadas en calidad
            const quality = realTimeQualityAnalysis();
            if (quality.layerAdhesion < 85) {
                recommendations.push('Verificar nivelaci√≥n de cama y temperatura');
            }
            if (quality.dimensionalAccuracy < 85) {
                recommendations.push('Calibrar pasos del motor y verificar tensi√≥n de correas');
            }
            if (quality.surfaceFinish < 85) {
                recommendations.push('Reducir vibraci√≥n y optimizar velocidad de impresi√≥n');
            }
            
            // Recomendaciones basadas en sensores
            if (monitoringSystem.sensors.vibration.status !== 'normal') {
                recommendations.push('Verificar estabilidad mec√°nica y superficie de apoyo');
            }
            if (monitoringSystem.sensors.powerConsumption.status !== 'normal') {
                recommendations.push('Revisar configuraci√≥n de temperaturas y eficiencia energ√©tica');
            }
            
            return recommendations.length > 0 ? recommendations : ['Sistema funcionando √≥ptimamente'];
        }

        // PASO 4: Mostrar modal de reporte (placeholder)
        function showPrintReportModal(report) {
            // Por ahora mostrar en notificaciones, se implementar√° modal completo despu√©s
            showNotification('üìä Reporte generado - Calidad general: ' + 
                (report.quality.overallScore >= 90 ? 'Excelente' : 
                 report.quality.overallScore >= 80 ? 'Buena' : 'Regular'), 'success');
            
            setTimeout(() => {
                showNotification(`üí° Recomendaci√≥n: ${report.recommendations[0]}`, 'info');
            }, 2000);
        }

        // Initialize simulator
        document.addEventListener('DOMContentLoaded', function() {
            setMode('guided');
            updateSimulatorStep();
            
            // PASO 2: Inicializar sistema de filamento
            initializeFilamentSystem();
            
            // Inicializaci√≥n completa del sistema de temperatura
            syncAllTemperatureControls();
            updateHeatIndicators();
            updateLCDDisplay();
            
            // Sincronizar todos los elementos de la interfaz
            syncAllLEDs();
            syncPrintStatus();
            updateAllButtonStates();
            
            // PASO 4: Inicializar sistema de monitoreo
            startSensorMonitoring();
            
            // Close modal when clicking outside
            const modal = document.getElementById('lcd-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeLCDInterface();
                    }
                });
            }
            
            // PASO 2: Close filament modal when clicking outside
            const filamentModal = document.getElementById('filament-modal');
            if (filamentModal) {
                filamentModal.addEventListener('click', function(e) {
                    if (e.target === filamentModal) {
                        closeFilamentModal();
                    }
                });
            }
            
            showNotification('üñ®Ô∏è Simulador inicializado - Sistema de monitoreo inteligente activo', 'success');
        });
        
        // PASO 2: Funci√≥n para inicializar sistema de filamento
        function initializeFilamentSystem() {
            // Configurar filamento por defecto (PLA)
            selectedFilament = { ...filamentConfigs.PLA };
            printerState.selectedFilament = 'PLA';
            
            // Actualizar visualizaci√≥n inicial
            updateFilamentModalDisplay();
            updateSpoolVisual(selectedFilament);
            
            console.log('Sistema de filamento inicializado:', {
                selectedFilament: selectedFilament,
                availableTypes: Object.keys(filamentConfigs)
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98bb51f3f6d22e60',t:'MTc1OTk4NjA4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
